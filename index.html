<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">  
  <title>Sistema de Tests</title>  
  <meta name="viewport" content="width=device-width,initial-scale=1">  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

  <!-- Stripe SDK -->
  <script src="https://js.stripe.com/v3/"></script>

  <script>
    // Configuraci√≥n Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCQ5u2bs7kv7KNsS7HQ_T2HYNNnhI-KbG4",
      authDomain: "multitest-gobcan.firebaseapp.com",
      projectId: "multitest-gobcan",
      storageBucket: "multitest-gobcan.firebasestorage.app",
      messagingSenderId: "1039579449781",
      appId: "1:1039579449781:web:f0709e9515a19184a3f1fc",
      measurementId: "G-D3PN7H340S"
    };

   firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const analytics = firebase.analytics();

// ‚úÖ M√âTODO ALTERNATIVO para especificar regi√≥n
const functions = firebase.app().functions('europe-west6');

const IS_DEVELOPMENT = false;
console.log('üî• Firebase configurado correctamente');
    // ==================== CONFIGURACI√ìN DESARROLLO ====================
  </script>
    <style>
    /* ==================== VARIABLES CSS - MODO OSCURO ==================== */
    :root {
      --bg: #0f1113;
      --card: #1f2225;
      --card-2: #26292d;
      --muted: #aab3b8;
      --text: #e9eef2;
      --accent: #34c3ff;
      --success: #2e8b57;
      --danger: #b22222;
      --shadow: rgba(0,0,0,0.4);
      --border: rgba(255,255,255,0.05);
      --border-hover: rgba(255,255,255,0.1);
      --accent-bg: rgba(52, 195, 255, 0.1);
      --accent-border: rgba(52, 195, 255, 0.2);
      --success-bg: rgba(46, 139, 87, 0.1);
      --success-border: rgba(46, 139, 87, 0.3);
      --danger-bg: rgba(178, 34, 34, 0.1);
      --danger-border: rgba(178, 34, 34, 0.3);
      --opcion-bg-hover: rgba(52, 195, 255, 0.05);
      --input-bg: rgba(255,255,255,0.05);
      --input-bg-focus: rgba(255,255,255,0.08);
    }

    /* ==================== VARIABLES CSS - MODO CLARO ==================== */
    [data-theme="light"] {
      --bg: #f5f7fa;
      --card: #ffffff;
      --card-2: #f8f9fb;
      --muted: #6b7280;
      --text: #1f2937;
      --accent: #0ea5e9;
      --success: #10b981;
      --danger: #ef4444;
      --shadow: rgba(0,0,0,0.1);
      --border: rgba(0,0,0,0.08);
      --border-hover: rgba(0,0,0,0.15);
      --accent-bg: rgba(14, 165, 233, 0.1);
      --accent-border: rgba(14, 165, 233, 0.3);
      --success-bg: rgba(16, 185, 129, 0.1);
      --success-border: rgba(16, 185, 129, 0.3);
      --danger-bg: rgba(239, 68, 68, 0.1);
      --danger-border: rgba(239, 68, 68, 0.3);
      --opcion-bg-hover: rgba(14, 165, 233, 0.05);
      --input-bg: rgba(0,0,0,0.03);
      --input-bg-focus: rgba(0,0,0,0.05);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      font-family: 'Segoe UI', Roboto, Arial, sans-serif;
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 12px; /* Reducido de 20px */
      transition: background 0.3s ease, color 0.3s ease;
    }

    /* ==================== TOGGLES CONTAINER ==================== */
    .toggles-container {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 12px;
      padding: 16px 12px; /* Reducido lateral de 20px a 12px */
      max-width: 900px;
      margin: 0 auto 8px auto;
    }

    .toggle-wrapper {
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 50px;
      padding: 8px;
      cursor: pointer;
      display: flex;
      gap: 4px;
      box-shadow: 0 4px 12px var(--shadow);
      transition: all 0.3s ease;
    }

    .toggle-wrapper:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px var(--shadow);
      border-color: var(--accent);
    }

    /* THEME TOGGLE */
    .theme-option {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      user-select: none;
    }

    .theme-option.active {
      background: var(--accent);
      border-color: var(--accent);
      transform: scale(1.1);
    }

    .theme-option:not(.active):hover {
      background: var(--card-2);
      transform: scale(1.05);
    }

    /* STATS TOGGLE */
    .stats-switch {
      position: relative;
      width: 88px;
      height: 40px;
      background: var(--card-2);
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid var(--border-hover);
    }

    .stats-switch:hover {
      border-color: var(--accent);
    }

    .stats-switch-slider {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 32px;
      height: 32px;
      background: var(--muted);
      border-radius: 50%;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .stats-switch.active {
      background: var(--accent);
      border-color: var(--accent);
    }

    .stats-switch.active .stats-switch-slider {
      left: calc(100% - 35px);
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .stats-switch::before,
    .stats-switch::after {
      content: '';
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      font-size: 14px;
      font-weight: 700;
      transition: opacity 0.3s ease;
    }

    .stats-switch::before {
      content: '1';
      right: 10px;
      color: white;
      opacity: 0;
    }

    .stats-switch::after {
      content: '0';
      left: 10px;
      color: var(--muted);
      opacity: 1;
    }

    .stats-switch.active::before {
      opacity: 1;
    }

    .stats-switch.active::after {
      opacity: 0;
    }

    .container {
      max-width: 900px;
      width: 100%;
      padding-bottom: 20px;
    }

    .screen {
      display: none;
    }

    .screen.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 32px 24px; /* Reducido lateral de 40px a 24px */
      box-shadow: 0 8px 32px var(--shadow);
      border: 1px solid var(--border);
      transition: all 0.3s ease;
    }

    .logo {
      text-align: center;
      margin-bottom: 30px;
    }

    .logo h1 {
      font-size: 36px;
      color: var(--accent);
      margin-bottom: 10px;
      transition: color 0.3s ease;
    }

    .logo p {
      color: var(--muted);
      font-size: 16px;
      transition: color 0.3s ease;
    }

    .btn {
      width: 100%;
      padding: 16px 24px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .btn-primary {
      background: var(--accent);
      color: #ffffff;
    }

    [data-theme="dark"] .btn-primary {
      color: #02131a;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px var(--accent-bg);
      filter: brightness(1.1);
    }

    .btn-primary:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      transform: translateY(-2px);
      filter: brightness(1.1);
    }

    .btn-success:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: transparent;
      border: 2px solid var(--border-hover);
      color: var(--muted);
      transition: all 0.3s ease;
    }

    .btn-secondary:hover {
      background: var(--card-2);
      border-color: var(--accent);
      color: var(--accent);
    }

    .categoria-grid {
      display: grid;
      gap: 16px;
      margin-top: 20px;
    }

    .categoria-card {
      background: var(--card-2);
      padding: 24px;
      border-radius: 12px;
      border: 2px solid var(--border);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .categoria-card:hover {
      border-color: var(--accent);
      background: var(--opcion-bg-hover);
      transform: translateX(5px);
    }

    .categoria-card h3 {
      color: var(--accent);
      margin-bottom: 8px;
      font-size: 20px;
      transition: color 0.3s ease;
    }

    .categoria-card p {
      color: var(--muted);
      font-size: 14px;
      transition: color 0.3s ease;
    }

    .categoria-card .info {
      display: flex;
      gap: 20px;
      margin-top: 12px;
      font-size: 13px;
    }

    .categoria-card .info span {
      color: var(--muted);
      transition: color 0.3s ease;
    }
/* ==================== USER INFO CONTAINER - MEJORADO ==================== */
/* ==================== USER INFO CONTAINER - TEXTO SIN SUPERPOSICI√ìN ==================== */
.user-info {
  background: var(--accent-bg);
  padding: 16px 90px 16px 20px; /* Padding derecho aumentado significativamente */
  border-radius: 10px;
  margin-bottom: 24px;
  border: 1px solid var(--accent-border);
  transition: all 0.3s ease;
  position: relative;
  min-height: 60px;
  display: flex;
  align-items: center;
}

.user-info .user-content {
  display: flex;
  flex-direction: column;
  gap: 4px;
  width: 100%;
  min-width: 0;
  max-width: calc(100% - 80px); /* Limitar el ancho para evitar superposici√≥n */
}

.user-info .user-label {
  color: var(--muted);
  font-size: 12px;
  font-weight: 500;
}

.user-info .email {
  color: var(--accent);
  font-weight: 600;
  font-size: 14px;
  transition: color 0.3s ease;
  word-break: break-word;
  line-height: 1.3;
  cursor: default;
  overflow-wrap: break-word;
  hyphens: auto;
}

/* BOT√ìN SALIR - ESQUINA SUPERIOR DERECHA */
.user-info .logout {
  position: absolute;
  top: 12px;
  right: 12px;
  background: transparent;
  border: 1px solid var(--border-hover);
  color: var(--muted);
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 500;
  transition: all 0.2s ease;
  white-space: nowrap;
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 50px;
  height: 28px;
  z-index: 10; /* Asegurar que est√© por encima del texto */
}

.user-info .logout:hover {
  background: var(--card-2);
  border-color: var(--danger);
  color: var(--danger);
  transform: translateY(-1px);
}

/* ==================== RESPONSIVE ==================== */
@media (max-width: 768px) {
  .user-info {
    padding: 14px 75px 14px 16px;
  }
  
  .user-info .user-content {
    max-width: calc(100% - 65px);
  }
  
  .user-info .logout {
    top: 10px;
    right: 10px;
    padding: 5px 10px;
    font-size: 11px;
    min-width: 45px;
    height: 26px;
  }
}

@media (max-width: 480px) {
  .user-info {
    padding: 12px 70px 12px 14px;
  }
  
  .user-info .user-content {
    max-width: calc(100% - 60px);
  }
  
  .user-info .logout {
    top: 8px;
    right: 8px;
    padding: 4px 8px;
    font-size: 10px;
    min-width: 40px;
    height: 24px;
  }
}
/* ==================== FIN ESTILOS ESPEC√çFICOS ==================== */


    .pregunta-container {
      margin-bottom: 30px;
    }

    .pregunta-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--border);
      transition: border-color 0.3s ease;
    }

    .pregunta-numero {
      font-size: 14px;
      color: var(--muted);
      font-weight: 600;
      transition: color 0.3s ease;
    }

    .pregunta-texto {
      font-size: 20px;
      color: var(--text);
      margin-bottom: 24px;
      line-height: 1.6;
      transition: color 0.3s ease;
    }

    .opciones {
      display: grid;
      gap: 12px;
      margin-bottom: 0; /* Reducido porque el bot√≥n IA est√° separado */
    }

    .opcion {
      background: var(--card-2);
      padding: 16px 20px;
      border-radius: 10px;
      border: 2px solid var(--border);
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .opcion:hover {
      border-color: var(--accent);
      background: var(--opcion-bg-hover);
    }

    .opcion.selected {
      border-color: var(--accent);
      background: var(--accent-bg);
    }

    .opcion.correcta {
      border-color: var(--success);
      background: var(--success-bg);
    }

    .opcion.incorrecta {
      border-color: var(--danger);
      background: var(--danger-bg);
    }

    .opcion-letra {
      width: 32px;
      height: 32px;
      background: var(--card);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: var(--accent);
      flex-shrink: 0;
      transition: all 0.3s ease;
    }

    .opcion.selected .opcion-letra {
      background: var(--accent);
      color: white;
    }

    .opcion.correcta .opcion-letra {
      background: var(--success);
      color: white;
    }

    .opcion.incorrecta .opcion-letra {
      background: var(--danger);
      color: white;
    }

    .opcion-texto {
      flex: 1;
      color: var(--text);
      transition: color 0.3s ease;
    }

/* ===== NAVEGACI√ìN DE PREGUNTAS - SISTEMA UNIFICADO ===== */
.botones-navegacion {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  margin-top: 24px;
  gap: 12px;
}

.btn-icon-nav {
  width: 56px;
  height: 48px;
  font-size: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--card-2);
  border: 2px solid var(--border-hover);
  border-radius: 10px;
  color: var(--text);
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-icon-nav:hover {
  border-color: var(--accent);
  background: var(--opcion-bg-hover);
  transform: translateY(-2px);
}

.btn-icon-nav:disabled {
  opacity: 0.4;
  cursor: not-allowed;
  transform: none;
}

.botones-derecha {
  display: flex;
  gap: 12px;
  align-items: center;
}

.botones-derecha .btn {
  min-width: 140px;
  padding: 12px 18px;
  min-height: 48px;
  border-radius: 12px;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

/* Bot√≥n Siguiente - Azul */
#btnSiguiente {
  background: var(--accent);
  color: white;
  border: none;
  box-shadow: 0 8px 22px rgba(52, 195, 255, 0.08);
}

/* Bot√≥n Finalizar - Verde */
#btnFinalizar {
  background: var(--success);
  color: white;
  border: none;
  box-shadow: 0 8px 22px rgba(46, 139, 87, 0.08);
}

/* Hover effects */
#btnSiguiente:hover:not(:disabled),
#btnFinalizar:hover:not(:disabled) {
  transform: translateY(-2px);
  filter: brightness(1.1);
  box-shadow: 0 10px 25px rgba(52, 195, 255, 0.15);
}

#btnFinalizar:hover:not(:disabled) {
  box-shadow: 0 10px 25px rgba(46, 139, 87, 0.15);
}

/* Estados deshabilitados */
#btnSiguiente:disabled,
#btnFinalizar:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

/* ==================== RESPONSIVE MEJORADO ==================== */
@media (max-width: 768px) {
  .botones-navegacion {
    margin-top: 16px;
    gap: 8px;
  }
  
  .btn-icon-nav {
    width: 44px;
    height: 44px;
    font-size: 18px;
  }
  
  .botones-derecha {
    gap: 8px;
  }
  
  .botones-derecha .btn {
    min-width: 100px;  /* Reducido para m√≥vil */
    padding: 10px 12px; /* M√°s compacto */
    min-height: 44px;
    font-size: 14px;
  }
  
  /* Espec√≠fico para botones Siguiente/Finalizar en tablet */
  #btnSiguiente, #btnFinalizar {
    min-width: 100px;
    padding: 10px 12px;
    font-size: 14px;
  }
}

@media (max-width: 480px) {
  /* EN M√ìVILES PEQUE√ëOS: mantener en fila pero m√°s compacto */
  .botones-navegacion {
    flex-direction: row; /* ‚Üê MANTENER EN FILA, NO COLUMNA */
    align-items: center;
    gap: 6px;
  }
  
  .btn-icon-nav {
    width: 40px;
    height: 40px;
    font-size: 16px;
  }
  
  .botones-derecha {
    gap: 6px;
  }
  
  .botones-derecha .btn {
    min-width: 80px;  /* M√°s estrecho para m√≥viles peque√±os */
    padding: 8px 10px;
    min-height: 40px;
    font-size: 12px;
  }
  
  /* Espec√≠fico para botones Siguiente/Finalizar en m√≥vil peque√±o */
  #btnSiguiente, #btnFinalizar {
    min-width: 80px;
    padding: 8px 10px;
    font-size: 12px;
    min-height: 40px;
  }
}

/* Para pantallas MUY peque√±as (menos de 360px) */
@media (max-width: 360px) {
  .botones-derecha .btn {
    min-width: 70px;
    padding: 6px 8px;
    font-size: 11px;
  }
  
  #btnSiguiente, #btnFinalizar {
    min-width: 70px;
    padding: 6px 8px;
    font-size: 11px;
  }
}

    /* BOTONES DE TANDA - INLINE COMPACTOS */
    #tandaOptions {
      display: flex;
      gap: 8px;
      margin-top: 20px; /* Aumentado para dar espacio despu√©s del bot√≥n IA */
    }

    #tandaOptions .btn {
      flex: 1;
      padding: 10px 12px;
      font-size: 13px;
      white-space: nowrap;
    }

    /* BOT√ìN EXPLICAR CON IA */
    #btnExplicarIA {
      width: 100%;
      margin-top: 16px;
      background: transparent;
      border: 2px solid var(--border-hover);
      color: var(--text);
      transition: all 0.3s ease;
    }

    #btnExplicarIA:hover {
      background: var(--card-2);
      border-color: var(--accent);
      color: var(--accent);
      transform: translateY(-1px);
    }

    .progress-bar {
      background: var(--card-2);
      height: 8px;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 24px;
      transition: background 0.3s ease;
    }

    .progress-fill {
      background: linear-gradient(90deg, var(--accent), var(--accent));
      height: 100%;
      transition: width 0.3s ease;
      filter: brightness(1.2);
    }

    .resultado-card {
      text-align: center;
      padding: 32px 20px; /* Reducido lateral de 40px a 20px */
    }

    .resultado-score {
      font-size: 72px;
      font-weight: 700;
      color: var(--accent);
      margin: 20px 0;
      transition: color 0.3s ease;
    }

    .resultado-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      margin: 30px 0;
    }

    .stat-item {
      background: var(--card-2);
      padding: 20px;
      border-radius: 10px;
      border: 1px solid var(--border);
      transition: all 0.3s ease;
    }

    .stat-item .label {
      color: var(--muted);
      font-size: 14px;
      margin-bottom: 8px;
      transition: color 0.3s ease;
    }

    .stat-item .value {
      font-size: 28px;
      font-weight: 700;
      color: var(--accent);
      transition: color 0.3s ease;
    }

    .stats-toggle {
      background: var(--card-2);
      border: 1px solid var(--border-hover);
      border-radius: 10px;
      margin-top: 24px;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .stats-toggle-header {
      padding: 16px 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.2s ease;
    }

    .stats-toggle-header:hover {
      background: var(--opcion-bg-hover);
    }

    .stats-toggle-title {
      color: var(--accent);
      font-weight: 600;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: color 0.3s ease;
    }

    .stats-toggle-icon {
      transition: transform 0.3s ease, color 0.3s ease;
      color: var(--muted);
      font-size: 18px;
    }

    .stats-toggle-icon.open {
      transform: rotate(180deg);
    }

    .stats-toggle-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease;
    }

    .stats-toggle-content.open {
      max-height: 1500px;
    }

    .stats-toggle-body {
      padding: 20px;
      border-top: 1px solid var(--border);
      transition: border-color 0.3s ease;
    }

    .stats-section {
      margin-bottom: 24px;
    }

    .stats-section:last-child {
      margin-bottom: 0;
    }

    .stats-section-title {
      color: var(--accent);
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: color 0.3s ease;
    }

    .stats-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
      transition: border-color 0.3s ease;
    }

    .stats-row:last-child {
      border-bottom: none;
    }

    .stats-label {
      color: var(--muted);
      font-size: 14px;
      transition: color 0.3s ease;
    }

    .stats-value {
      color: var(--accent);
      font-weight: 600;
      font-size: 16px;
      transition: color 0.3s ease;
    }

    .stats-value.success {
      color: var(--success);
    }

    .stats-value.danger {
      color: var(--danger);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .stats-mini-card {
      background: var(--card);
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      border: 1px solid var(--border);
      transition: all 0.3s ease;
    }

    .stats-mini-card .mini-label {
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 6px;
      transition: color 0.3s ease;
    }

    .stats-mini-card .mini-value {
      color: var(--accent);
      font-size: 20px;
      font-weight: 700;
      transition: color 0.3s ease;
    }

    .progress-bar-mini {
      background: var(--card-2);
      height: 6px;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 8px;
      transition: background 0.3s ease;
    }

    .progress-bar-mini .fill {
      height: 100%;
      background: linear-gradient(90deg, var(--success), var(--accent));
      transition: width 0.3s ease;
    }

    .alert {
      padding: 16px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: all 0.3s ease;
    }

    .alert-danger {
      background: var(--danger-bg);
      border: 1px solid var(--danger-border);
      color: var(--danger);
    }

    .alert-info {
      background: var(--accent-bg);
      border: 1px solid var(--accent-border);
      color: var(--accent);
    }

    .alert-success {
      background: var(--success-bg);
      border: 1px solid var(--success-border);
      color: var(--success);
    }

    .loading {
      text-align: center;
      padding: 40px;
    }

    .spinner {
      border: 4px solid var(--card-2);
      border-top: 4px solid var(--accent);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
      transition: border-color 0.3s ease;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .chatgpt-btn {
      background: linear-gradient(135deg, #10a37f 0%, #0d8a6a 100%);
      color: white;
      margin-top: 16px;
    }

    .chatgpt-btn:hover {
      background: linear-gradient(135deg, #0d8a6a 0%, #0a6f55 100%);
    }
/* Preselecci√≥n visual futurista para bot√≥n de IA (aplica solo mientras se muestra nueva pregunta) */  
.chatgpt-btn.preselected {  
  outline: 2px solid var(--accent);  
  box-shadow: 0 6px 18px rgba(52,195,255,0.14);  
  position: relative;  
}  
.chatgpt-btn.preselected::after {  
  content: 'ü§ñ';  
  margin-left: 8px;  
}

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
      transition: all 0.3s ease;
    }

    .badge-success {
      background: var(--success-bg);
      color: var(--success);
    }

    .badge-warning {
      background: rgba(255, 193, 7, 0.2);
      color: #ffc107;
    }

    .badge-danger {
      background: var(--danger-bg);
      color: var(--danger);
    }

    .login-divider {
      margin: 20px 0;
      text-align: center;
      color: var(--muted);
      font-size: 14px;
      position: relative;
      transition: color 0.3s ease;
    }

    .login-divider::before {
      content: "";
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 1px;
      background: var(--border-hover);
      transition: background 0.3s ease;
    }

    .login-divider span {
      background: var(--card);
      padding: 0 15px;
      position: relative;
      transition: background 0.3s ease;
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid var(--border-hover);
      background: var(--input-bg);
      color: var(--text);
      font-size: 14px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent);
      background: var(--input-bg-focus);
    }

    .small-text {
      font-size: 12px;
      color: var(--muted);
      text-align: center;
      margin-top: 8px;
      transition: color 0.3s ease;
    }

    .error-message {
      background: var(--danger-bg);
      border: 1px solid var(--danger-border);
      color: var(--danger);
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
      display: none;
      transition: all 0.3s ease;
    }

    .error-message.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    /* ==================== STATS EN TIEMPO REAL ==================== */
    #statsRealTime {
      background: var(--card-2);
      padding: 16px;
      border-radius: 10px;
      margin-bottom: 20px;
      border: 1px solid var(--border-hover);
      display: grid;
      grid-template-columns: repeat(3, 1fr); /* 3 columnas para Aciertos, Fallos, Restantes */
      gap: 12px;
      transition: all 0.3s ease;
    }

    #statsRealTime.hidden {
      display: none;
    }

    /* ==================== RESPONSIVE - OPTIMIZADO ==================== */
    @media (max-width: 768px) {
      body {
        padding: 0; /* Sin padding en m√≥vil para aprovechar todo el espacio */
      }

      .container {
        padding: 0 8px 12px 8px; /* Reducido lateral de 12px a 8px */
      }

      /* TOGGLES REDUCIDOS 30% */
      /* ==================== TOGGLES CONTAINER - TAMA√ëO OPTIMIZADO ==================== */
.toggles-container {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 10px; /* Reducido de 12px */
  padding: 12px; /* Reducido de 16px 12px */
  max-width: 900px;
  margin: 0 auto 6px auto; /* Reducido de 8px */
}

.toggle-wrapper {
  background: var(--card);
  border: 2px solid var(--border);
  border-radius: 50px;
  padding: 6px; /* Reducido de 8px */
  cursor: pointer;
  display: flex;
  gap: 3px; /* Reducido de 4px */
  box-shadow: 0 3px 8px var(--shadow); /* Reducido de 0 4px 12px */
  transition: all 0.3s ease;
}

.toggle-wrapper:hover {
  transform: translateY(-1px); /* Reducido de -2px */
  box-shadow: 0 4px 12px var(--shadow); /* Reducido de 0 6px 16px */
  border-color: var(--accent);
}

/* THEME TOGGLE - TAMA√ëO REDUCIDO */
.theme-option {
  width: 26px; /* Reducido de 40px */
  height: 26px; /* Reducido de 40px */
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 13px; /* Reducido de 20px */
  cursor: pointer;
  transition: all 0.3s ease;
  border: 2px solid transparent;
  user-select: none;
}

.theme-option.active {
  background: var(--accent);
  border-color: var(--accent);
  transform: scale(1.1);
}

.theme-option:not(.active):hover {
  background: var(--card-2);
  transform: scale(1.05);
}

/* STATS TOGGLE - TAMA√ëO REDUCIDO */
.stats-switch {
  position: relative;
  width: 56px; /* Reducido de 88px */
  height: 26px; /* Reducido de 40px */
  background: var(--card-2);
  border-radius: 13px; /* Reducido proporcionalmente */
  cursor: pointer;
  transition: all 0.3s ease;
  border: 2px solid var(--border-hover);
}

.stats-switch:hover {
  border-color: var(--accent);
}

.stats-switch-slider {
  position: absolute;
  top: 2px; /* Reducido de 3px */
  left: 2px; /* Reducido de 3px */
  width: 20px; /* Reducido de 32px */
  height: 20px; /* Reducido de 32px */
  background: var(--muted);
  border-radius: 50%;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 1px 3px rgba(0,0,0,0.2); /* Reducido de 0 2px 4px */
}

.stats-switch.active {
  background: var(--accent);
  border-color: var(--accent);
}

.stats-switch.active .stats-switch-slider {
  left: calc(100% - 22px); /* Ajustado proporcionalmente */
  background: white;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3); /* Reducido de 0 2px 8px */
}

.stats-switch::before,
.stats-switch::after {
  content: '';
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  font-size: 9px; /* Reducido de 14px */
  font-weight: 700;
  transition: opacity 0.3s ease;
}

.stats-switch::before {
  content: '1';
  right: 7px; /* Reducido de 10px */
  color: white;
  opacity: 0;
}

.stats-switch::after {
  content: '0';
  left: 7px; /* Reducido de 10px */
  color: var(--muted);
  opacity: 1;
}

.stats-switch.active::before {
  opacity: 1;
}

.stats-switch.active::after {
  opacity: 0;
}

/* ==================== RESPONSIVE AJUSTADO ==================== */
@media (max-width: 768px) {
  .toggles-container {
    padding: 8px;
    gap: 8px;
    margin-bottom: 4px;
  }

  .toggle-wrapper {
    padding: 4px;
  }

  .theme-option {
    width: 28px; /* Reducido proporcionalmente */
    height: 28px;
    font-size: 14px;
  }

  .stats-switch {
    width: 60px; /* Reducido proporcionalmente */
    height: 28px;
    border-radius: 14px;
  }

  .stats-switch-slider {
    width: 22px;
    height: 22px;
    top: 2px;
    left: 2px;
  }

  .stats-switch.active .stats-switch-slider {
    left: calc(100% - 24px);
  }

  .stats-switch::before,
  .stats-switch::after {
    font-size: 9px;
  }

  .stats-switch::before {
    right: 5px;
  }

  .stats-switch::after {
    left: 5px;
  }
}

      /* CARD OPTIMIZADO */
      .card {
        padding: 16px 12px; /* Reducido lateral de 16px a 12px */
        border-radius: 12px;
      }

      /* LOGO COMPACTO */
      .logo {
        margin-bottom: 20px; /* Reducido de 30px */
      }

      .logo h1 {
        font-size: 24px; /* Reducido de 28px */
        margin-bottom: 6px;
      }

      .logo p {
        font-size: 14px; /* Reducido de 16px */
      }

      /* USER INFO COMPACTO */
     @media (max-width: 768px) {  
  .user-info {  
    padding: 12px 16px;  
    margin-bottom: 16px;  
    flex-wrap: wrap;  
  }  
    
  .user-info .user-content {  
    min-width: 0; /* Permite que el texto se recorte en m√≥viles */  
  }  
    
  .user-info .email {  
    font-size: 13px;  
  }  
    
  .user-info .logout {  
    padding: 6px 12px;  
    font-size: 13px;  
    margin-top: 8px;  
    width: auto;  
  }  
    
  /* En m√≥viles, el bot√≥n puede pasar a la siguiente l√≠nea si no cabe */  
  @media (max-width: 480px) {  
    .user-info {  
      flex-direction: column;  
      align-items: flex-start;  
    }  
      
    .user-info .user-content {  
      width: 100%;  
    }  
      
    .user-info .logout {  
      margin-left: 0;  
      align-self: flex-end;  
      margin-top: 12px;  
    }  
  }  
}

      /* PREGUNTA OPTIMIZADA */
      .pregunta-container {
        margin-bottom: 20px; /* Reducido de 30px */
      }

      .pregunta-header {
        margin-bottom: 12px; /* Reducido de 20px */
        padding-bottom: 10px; /* Reducido de 16px */
      }

      .pregunta-texto {
        font-size: 16px; /* Reducido de 18px */
        margin-bottom: 16px; /* Reducido de 24px */
      }

      /* STATS EN TIEMPO REAL - 3 COLUMNAS */
      #statsRealTime {
        grid-template-columns: repeat(3, 1fr); /* MANTENER 3 COLUMNAS */
        gap: 6px; /* Reducido de 12px */
        padding: 10px; /* Reducido de 16px */
        margin-bottom: 12px; /* Reducido de 20px */
      }

      #statsRealTime > div {
        padding: 8px 4px; /* Muy compacto */
      }

      #statsRealTime > div > div:first-child {
        font-size: 9px; /* Label muy peque√±o */
        margin-bottom: 3px;
      }

      #statsRealTime > div > div:last-child {
        font-size: 16px; /* Valor reducido de 20px */
        font-weight: 700;
      }

      /* OPCIONES COMPACTAS */
      .opciones {
        gap: 10px; /* Reducido de 12px */
        margin-bottom: 0; /* Sin margen porque el bot√≥n est√° separado */
      }

      .opcion {
        padding: 10px 12px; /* Reducido lateral de 14px a 12px */
        gap: 10px;
      }

      /* Bot√≥n Explicar IA en m√≥vil */
      #btnExplicarIA {
        margin-top: 12px;
        font-size: 13px;
      }

      .opcion-letra {
        width: 28px; /* Reducido de 32px */
        height: 28px;
        font-size: 14px;
      }

      .opcion-texto {
        font-size: 14px;
      }

      /* BOTONES COMPACTOS */
      .btn {
        padding: 12px 16px; /* Reducido de 16px 24px */
        font-size: 14px; /* Reducido de 16px */
      }

      .botones-navegacion {
        grid-template-columns: 40px 1fr; /* Bot√≥n anterior m√°s peque√±o en m√≥vil */
        gap: 6px; /* Reducido de 8px */
        margin-top: 16px; /* Reducido de 24px */
      }

      .btn-icon-nav {
        width: 40px;
        height: 40px;
        font-size: 18px;
      }

      #btnFinalizar {
        margin-top: 6px; /* Reducido de 8px */
      }

      #tandaOptions {
        gap: 6px;
        margin-top: 16px; /* Espacio despu√©s del bot√≥n IA */
      }

      #tandaOptions .btn {
        padding: 10px;
        font-size: 12px;
      }

      /* CATEGOR√çAS */
      .categoria-card {
        padding: 14px; /* Reducido de 16px */
      }

      .categoria-card h3 {
        font-size: 18px; /* Reducido de 20px */
      }

      .categoria-card .info {
        font-size: 12px;
        gap: 12px;
      }

      /* RESULTADOS */
      .resultado-score {
        font-size: 48px; /* Reducido de 56px */
        margin: 16px 0; /* Reducido de 20px 0 */
      }

      .resultado-stats {
        gap: 12px; /* Reducido de 16px */
        margin: 20px 0; /* Reducido de 30px 0 */
      }

      .stat-item {
        padding: 14px; /* Reducido de 20px */
      }

      .stat-item .value {
        font-size: 24px; /* Reducido de 28px */
      }

      .stats-grid {
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      /* INPUTS */
      .form-input {
        padding: 10px 14px; /* Reducido de 12px 16px */
        font-size: 14px;
        margin-bottom: 10px;
      }

      /* PROGRESS BAR */
      .progress-bar {
        height: 6px; /* Reducido de 8px */
        margin-bottom: 16px; /* Reducido de 24px */
      }
    }

    /* ==================== ESTILOS DE MONETIZACI√ìN ==================== */

    /* Variables adicionales para monetizaci√≥n */
    :root {
      --premium: #ffd700;
      --premium-bg: rgba(255, 215, 0, 0.1);
      --premium-border: rgba(255, 215, 0, 0.3);
      --warning: #f59e0b;
      --warning-bg: rgba(245, 158, 11, 0.1);
      --warning-border: rgba(245, 158, 11, 0.3);
    }

    [data-theme="light"] {
      --premium: #d4af37;
    }

    /* LOGIN CON GOOGLE PROMINENTE */
    .btn-google {
      background: white;
      color: #1f2937 !important;
      border: 2px solid var(--border-hover);
      font-size: 18px;
      padding: 18px 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .btn-google:hover {
      background: #f9fafb;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }

    .btn-google svg {
      width: 24px;
      height: 24px;
    }

    .tests-contratados {
  margin: 30px 0 20px 0;
  background: linear-gradient(135deg, rgba(255, 215, 0, 0.12), rgba(255, 215, 0, 0.04));
  border: 2px solid var(--premium-border);
  border-radius: 12px;
  padding: 16px 20px;
  box-shadow: 0 4px 16px rgba(255, 215, 0, 0.15);
  transition: all 0.3s ease;
}

.tests-contratados:hover {
  box-shadow: 0 6px 20px rgba(255, 215, 0, 0.25);
  transform: translateY(-2px);
}

   .tests-contratados h3 {
  color: var(--premium);
  font-size: 18px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 700;
  text-shadow: 0 1px 2px rgba(0,0,0,0.1);
}
.test-card-quick {
  background: linear-gradient(135deg, #34c3ff 0%, #0ea5e9 50%, #0284c7 100%) !important;
  padding: 16px 20px;
  border-radius: 12px;
  border: 3px solid #34c3ff !important;
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: 0 6px 24px rgba(52, 195, 255, 0.4) !important;
  position: relative;
  overflow: hidden;
}

.test-card-quick::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
  transition: left 0.6s ease;
}

.test-card-quick:hover {
  background: linear-gradient(135deg, #5dd5ff 0%, #34c3ff 50%, #0ea5e9 100%) !important;
  border-color: #0ea5e9 !important;
  transform: translateY(-3px) scale(1.02) !important;
  box-shadow: 0 12px 40px rgba(52, 195, 255, 0.6), 0 0 20px rgba(52, 195, 255, 0.8) !important;
  filter: brightness(1.1) saturate(1.1) !important;
}

.test-card-quick:hover::before {
  left: 100%;
}
      .test-card-quick p {
  color: #FFFFFF !important;
  font-weight: 600 !important;
  font-size: 15px !important;
  text-shadow: 0 2px 4px rgba(0,0,0,0.6) !important;
  margin-top: 4px !important;
}
      .test-card-quick h4 {
  color: #FFFFFF !important;
  text-shadow: 0 2px 4px rgba(0,0,0,0.6) !important;
  font-weight: 800 !important;
  font-size: 16px !important;
}
      
.test-card-quick.premium {
  border: 3px solid #FFD700 !important;
  background: linear-gradient(135deg, #FFD700 0%, #FFA500 50%, #FFD700 100%) !important;
  box-shadow: 0 6px 24px rgba(255, 215, 0, 0.4) !important;
  position: relative;
  overflow: hidden;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
}

.test-card-quick.premium::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
  transition: left 0.6s ease;
}

.test-card-quick.premium:hover {
  background: linear-gradient(135deg, #FFED4E 0%, #FFD700 50%, #FFA500 100%) !important;
  border-color: #FFA500 !important;
  transform: translateY(-3px) scale(1.02) !important;
  box-shadow: 0 12px 40px rgba(255, 215, 0, 0.6), 0 0 20px rgba(255, 215, 0, 0.8) !important;
  filter: brightness(1.1) saturate(1.2) !important;
}
     .test-card-quick.premium h4 {
  color: #8B4513 !important;
  text-shadow: 0 1px 2px rgba(0,0,0,0.5) !important;
  font-weight: 800 !important;
}

.test-card-quick.premium p {
  color: #654321 !important;
  font-weight: 600 !important;
  text-shadow: 0 1px 1px rgba(0,0,0,0.3) !important;
} 

.test-card-quick.premium:hover::before {
  left: 100%;
}

@keyframes shimmer {
  0%, 100% { opacity: 0.8; }
  50% { opacity: 1; }
}

.test-card-quick.premium:hover {
  border-color: #FFA500;
  background: linear-gradient(135deg, rgba(255, 215, 0, 0.35), rgba(255, 193, 7, 0.25));
  transform: translateY(-3px) scale(1.02);
  box-shadow: 0 8px 32px rgba(255, 215, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.3);
}

    .test-card-info h4 {
      color: var(--text);
      font-size: 16px;
      margin-bottom: 4px;
      font-weight: 600;
    }
.test-card-quick.premium .test-card-info h4 {
  color: #B8860B !important;
  text-shadow: 0 1px 3px rgba(0,0,0,0.3);
  font-weight: 700;
}
    .test-card-info p {
      color: var(--muted);
      font-size: 13px;
    }

    .test-badge {
      background: var(--success);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
    }

    .test-badge.premium {
  background: linear-gradient(135deg, #FFD700, #FFA500);
  color: #1f2937;
  border: 2px solid #FFB000;
  box-shadow: 0 3px 12px rgba(255, 215, 0, 0.4);
  text-shadow: 0 1px 2px rgba(0,0,0,0.2);
  font-weight: 800;
}

    /* SELECTOR DE TESTS (AHORA: hidden select + dropdown visual) */
    .test-selector {
      margin: 24px 0;
    }

    .test-selector label {
      display: block;
      color: var(--text);
      font-weight: 600;
      margin-bottom: 12px;
      font-size: 16px;
    }

    .select-wrapper {
      position: relative;
    }

    /* keep native select styles for fallback (hidden) */
    .select-wrapper select {
      display: none; /* hidden for compatibility */
    }

    /* ---------- Custom dropdown visual (cards) ---------- */
    .custom-dropdown { width:100%; position:relative; font-family:inherit; }
    .dropdown-selected {
      background: var(--card-2);
      border: 2px solid var(--border);
      padding: 14px;
      border-radius: 12px;
      color: var(--text);
      cursor: pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      box-shadow: 0 6px 20px var(--shadow);
      transition: all .18s ease;
    }
    .dropdown-selected:hover { border-color: var(--accent); transform: translateY(-2px); }
    .dropdown-selected .title { font-weight:700; color:var(--accent); font-size:16px; }
    .dropdown-selected .meta { color:var(--muted); font-size:13px; }

    .dropdown-list {
  position: fixed; /* Cambio de absolute a fixed */
  left: 12px; /* Margen desde los bordes de la pantalla */
  right: 12px; /* Margen desde los bordes de la pantalla */
  top: auto; /* Removemos el top fijo */
  bottom: 12px; /* Anclamos desde abajo */
  background: var(--card);
  z-index: 1000; /* Z-index m√°s alto para estar sobre todo */
  max-height: 80vh; /* 80% de la altura de la pantalla */
  overflow-y: auto;
  border-radius: 10px;
  box-shadow: 0 8px 24px var(--shadow);
  transition: max-height 0.28s ease;
  pointer-events: none;
  opacity: 0;
  padding: 12px; /* Padding interno para mejor presentaci√≥n */
}

.custom-dropdown.open .dropdown-list {
  max-height: 80vh;
  pointer-events: auto;
  opacity: 1;
}

/* Para pantallas peque√±as, ocupar m√°s espacio */
@media (max-width: 768px) {
  .dropdown-list {
    left: 8px;
    right: 8px;
    bottom: 8px;
    max-height: 85vh; /* Un poco m√°s de altura en m√≥viles */
  }
  
  .custom-dropdown.open .dropdown-list {
    max-height: 85vh;
  }
}

    .dropdown-item {
      background: var(--card);
      border:1px solid var(--border);
      border-radius:10px;
      padding:14px 16px;
      margin-bottom:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      cursor:pointer;
      transition: all .18s ease;
    }
    .dropdown-item:hover { transform: translateX(6px); border-color: var(--accent); background: var(--card-2); }

    .dropdown-item .info { display:flex; flex-direction:column; gap:6px; }
    .dropdown-item .info .name { color:var(--accent); font-weight:700; font-size:15px; }
    .dropdown-item .info .sub { color:var(--muted); font-size:13px; display:flex; gap:12px; align-items:center; }

    .badge-small {
      background: var(--accent-bg);
      border:1px solid var(--accent-border);
      color:var(--accent);
      padding:6px 10px;
      border-radius:999px;
      font-weight:700;
      font-size:13px;
      white-space:nowrap;
    }

    /* PLANES DE PAGO - estilos visuales mejorados (solo CSS) */
    .planes-container {
      margin-top: 30px;
      display: none;
    }

    .planes-container.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    /* Grid de planes - COMPACTACI√ìN APLICADA */
    .planes-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(160px, 1fr)); /* MODIFICACI√ìN: grid estricto para 4 tarjetas en pantallas grandes */
      gap: 10px; /* Gap reducido para compacidad */
      margin-top: 18px;
    }

    /* Tarjeta de plan - COMPACTACI√ìN APLICADA */
    .plan-card {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      border-radius: 12px; /* levemente reducido */
      padding: 12px; /* MODIFICACI√ìN: menos padding para tarjetas m√°s compactas */
      border: 1px solid var(--border);
      box-shadow: 0 8px 20px rgba(0,0,0,0.35);
      display: flex;
      flex-direction: column;
      gap: 8px; /* gap reducido */
      cursor: pointer;
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
      position: relative;
      min-height: 120px; /* MODIFICACI√ìN: menos altura m√≠nima */
    }

    .plan-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 14px 32px rgba(0,0,0,0.42);
      border-color: var(--accent);
    }

    .plan-card .plan-icon {
      font-size: 20px; /* reducido */
      width: 40px; /* reducido */
      height: 40px; /* reducido */
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      background: rgba(255,255,255,0.02);
    }

    .plan-card .plan-name {
      font-size: 16px; /* reducido */
      font-weight: 800;
      color: var(--accent);
    }

    .plan-card .plan-price {
      font-size: 16px; /* reducido */
      font-weight: 900;
      color: var(--text);
      background: linear-gradient(90deg, rgba(52,195,255,0.06), transparent);
      padding: 4px 8px; /* reducido */
      border-radius: 6px;
      display: inline-block;
      margin-top: 4px;
    }

    .plan-card .plan-price small {
      font-size: 11px; /* reducido */
      font-weight: 600;
      color: var(--muted);
      margin-left: 6px;
    }

    .plan-card .plan-features {
      list-style: none;
      padding-left: 0;
      margin: 0;
      color: var(--muted);
      font-size: 12px; /* reducido */
      line-height: 1.4;
      margin-top: 6px;
      flex: 1;
    }

    .plan-card .plan-limit {
      color: var(--muted);
      font-size: 12px; /* reducido */
      font-weight: 600;
      margin-top: 8px;
    }

    /* Tarjeta destacada (popular) */
    .plan-card.popular {
      border: 2px solid var(--premium);
      background: linear-gradient(180deg, rgba(255,215,0,0.04), rgba(255,215,0,0.01));
      transform: translateY(0);
    }

    .plan-badge-popular {
      position: absolute;
      top: -8px; /* menos offset */
      right: 10px;
      background: var(--premium);
      color: #1f2937;
      padding: 5px 10px; /* reducido */
      border-radius: 999px;
      font-weight: 800;
      font-size: 12px; /* reducido */
      box-shadow: 0 6px 18px rgba(255,215,0,0.08);
    }

    /* Estado seleccionado (cuando el usuario hace click) */
    .plan-card.selected {
      outline: 3px solid rgba(52,195,255,0.14);
      transform: translateY(-6px) scale(1.01);
    }

    /* Ajustes visuales para botones y CTA - COMPACTACI√ìN */
    .planes-header h3 {
      color: var(--accent);
      margin-bottom: 4px;
      font-size: 18px; /* reducido */
    }
    .planes-header p {
      color: var(--muted);
      margin-bottom: 12px;
      font-size: 13px; /* reducido */
    }

    /* Bot√≥n activar plan m√°s compacto */
    #btnActivarPlan {
        display: none !important;
      padding: 10px 14px; /* MODIFICACI√ìN: m√°s compacto */
      font-size: 14px;
      border-radius: 8px;
    }

    /* Estilos m√≥viles espec√≠ficos para planes */
    @media (max-width: 680px) {
      .planes-grid {
        grid-template-columns: 1fr;
      }

     .plan-card {
  background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
  border-radius: 12px;
  padding: 12px;
  border: 1px solid var(--border);
  box-shadow: 0 8px 20px rgba(0,0,0,0.35);
  display: flex;
  flex-direction: column;
  gap: 8px;
  cursor: pointer;
  transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
  position: relative;
  min-height: 120px;
}

.plan-card:hover {
  transform: translateY(-8px) scale(1.03) !important;
  box-shadow: 0 16px 40px rgba(0,0,0,0.5) !important;
  border-color: var(--accent) !important;
}
      .plan-card::before {
  content: 'üí≥ Contratar';
  position: absolute;
  bottom: -35px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--accent);
  color: white;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  opacity: 0;
  transition: all 0.3s ease;
  pointer-events: none;
}

.plan-card:hover::before {
  bottom: -25px;
  opacity: 1;
}

.plan-card:active {
  transform: translateY(-4px) scale(1.01) !important;
}
    }
  
  .btn-icon-nav {  
    justify-self: start; /* deja el icono al inicio si quieres mantenerlo */  
    width: 44px;  
  }  
  
  
}
    /* BOT√ìN PREMIUM */
    .btn-premium {
      background: linear-gradient(135deg, var(--premium) 0%, #ffa500 100%);
      color: #1f2937 !important;
      font-weight: 700;
      box-shadow: 0 4px 12px var(--premium-bg);
      padding: 12px 16px; /* reducido un poco */
    }

    .btn-premium:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px var(--premium-bg);
    }


  </style>
</head>
<body>

  <div class="container">
    <!-- TOGGLES -->
    <div class="toggles-container">
      <div class="toggle-wrapper" onclick="toggleTheme()" title="Cambiar tema">
        <div class="theme-option" id="lightIcon">‚òÄÔ∏è</div>
        <div class="theme-option active" id="darkIcon">üåô</div>
      </div>

      <div class="toggle-wrapper" title="Mostrar/Ocultar estad√≠sticas">
        <div class="stats-switch active" id="statsSwitch" onclick="toggleStatsVisibility()">
          <div class="stats-switch-slider"></div>
        </div>
      </div>
    </div>

    <!-- PANTALLA 1: LOGIN CON FIREBASE -->
    <div id="screenLogin" class="screen active">  
      <div class="card">  
        <div class="logo">  
          <h1>üéì MultiTest</h1>  
          <p>Tu plataforma de tests profesionales</p>  
        </div>  

        <div id="errorMessage" class="error-message"></div>

        <!-- Login Google prominente -->
        <button class="btn btn-google" onclick="loginWithGoogle()" id="btnGoogleLogin">
          <svg width="24" height="24" viewBox="0 0 24 24">
            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
          Continuar con Google
        </button>

        <!-- Tests contratados (accesos r√°pidos) -->
        <div id="testsContratados" class="tests-contratados" style="display:none;">
          <h3>‚ö° Acceso r√°pido a tus tests</h3>
          <div id="testsContratadosList"></div>
        </div>

        <div class="login-divider">
          <span>‚îÄ‚îÄ o ‚îÄ‚îÄ</span>
        </div>

        <!-- Bot√≥n para ir a login con email -->
        <button class="btn btn-secondary" onclick="irALoginEmail()">
          üìß Iniciar sesi√≥n con email
        </button>

        <div class="small-text" style="margin-top: 20px;">
          Al continuar, aceptas nuestros t√©rminos y condiciones
        </div>

        <div id="loginLoading" style="display: none; text-align: center; margin-top: 15px;">
          <div class="spinner" style="width: 20px; height: 20px; margin: 0 auto 10px;"></div>
          <p style="color: var(--muted); font-size: 14px;">Iniciando sesi√≥n...</p>
        </div>
      </div>
    </div>

    <!-- PANTALLA 2: LOGIN CON EMAIL (Separada) -->
    <div id="screenEmailLogin" class="screen">
      <div class="card">
        <div class="logo">
          <h1>üìß Acceso con Email</h1>
          <p>Inicia sesi√≥n o crea una cuenta</p>
        </div>

        <div id="errorMessageEmail" class="error-message"></div>

        <input type="email" id="emailInput" class="form-input" placeholder="tu@email.com">
        <input type="password" id="passwordInput" class="form-input" placeholder="Contrase√±a (m√≠n. 6 caracteres)">

        <button class="btn btn-primary" onclick="loginWithEmail()" style="margin-bottom: 12px;">
          Iniciar Sesi√≥n
        </button>
        <button class="btn btn-secondary" onclick="registerWithEmail()">
          Crear Nueva Cuenta
        </button>

        <button class="btn btn-secondary" onclick="volverLoginPrincipal()" style="margin-top: 20px;">
          ‚Üê Volver
        </button>
      </div>
    </div>

    <!-- PANTALLA 3: SELECCIONAR TEST Y PLAN -->
    <div id="screenSeleccionTest" class="screen">
      <div class="card">
        <div class="user-info">
          <div class="user-content">
            <div class="user-label">Versi√≥n BETA 0.11 - Conectado como:</div>
            <div class="email" id="userEmailSeleccion"></div>
          </div>
<button class="logout" onclick="cerrarSesion()">üîÑ</button>
</div>
<div id="testsContratadosSeleccion" class="tests-contratados" style="display:none;">
  <h3>üëë Tus Tests Activos</h3>
  <div id="testsContratadosSeleccionList"></div>
</div>
        <div class="logo">
          <h1>üìö Selecciona un Test y un plan</h1>
        </div>

    <!-- Selector de test -->  
<div class="test-selector">  
  <label for="testSelect"></label>  
  <div class="select-wrapper">  
    <select id="testSelect" onchange="mostrarPlanes()">  
      <option value="">Selecciona un test...</option>  
    </select>  
  </div>  
  
  <!-- dropdown visual (ahora dentro del mismo test-selector) -->  
  <div class="custom-dropdown" id="customTestDropdown" role="listbox" aria-haspopup="true">  
    <div class="dropdown-selected" id="dropdownSelected">Selecciona un test...</div>  
    <div class="dropdown-list" id="dropdownList" aria-hidden="true"></div>  
  </div>  
</div>

        <!-- Planes de pago -->
        <div id="planesContainer" class="planes-container">
          <div class="planes-header">
            <h3>Elige tu plan de acceso</h3>
            <p>Selecciona el plan que mejor se adapte a tus necesidades</p>
          </div>

          <div class="planes-grid">
            <!-- Plan Gratuito -->
            <div class="plan-card" onclick="seleccionarPlan('gratuito')" id="plangratuito">
              <div style="display:flex; align-items:center; gap:12px;">
                <div class="plan-icon">üéÅ</div>
                <div>
                  <div class="plan-name">Gratuito</div>
                  <div class="plan-price">0‚Ç¨ <small>/tanda</small></div>
                </div>
              </div>
              <ul class="plan-features">
                <li>2 tandas de prueba</li>
                <li>30 preguntas por tanda</li>
                <li>Sin compromiso</li>
              </ul>
              <div class="plan-limit">
                ‚è±Ô∏è Acceso limitado
              </div>
            </div>

            <!-- Plan Mensual -->
            <div class="plan-card" onclick="seleccionarPlan('mensual')" id="planMensual">
              <div style="display:flex; align-items:center; gap:12px;">
                <div class="plan-icon">üìÖ</div>
                <div>
                  <div class="plan-name">Mensual</div>
                  <div class="plan-price">9,99‚Ç¨ <small>/mes</small></div>
                </div>
              </div>
              <ul class="plan-features">
                <li>Acceso ilimitado a tu test</li>
                <li>Sin l√≠mite de tandas</li>
                <li>Cancela cuando quieras</li>
              </ul>
            </div>

            <!-- Plan Trimestral -->
            <div class="plan-card popular" onclick="seleccionarPlan('trimestral')" id="planTrimestral">
              <div class="plan-badge-popular">‚≠ê M√°s Popular</div>
              <div style="display:flex; align-items:center; gap:12px;">
                <div class="plan-icon">üî•</div>
                <div>
                  <div class="plan-name">Trimestral</div>
                  <div class="plan-price">24,99‚Ç¨ <small>/3 meses</small></div>
                </div>
              </div>
              <ul class="plan-features">
                <li>Ahorra 25%</li>
                <li>Acceso ilimitado a tu test</li>
                <li>Pago cada 3 meses</li>
              </ul>
            </div>

            <!-- Plan Anual -->
            <div class="plan-card" onclick="seleccionarPlan('anual')" id="planAnual">
              <div style="display:flex; align-items:center; gap:12px;">
                <div class="plan-icon">üëë</div>
                <div>
                  <div class="plan-name">Anual</div>
                  <div class="plan-price">79,99‚Ç¨ <small>/a√±o</small></div>
                </div>
              </div>
              <ul class="plan-features">
                <li>Ahorra 33%</li>
                <li>Acceso ilimitado a tu test</li>
                <li>Mejor precio</li>
              </ul>
            </div>
          </div>

          <button class="btn btn-premium" id="btnActivarPlan" onclick="activarPlan()" style="display:none;">
            üöÄ Activar Plan Seleccionado
          </button>
        </div>
      </div>
    </div>

    <!-- PANTALLA 4: TEST -->
    <div id="screenTest" class="screen">
      <div class="card">
        <div class="user-info">  
  <div class="user-content">  
    <div class="user-label">Test:</div>  
    <div class="email" id="testCategoriaNombre"></div>  
  </div>  
  <!-- Bot√≥n "Salir" en la esquina derecha -->  
  <button id="btnSalirTest" class="logout" onclick="volverCategorias()" title="Salir al men√∫ principal">  
    Salir  
  </button>  
</div>

        <div class="progress-bar">
          <div class="progress-fill" id="progressBar" style="width: 0%"></div>
        </div>

        <div class="pregunta-container">
          <div class="pregunta-header">
            <div class="pregunta-numero" id="preguntaNumero">Pregunta 1 de 30</div>
          </div>

          <div class="pregunta-texto" id="preguntaTexto"></div>

          <div class="opciones" id="opcionesContainer"></div>

          <button class="btn" id="btnExplicarIA" onclick="explicarPreguntaConChatGPT()">
            üí¨ Explicar con IA
          </button>

          <div id="feedbackContainer" style="display:none; margin-top: 20px;"></div>
        </div>

        <div id="tandaOptions" style="display:none;">  
          <button class="btn btn-primary" id="btnRepetirFallos" onclick="repetirFallos()">  
            üîÅ Repetir Fallos
          </button>  
<button class="btn btn-secondary" id="btnSaltarTanda" onclick="saltarTanda()">  
            ‚è≠Ô∏è Saltar
          </button>  
        </div>

        <!-- REEMPLAZA TODO EL BLOQUE DE NAVEGACI√ìN ACTUAL POR ESTE -->
<div class="botones-navegacion">
  <button class="btn-icon-nav" id="btnAnterior" onclick="preguntaAnterior()" style="display:none;">
    ‚Üê
  </button>
  
  <div class="botones-derecha">
    <button class="btn btn-primary" id="btnSiguiente" onclick="siguientePregunta()" disabled>
      ‚Üí
    </button>
    <button class="btn btn-success" id="btnFinalizar" onclick="finalizarTest()" disabled>
      ‚úì Finalizar
    </button>
  </div>
</div>
      </div>
    </div>

    <!-- PANTALLA 4: RESULTADOS -->
    <div id="screenResultado" class="screen">
      <div class="card">
        <div class="resultado-card">
          <h1 style="color: var(--accent); margin-bottom: 10px;">üéâ Test Completado</h1>
          <p style="color: var(--muted); margin-bottom: 20px;">Has finalizado el test</p>

          <div class="resultado-score" id="resultadoPorcentaje">0%</div>

          <div class="resultado-stats">
            <div class="stat-item">
              <div class="label">Correctas</div>
              <div class="value" id="resultadoCorrectas" style="color: var(--success);">0</div>
            </div>
            <div class="stat-item">
              <div class="label">Incorrectas</div>
              <div class="value" id="resultadoIncorrectas" style="color: var(--danger);">0</div>
            </div>
            <div class="stat-item">
              <div class="label">Total</div>
              <div class="value" id="resultadoTotal">0</div>
            </div>
          </div>

          <div class="stats-toggle" id="statsToggle">
            <div class="stats-toggle-header" onclick="toggleStats()">
              <div class="stats-toggle-title">
                <span>üìä</span>
                <span>Ver estad√≠sticas detalladas</span>
              </div>
              <div class="stats-toggle-icon" id="statsIcon">‚ñº</div>
            </div>
            <div class="stats-toggle-content" id="statsContent">
              <div class="stats-toggle-body" id="statsBody">
                <div class="loading">
                  <div class="spinner"></div>
                  <p style="color: var(--muted);">Cargando estad√≠sticas...</p>
                </div>
              </div>
            </div>
          </div>

          <div style="margin-top: 30px; display: flex; flex-direction: column; gap: 12px;">
            <button class="btn btn-primary" onclick="nuevoTest()">
              üîÑ Hacer otro test
            </button>
            <button class="btn btn-secondary" onclick="volverCategorias()">
              üìö Cambiar categor√≠a
            </button>
            <button class="btn chatgpt-btn" onclick="consultarChatGPT()">
              üí¨ Consultar dudas con ChatGPT
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==================== THEME TOGGLE ====================
    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const lightIcon = document.getElementById('lightIcon');
      const darkIcon = document.getElementById('darkIcon');

      if (currentTheme === 'light') {
        html.setAttribute('data-theme', 'dark');
        localStorage.setItem('theme', 'dark');
        lightIcon.classList.remove('active');
        darkIcon.classList.add('active');
      } else {
        html.setAttribute('data-theme', 'light');
        localStorage.setItem('theme', 'light');
        darkIcon.classList.remove('active');
        lightIcon.classList.add('active');
      }
    }

    function loadSavedTheme() {
      const savedTheme = localStorage.getItem('theme') || 'dark';
      const html = document.documentElement;
      const lightIcon = document.getElementById('lightIcon');
      const darkIcon = document.getElementById('darkIcon');

      html.setAttribute('data-theme', savedTheme);

      if (savedTheme === 'light') {
        darkIcon.classList.remove('active');
        lightIcon.classList.add('active');
      } else {
        lightIcon.classList.remove('active');
        darkIcon.classList.add('active');
      }
    }

    // ==================== STATS VISIBILITY TOGGLE ====================
    function toggleStatsVisibility() {
      const statsSwitch = document.getElementById('statsSwitch');
      const statsPanel = document.getElementById('statsRealTime');

      statsSwitch.classList.toggle('active');

      if(statsPanel) {
        statsPanel.classList.toggle('hidden');
      }

      const isVisible = statsSwitch.classList.contains('active');
      localStorage.setItem('statsVisible', isVisible ? '1' : '0');

      console.log('Stats visible:', isVisible ? 'SI (1)' : 'NO (0)');
    }

    function loadStatsPreference() {
      const saved = localStorage.getItem('statsVisible');
      const isVisible = saved === null ? true : saved === '1';

      const statsSwitch = document.getElementById('statsSwitch');

      if (isVisible) {
        statsSwitch.classList.add('active');
      } else {
        statsSwitch.classList.remove('active');
      }
    }

    function forceShowStats() {
      const statsSwitch = document.getElementById('statsSwitch');
      const statsPanel = document.getElementById('statsRealTime');

      statsSwitch.classList.add('active');
      if(statsPanel) {
        statsPanel.classList.remove('hidden');
      }
    }

    function restoreStatsPreference() {
      const saved = localStorage.getItem('statsVisible');
      const isVisible = saved === null ? true : saved === '1';

      const statsSwitch = document.getElementById('statsSwitch');
      const statsPanel = document.getElementById('statsRealTime');

      if (isVisible) {
        statsSwitch.classList.add('active');
        if(statsPanel) statsPanel.classList.remove('hidden');
      } else {
        statsSwitch.classList.remove('active');
        if(statsPanel) statsPanel.classList.add('hidden');
      }
    }

    // ==================== CONFIG ====================
    const useLocalData = false;
    const preguntasFolder = 'preguntas';

    const CONFIG = {
      mostrarProgresoTanda: false,
      mostrarRestantesGlobal: false
    };

    // ==================== VARIABLES GLOBALES - NUEVA ESTRUCTURA ====================
    let usuarioActual = null;
    let categoriaActual = null;

    // NUEVA ESTRUCTURA PARA TANDAS SECUENCIALES
    let masterPool = [];              // Todas las preguntas disponibles (inmutable)
    let preguntasPendientes = [];     // Preguntas NUNCA mostradas en tandas normales
    let preguntasCompletadas = [];    // Preguntas ya acertadas (de tandas anteriores)
    let preguntasFalladas = [];       // Fallos de la tanda ACTUAL (para repetici√≥n)
    let tandaActual = [];             // Preguntas de la tanda en curso
    let indicePreguntaActual = 0;
    let respuestasUsuario = [];
    let numeroTanda = 0;
    let totalTandasEstimadas = 0;
    let esTandaRepeticion = false;    // true cuando estamos repitiendo fallos

    // Configuraci√≥n
    let preguntasPorTanda = 30;
    let totalPreguntas = 0;
    let preguntasRealizadasGlobal = 0;
    let aciertosGlobal = 0;
    let inicioTestTimestamp = null;

    // ==================== CONFIGURACI√ìN STRIPE Y MONETIZACI√ìN ====================
    const STRIPE_PUBLIC_KEY = 'pk_test_51SVCbvRsnNtATP9UbXroRGFhMARYundAmKx5CJGq7sVmviU8MqQ8lZ2xJcerbehw5pkGFSJiRpVHJEOhsZDFjVSV00SnHb7KiG'; // TODO: Reemplazar con tu clave p√∫blica
    const stripe = Stripe(STRIPE_PUBLIC_KEY);
console.log('üîë Stripe inicializado con:', STRIPE_PUBLIC_KEY.substring(0, 20) + '...');
    // IDs de precios de Stripe (crear en Dashboard de Stripe)
    const STRIPE_PRICES = {
      mensual: 'price_1SVGnbRsnNtATP9UMZTNCg0v',
    trimestral: 'price_1SWu42RsnNtATP9UPeHj3GxP',
      anual: 'price_1SWu4uRsnNtATP9UP3YCCjvK'
    };

    let suscripcionesUsuario = {}; // { testId: { plan, tandasUsadas, fechaActivacion, etc } }
    let planSeleccionado = null;
    let testSeleccionado = null;
    const TANDAS_GRATUITAS = 2;

    // ==================== FUNCIONES FIREBASE AUTH ====================
    function loginWithGoogle() {
      // üîß DESHABILITADO EN DESARROLLO
      if (IS_DEVELOPMENT) {
        console.log('üö´ Login con Google deshabilitado en desarrollo');
        alert('üîß Login con Google deshabilitado en modo desarrollo\n\nUsa "Iniciar sesi√≥n con email" para testing');
        return;
      }

      console.log('üîµ Iniciando login con Google...');
      // ... el resto del c√≥digo original permanece igual
      showLoginLoading(true);
      hideErrorMessage();

      const btnGoogle = document.getElementById('btnGoogleLogin');
      if (btnGoogle) btnGoogle.disabled = true;

      const provider = new firebase.auth.GoogleAuthProvider();
      provider.addScope('profile');
      provider.addScope('email');
      provider.setCustomParameters({
        'prompt': 'select_account'
      });

      firebase.auth().signInWithPopup(provider)
        .then((result) => {
          console.log('‚úÖ Login Google exitoso:', result.user);
          showLoginLoading(false);
          // onAuthStateChanged se encargar√° del resto
        })
        .catch((error) => {
          console.error('‚ùå Error login Google:', error);

          let errorMsg = 'Error en login con Google';

          switch(error.code) {
            case 'auth/popup-blocked':
              errorMsg = 'El navegador bloque√≥ la ventana emergente. Por favor, permite las ventanas emergentes.';
              break;
            case 'auth/popup-closed-by-user':
              errorMsg = 'Cerraste la ventana de login antes de completar el proceso.';
              break;
            case 'auth/cancelled-popup-request':
              errorMsg = 'Se cancel√≥ la solicitud de login.';
              break;
            case 'auth/unauthorized-domain':
              errorMsg = 'Este dominio no est√° autorizado. Verifica la configuraci√≥n en Firebase Console.';
              break;
            case 'auth/operation-not-allowed':
              errorMsg = 'El login con Google no est√° habilitado. Act√≠valo en Firebase Console.';
              break;
            case 'auth/network-request-failed':
              errorMsg = 'Error de red. Verifica tu conexi√≥n a internet.';
              break;
            default:
              errorMsg = `Error: ${error.message}`;
          }

          showErrorMessage(errorMsg);
          showLoginLoading(false);
          if (btnGoogle) btnGoogle.disabled = false;
        });
    }

    function loginWithEmail() {
      const email = document.getElementById('emailInput').value.trim();
      const password = document.getElementById('passwordInput').value;

      if (!email || !password) {
        showErrorMessage('Por favor completa ambos campos', 'errorMessageEmail');
        return;
      }

      if (!validateEmail(email)) {
        showErrorMessage('Por favor ingresa un email v√°lido', 'errorMessageEmail');
        return;
      }

      showLoginLoading(true);
      hideErrorMessage('errorMessageEmail');

      firebase.auth().signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          console.log('‚úÖ Login email exitoso:', userCredential.user);
          showLoginLoading(false);
          // onAuthStateChanged se encargar√° del resto
        })
        .catch((error) => {
          console.error('‚ùå Error login email:', error);

          let errorMsg = 'Error al iniciar sesi√≥n';

          switch(error.code) {
            case 'auth/user-not-found':
              errorMsg = 'No existe una cuenta con este email';
              break;
            case 'auth/wrong-password':
              errorMsg = 'Contrase√±a incorrecta';
              break;
            case 'auth/invalid-email':
              errorMsg = 'Email inv√°lido';
              break;
            case 'auth/user-disabled':
              errorMsg = 'Esta cuenta ha sido deshabilitada';
              break;
            case 'auth/too-many-requests':
              errorMsg = 'Demasiados intentos fallidos. Intenta m√°s tarde';
              break;
            default:
              errorMsg = error.message;
          }

          showErrorMessage(errorMsg, 'errorMessageEmail');
          showLoginLoading(false);
        });
    }

    function registerWithEmail() {
      const email = document.getElementById('emailInput').value.trim();
      const password = document.getElementById('passwordInput').value;

      if (!email || !password) {
        showErrorMessage('Por favor completa ambos campos', 'errorMessageEmail');
        return;
      }

      if (!validateEmail(email)) {
        showErrorMessage('Por favor ingresa un email v√°lido', 'errorMessageEmail');
        return;
      }

      if (password.length < 6) {
        showErrorMessage('La contrase√±a debe tener al menos 6 caracteres', 'errorMessageEmail');
        return;
      }

      showLoginLoading(true);
      hideErrorMessage('errorMessageEmail');

      firebase.auth().createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
          console.log('‚úÖ Registro exitoso:', userCredential.user);
          showLoginLoading(false);
          // onAuthStateChanged se encargar√° del resto
        })
        .catch((error) => {
          console.error('‚ùå Error al registrarse:', error);

          let errorMsg = 'Error al crear la cuenta';

          switch(error.code) {
            case 'auth/email-already-in-use':
              errorMsg = 'Este email ya est√° registrado. Intenta iniciar sesi√≥n';
              break;
            case 'auth/invalid-email':
              errorMsg = 'Email inv√°lido';
              break;
            case 'auth/weak-password':
              errorMsg = 'La contrase√±a es muy d√©bil';
              break;
            default:
              errorMsg = error.message;
          }

          showErrorMessage(errorMsg, 'errorMessageEmail');
          showLoginLoading(false);
        });
    }

    function crearPerfilUsuario() {
      const userRef = db.collection('usuarios').doc(usuarioActual.uid);

      userRef.set({
        email: usuarioActual.email,
        displayName: usuarioActual.displayName,
        fechaRegistro: firebase.firestore.FieldValue.serverTimestamp(),
        ultimoAcceso: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true }).catch(error => {
        console.error('Error creando perfil:', error);
      });
    }

    function validateEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }

    function showLoginLoading(show) {
      const el = document.getElementById('loginLoading');
      if (el) el.style.display = show ? 'block' : 'none';
    }

    function cerrarSesion() {
      firebase.auth().signOut()
        .then(() => {
          console.log('‚úÖ Sesi√≥n cerrada correctamente');
          usuarioActual = null;
          categoriaActual = null;
          suscripcionesUsuario = {}; // Limpiar suscripciones
          masterPool = [];
          preguntasPendientes = [];
          preguntasCompletadas = [];
          preguntasFalladas = [];
          tandaActual = [];
          indicePreguntaActual = 0;
          respuestasUsuario = [];
          numeroTanda = 0;

          if (analytics) {
            firebase.analytics().setUserId(null);
          }

          document.getElementById('emailInput').value = '';
          document.getElementById('passwordInput').value = '';
          hideErrorMessage();
          hideErrorMessage('errorMessageEmail');

          mostrarPantalla('screenLogin');
        })
        .catch((error) => {
          console.error('‚ùå Error cerrando sesi√≥n:', error);
          showErrorMessage('Error al cerrar sesi√≥n');
        });
    }

    function mostrarPantalla(screenId) {
      console.log('üîÑ Mostrando pantalla:', screenId);
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
    }

    function sanitizeForFilename(id) {
      return String(id).replace(/[^a-z0-9\\-_.]/gi, '_');
    }

    // ==================== CATEGOR√çAS & DROPDOWN ====================
    async function cargarCategoriasEnSelector() {
      try {
        const snapshot = await db.collection('categorias').where('activa', '==', true).get();
        const select = document.getElementById('testSelect');
        const dropdownList = document.getElementById('dropdownList');
        const dropdownSelected = document.getElementById('dropdownSelected');

        // limpiar
        select.innerHTML = '<option value="">Selecciona un test...</option>';
        dropdownList.innerHTML = '';
        dropdownSelected.textContent = 'Selecciona un test...';

        snapshot.forEach(doc => {
          const cat = doc.data();
          const id = doc.id;

          // llenar select oculto (compatibilidad)
          const option = document.createElement('option');
          option.value = id;
          option.textContent = cat.nombre || id;
          select.appendChild(option);

          // crear item visual
          const item = document.createElement('div');
          item.className = 'dropdown-item';
          item.dataset.testId = id;

          const info = document.createElement('div');
          info.className = 'info';
          const name = document.createElement('div');
          name.className = 'name';
          name.textContent = cat.nombre || id;
          const sub = document.createElement('div');
          sub.className = 'sub';
          const totalTxt = (cat.totalPreguntas || cat.total || '?') + ' preguntas';
          const tandaTxt = (cat.preguntasPorTanda || cat.preguntasPorTanda === 0) ? (cat.preguntasPorTanda + ' por tanda') : '30 por tanda';
          sub.innerHTML = `<span>üìö ${totalTxt}</span><span>‚è±Ô∏è ${tandaTxt}</span>`;

          info.appendChild(name); info.appendChild(sub);
          const badge = document.createElement('div');
          badge.className = 'badge-small';
          badge.textContent = 'Abrir';

          item.appendChild(info);
          item.appendChild(badge);

          item.addEventListener('click', () => {
            seleccionarTestDesdeDropdown(id, cat);
          });

          dropdownList.appendChild(item);
        });

        // Toggle del dropdown
        const wrapper = document.getElementById('customTestDropdown');
        const selected = document.getElementById('dropdownSelected');
        selected.onclick = function(e) {
          e.stopPropagation();
          wrapper.classList.toggle('open');
        };

        // cerrar al click fuera
        document.addEventListener('click', (ev) => {
          const w = document.getElementById('customTestDropdown');
          if (!w) return;
          if (!w.contains(ev.target)) {
            w.classList.remove('open');
          }
        });

        console.log('‚úÖ Categor√≠as cargadas en dropdown');
      } catch (error) {
        console.error('‚ùå Error cargando categor√≠as:', error);
      }
    }

    // Al elegir un test en el dropdown: actualiza select oculto y muestra planes (o inicia test si quieres)
    function seleccionarTestDesdeDropdown(testId, catData = {}) {
      const select = document.getElementById('testSelect');
      if (select) select.value = testId;

      const dropdownSelected = document.getElementById('dropdownSelected');
      dropdownSelected.innerHTML = `
        <div style="display:flex; align-items:center; gap:12px; width:100%;">
          <div style="flex:1;">
            <div class="title">${catData.nombre || testId}</div>
            <div class="meta" style="font-size:13px; color:var(--muted);">
              üìö ${catData.totalPreguntas || catData.total || '?'} preguntas ‚Ä¢ ‚è±Ô∏è ${catData.preguntasPorTanda || '30'} por tanda
            </div>
          </div>
          <div style="color:var(--muted); font-size:13px;">‚ñº</div>
        </div>
      `;
      const wrapper = document.getElementById('customTestDropdown');
      if (wrapper) wrapper.classList.remove('open');

      testSeleccionado = testId;
      mostrarPlanes();
     
}
    function preseleccionarTestContratado() {
  const keys = Object.keys(suscripcionesUsuario || {});
  if (keys.length === 0) {
    console.log('üì≠ No hay suscripciones para preseleccionar');
    return;
  }

  // Buscar el primer test con suscripci√≥n activa
  const firstTest = keys[0];
  const sub = suscripcionesUsuario[firstTest];
  
  if (!sub || !sub.plan || sub.plan === 'none') {
    console.log('üì≠ Primera suscripci√≥n no es v√°lida');
    return;
  }

  console.log('üîé Preseleccionando test autom√°ticamente:', firstTest, 'con plan:', sub.plan);

  // Actualizar select oculto
  const select = document.getElementById('testSelect');
  if (select) {
    select.value = firstTest;
  }

  // Actualizar dropdown visual
  const dropdownSelected = document.getElementById('dropdownSelected');
  if (dropdownSelected) {
    const testNombre = sub.nombre || firstTest;
    dropdownSelected.innerHTML = `
      <div style="display:flex; align-items:center; gap:12px; width:100%;">
        <div style="flex:1;">
          <div class="title">${testNombre}</div>
          <div class="meta" style="font-size:13px; color:var(--muted);">
            Test activo - ${sub.plan} 
          </div>
        </div>
        <div style="color:var(--premium); font-size:13px;">üëë</div>
      </div>
    `;
  }

  // Establecer variables globales
  testSeleccionado = firstTest;
  
  // Mostrar planes y preseleccionar
  mostrarPlanes();
  seleccionarPlan(sub.plan);
  
  // Mostrar bot√≥n dorado inmediatamente
  const testNombre = sub.nombre || firstTest;
 // mostrarBotonIniciarTest(testNombre);
  
  console.log('‚úÖ Test preseleccionado autom√°ticamente:', testNombre);
}

    // ==================== MONETIZACI√ìN / SUSCRIPCIONES ====================
    async function cargarSuscripcionesUsuario() {
      if (!usuarioActual) return;

      try {
        const doc = await db.collection('suscripciones').doc(usuarioActual.uid).get();
        if (doc.exists) {
          suscripcionesUsuario = doc.data();
          console.log('üìä Suscripciones cargadas:', suscripcionesUsuario);
        } else {
          suscripcionesUsuario = {};
        }
      } catch (error) {
        console.error('‚ùå Error cargando suscripciones:', error);
        suscripcionesUsuario = {};
      }

      document.getElementById('userEmailSeleccion').textContent = usuarioActual.email;

      // Llamar a la funci√≥n que renderiza el bot√≥n (solo visible para carlos.itim@gmail.com)
      renderTestAccessButtonIfTester();

      // Mostrar tests contratados en pantalla de login
      mostrarTestsContratados();

      // Cargar categor√≠as en el selector (dropdown)
      await cargarCategoriasEnSelector();

      // Ir a pantalla de selecci√≥n
      document.getElementById('userEmailSeleccion').textContent = usuarioActual.email;
      mostrarPantalla('screenSeleccionTest');
    // ‚úÖ AGREGAR ESTO AL FINAL:
  // Esperar a que el DOM se actualice y luego preseleccionar
  setTimeout(() => {
    preseleccionarTestContratado();
  }, 300);
}
    
         // Mostrar bot√≥n para iniciar test despu√©s de activar plan
function mostrarBotonIniciarTest(testNombre) {
  try {
    const screen = document.getElementById('screenSeleccionTest');
    if (!screen) return;

    const logo = screen.querySelector('.logo');
    if (!logo) return;

    let btnExistente = document.getElementById('btnIniciarTestActivado');
    let infoExistente = document.getElementById('infoTestActivado');
    if (btnExistente) btnExistente.remove();
    if (infoExistente) infoExistente.remove();

    const btn = document.createElement('button');
    btn.id = 'btnIniciarTestActivado';
    btn.className = 'btn btn-success';
    btn.style.marginTop = '12px';
    btn.textContent = `üöÄ Iniciar Test`;

    btn.onclick = function() {
      categoriaActual = testSeleccionado;
      iniciarTest();
    };

    const infoCategoria = document.createElement('div');
    infoCategoria.id = 'infoTestActivado';
    infoCategoria.style.cssText = `
      background: var(--premium-bg);
      border: 2px solid var(--premium-border);
      border-radius: 12px;
      padding: 16px 20px;
      margin-top: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(255, 215, 0, 0.15);
    `;

    infoCategoria.innerHTML = `
      <div class="test-card-info">
        <h4 style="color: var(--premium); font-size: 16px; margin-bottom: 4px; font-weight: 600;">
          ${testNombre}
        </h4>
        <p style="color: var(--muted); font-size: 13px;">
          Test activo y listo para usar
        </p>
      </div>
      <span style="background: var(--premium); color: #1f2937; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; white-space: nowrap;">
        üëë Activo
      </span>
    `;

    logo.parentNode.insertBefore(btn, logo.nextSibling);
    logo.parentNode.insertBefore(infoCategoria, btn.nextSibling);

  } catch (e) {
    console.error('Error mostrando bot√≥n iniciar test:', e);
  }
}
    
    // ---------------------- BOT√ìN DE ACCESO TOTAL PARA TESTER ----------------------
    function renderTestAccessButtonIfTester() {
      try {
        const testerEmail = 'carlos.itim@gmail.com';
        if (!usuarioActual || usuarioActual.email !== testerEmail) {
          const existing = document.getElementById('btnAccesoTotalTester');
          if (existing) existing.remove();
          return;
        }

        const screen = document.getElementById('screenSeleccionTest');
        if (!screen) return;

        const userInfo = screen.querySelector('.user-info');
        if (!userInfo) return;

        let btn = document.getElementById('btnAccesoTotalTester');
        if (btn) return;

        btn = document.createElement('button');
        btn.id = 'btnAccesoTotalTester';
        btn.className = 'btn btn-success';
        btn.style.marginTop = '12px';
        btn.textContent = 'üîì Acceso total de prueba (tester)';

        btn.onclick = async function () {
          // Si hay test seleccionado, otorgar acceso a ese test y arrancarlo
          const testSelect = document.getElementById('testSelect');
          const testId = testSelect ? testSelect.value : '';
          if (!testId) {
            alert('Selecciona primero un test en el selector para otorgar acceso de prueba.');
            return;
          }

          const testNombre = testSelect.options[testSelect.selectedIndex]?.text || testId;
          const sub = {
            plan: 'mensual',
            tandasUsadas: 0,
            fechaActivacion: Date.now(),
            nombre: testNombre
          };

          // Actualizar estado local
          suscripcionesUsuario = suscripcionesUsuario || {};
          suscripcionesUsuario[testId] = sub;

          // Intentar guardar en Firestore para persistencia (opcional)
          try {
            if (typeof db !== 'undefined' && db.collection && usuarioActual && usuarioActual.uid) {
              await db.collection('suscripciones').doc(usuarioActual.uid).set({
                [testId]: sub
              }, { merge: true });
              console.log('üìå Suscripci√≥n de prueba guardada en Firestore para', usuarioActual.uid);
            }
          } catch (err) {
            console.warn('No se pudo guardar suscripci√≥n en Firestore (puede que no tenga permisos):', err);
          }

          // Actualizar UI
          mostrarTestsContratados();

          // Iniciar test inmediatamente
          alert(`‚úÖ Acceso total otorgado para el test "${testNombre}".\n\nIniciando el test ahora...`);
          try {
            categoriaActual = testId;
            iniciarTest();
          } catch (err) {
            console.error('Error iniciando test tras otorgar acceso:', err);
            alert('Ocurri√≥ un error iniciando el test. Puedes iniciar desde Acceso r√°pido.');
          }
        };

        userInfo.parentNode.insertBefore(btn, userInfo.nextSibling);
      } catch (e) {
        console.error('Error renderizando bot√≥n tester:', e);
      }
    }
    // -------------------------------------------------------------------------------

    // Mostrar tests contratados como accesos r√°pidos
   function mostrarTestsContratados() {
  // Mostrar en pantalla de login
  actualizarTestsContratados('testsContratados', 'testsContratadosList', '‚ö° Acceso r√°pido a tus tests');
  // Mostrar en pantalla de selecci√≥n
  actualizarTestsContratados('testsContratadosSeleccion', 'testsContratadosSeleccionList', 'üëë Tus Tests Activos');
}

function actualizarTestsContratados(containerId, listId, titulo) {
  const container = document.getElementById(containerId);
  const list = document.getElementById(listId);
  
  if (!container || !list) return;

  const testsActivos = Object.entries(suscripcionesUsuario || {}).filter(([_, data]) => {
    return data && data.plan && data.plan !== 'none';
  });

  if (testsActivos.length === 0) {
    container.style.display = 'none';
    return;
  }

  container.style.display = 'block';
  const h3 = container.querySelector('h3');
  if (h3) h3.textContent = titulo;
  
  list.innerHTML = testsActivos.map(([testId, data]) => {
    const planIcon = data.plan === 'gratuito' ? 'üéÅ' : 
                    data.plan === 'mensual' ? 'üìÖ' : 
                    data.plan === 'trimestral' ? 'üî•' : 'üëë';
    const planText = data.plan === 'gratuito' ? 'Gratis' : 
                    data.plan === 'mensual' ? 'Mensual' : 
                    data.plan === 'trimestral' ? 'Trimestral' : 'Anual';
    const tandasInfo = data.plan === 'gratuito' ? 
      `${data.tandasUsadas || 0}/${TANDAS_GRATUITAS} tandas usadas` : 
      'Acceso ilimitado';

    return `
      <div class="test-card-quick ${data.plan === 'gratuito' ? '' : 'premium'}" onclick="accederTestDirecto('${testId}')">
        <div class="test-card-info">
          <h4>${data.nombre || testId}</h4>
          <p>${tandasInfo}</p>
        </div>
        <span class="test-badge ${data.plan === 'gratuito' ? 'gratuito' : 'premium'}">
          ${planIcon} ${planText}
        </span>
      </div>
    `;
  }).join('');
}

    // Acceder directamente a un test contratado
   async function accederTestDirecto(testId) {
  // ‚úÖ EXCEPCI√ìN PARA DESARROLLADOR - Acceso total sin restricciones
  if (usuarioActual && usuarioActual.email === 'carlos.itim@gmail.com') {
    console.log('üîß Acceso de desarrollador - saltando verificaciones');
    categoriaActual = testId;
    iniciarTest();
    return;
  }
  
  // ‚úÖ VERIFICACIONES DE SEGURIDAD PARA USUARIOS NORMALES
  const suscripcion = suscripcionesUsuario[testId];
  
  // Verificar que tenga suscripci√≥n v√°lida para ESTE test espec√≠fico
  if (!suscripcion || !suscripcion.plan || suscripcion.plan === 'none') {
    alert('üö´ No tienes acceso a este test. Debes activar un plan primero.');
    testSeleccionado = testId;
    document.getElementById('testSelect').value = testId;
    mostrarPlanes();
    mostrarPantalla('screenSeleccionTest');
    return;
  }
  
  // Si tiene plan gratuito, verificar l√≠mite de tandas
  if (suscripcion.plan === 'gratuito' && suscripcion.tandasUsadas >= TANDAS_GRATUITAS) {
    alert(`‚ö†Ô∏è Has alcanzado el l√≠mite de ${TANDAS_GRATUITAS} tandas gratuitas.\n\nActualiza tu plan para continuar con acceso ilimitado.`);
    testSeleccionado = testId;
    document.getElementById('testSelect').value = testId;
    mostrarPlanes();
    mostrarPantalla('screenSeleccionTest');
    return;
  }

  // Acceso permitido
  categoriaActual = testId;
  iniciarTest();
}// mostrarPlanes actualizado: marca el plan activo con "‚úÖ Ya activado" 
// y bloquea todos los inferiores con overlay (gratuito incluido se muestra igual si es activo)
function mostrarPlanes() {
  const testSelect = document.getElementById('testSelect');
  const planesContainer = document.getElementById('planesContainer');
  if (!testSelect || !planesContainer) return;

  const testId = testSelect.value;
  if (!testId) {
    planesContainer.classList.remove('show');
    return;
  }

  testSeleccionado = testId;
  planesContainer.classList.add('show');

  // Jerarqu√≠a de planes (de menor a mayor)
  const planOrder = ['gratuito', 'mensual', 'trimestral', 'anual'];

  // Obtener plan activo para este test (si existe)
  const sub = suscripcionesUsuario && suscripcionesUsuario[testId] ? suscripcionesUsuario[testId] : null;
  const activePlan = sub && sub.plan ? String(sub.plan).toLowerCase() : null;
  const activeIndex = activePlan ? planOrder.indexOf(activePlan) : -1;

  // Limpiar estado visual de todas las tarjetas
  document.querySelectorAll('.plan-card').forEach(card => {
    card.classList.remove('selected', 'disabled', 'disabled-by-superior', 'active-plan');
    card.style.opacity = '';
    card.style.pointerEvents = '';
    card.style.filter = '';
    card.style.boxShadow = '';
    // eliminar overlays o badges previos
    const overlays = card.querySelectorAll('.ya-activado, .blocked-overlay');
    overlays.forEach(o => o.remove());
  });

  // Recorrer tarjetas y aplicar bloqueo seg√∫n jerarqu√≠a
  document.querySelectorAll('.plan-card').forEach(card => {
    // Determinar key del plan de la tarjeta
    let cardPlan = null;
    if (card.dataset && card.dataset.plan) {
      cardPlan = String(card.dataset.plan).toLowerCase();
    } else if (card.id) {
      const m = card.id.match(/^plan(.+)$/i);
      if (m && m[1]) {
        // Ej: planMensual -> mensual ; plangratuito -> gratuito
        cardPlan = m[1].charAt(0).toLowerCase() + m[1].slice(1);
        cardPlan = cardPlan.toLowerCase();
      }
    }
    if (!cardPlan) return;

    const idx = planOrder.indexOf(cardPlan);

    // Si existe un plan activo, bloquear todos los de menor √≠ndice
    if (activeIndex >= 0 && idx >= 0) {
      if (idx < activeIndex) {
        // Plan inferior -> bloquear
        card.classList.add('disabled-by-superior');
        card.style.opacity = '0.45';
        card.style.pointerEvents = 'none';
        card.style.filter = 'grayscale(1)';

        if (!card.querySelector('.blocked-overlay')) {
          const ov = document.createElement('div');
          ov.className = 'blocked-overlay';
          ov.style.cssText = 'position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; background:rgba(0,0,0,0.5); pointer-events:none; z-index:12; border-radius:12px;';
          ov.textContent = 'üîí Bloqueado por plan activo';
          card.style.position = card.style.position || 'relative';
          card.appendChild(ov);
        }
      } else if (idx === activeIndex) {
        // Plan activo -> marcar con badge "Ya activado" (aplica tambi√©n a gratuito)
        card.classList.add('disabled', 'active-plan');
        card.style.opacity = '0.5';
        card.style.pointerEvents = 'none';
        card.style.filter = 'grayscale(1)';

        if (!card.querySelector('.ya-activado')) {
          const badge = document.createElement('div');
          badge.className = 'ya-activado';
          badge.style.cssText = 'position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.75); color:#fff; padding:6px 8px; border-radius:12px; font-weight:700; z-index:13; font-size:12px;';
          badge.textContent = '‚úÖ Ya activado';
          card.style.position = card.style.position || 'relative';
          card.appendChild(badge);
        }
      } else {
        // Plan superior -> dejar habilitado
        card.style.pointerEvents = 'auto';
      }
    } else {
      // No hay suscripci√≥n activa -> todos habilitados
      card.style.pointerEvents = 'auto';
    }
  });
}

// seleccionarPlan actualizado: previene selecci√≥n si la tarjeta est√° bloqueada;
// mantiene el mensaje y comportamiento igual; gratuito muestra badge igual al resto si ya est√° activo
function seleccionarPlan(plan) {
  if (!plan) return;
  const planLower = String(plan).toLowerCase();

  // Buscar la tarjeta: primero por data-plan, luego por id / sufijo
  let planCard = document.querySelector(`.plan-card[data-plan="${planLower}"]`) || null;

  if (!planCard) {
    // Buscar por id con sufijo (case-insensitive)
    const all = Array.from(document.querySelectorAll('.plan-card'));
    planCard = all.find(card => {
      if (card.id) {
        const m = card.id.match(/^plan(.+)$/i);
        if (m && m[1]) {
          const derived = m[1].charAt(0).toLowerCase() + m[1].slice(1);
          return derived.toLowerCase() === planLower;
        }
      }
      // fallback: comprobar dataset.plan con normalizaci√≥n
      if (card.dataset && card.dataset.plan) {
        return String(card.dataset.plan).toLowerCase() === planLower;
      }
      return false;
    }) || null;
  }

  // Si la tarjeta est√° bloqueada por plan superior o ya activada => impedir selecci√≥n
  if (planCard && (planCard.classList.contains('disabled-by-superior') || planCard.classList.contains('disabled'))) {
    alert('üîí Este plan est√° bloqueado porque ya tienes un plan superior activo o ya est√° activado.\n\nPara cambiar de plan, primero cancela la suscripci√≥n actual.');
    return;
  }

  // Excepci√≥n: si intentan activar gratuito cuando ya lo tienen
  if (planLower === 'gratuito' && suscripcionesUsuario[testSeleccionado] && suscripcionesUsuario[testSeleccionado].plan === 'gratuito') {
    alert('‚úÖ Ya tienes el plan gratuito activado.\n\nSelecciona un plan superior para hacer upgrade.');
    return;
  }

  if (!testSeleccionado) {
    alert('‚ö†Ô∏è Selecciona un test primero');
    return;
  }

  // Limpiar estilo previo
  document.querySelectorAll('.plan-card').forEach(card => {
    card.classList.remove('selected');
    card.style.transform = 'translateY(0) scale(1)';
    card.style.borderColor = 'var(--border)';
    card.style.boxShadow = 'none';
  });

  // Aplicar estilo de preselecci√≥n
  if (planCard) {
    planCard.classList.add('selected');
    planCard.style.transform = 'translateY(-4px) scale(1.02)';
    planCard.style.borderColor = 'var(--accent)';
    planCard.style.boxShadow = '0 12px 32px rgba(52,195,255,0.18)';
  }

  // Info de los planes (texto usado en confirm)
  const planesInfo = {
    gratuito: { nombre: 'Plan Gratuito', precio: 'Gratis', descripcion: '2 tandas de prueba' },
    mensual: { nombre: 'Plan Mensual', precio: '9,99‚Ç¨/mes', descripcion: 'Acceso ilimitado' },
    trimestral: { nombre: 'Plan Trimestral', precio: '24,99‚Ç¨/3 meses', descripcion: 'Ahorra 25%' },
    anual: { nombre: 'Plan Anual', precio: '79,99‚Ç¨/a√±o', descripcion: 'Ahorra 33%' }
  };

  const planInfo = planesInfo[planLower] || { nombre: plan, precio: '-', descripcion: '' };
  const select = document.getElementById('testSelect');
  const testNombre = select && select.options[select.selectedIndex] ? select.options[select.selectedIndex].text : (testSeleccionado || '');

  let confirmMsg;
  if (planLower === 'gratuito') {
    confirmMsg = `üéÅ ¬øConfirmas la activaci√≥n?\n\n` +
      `üìö Test: ${testNombre}\n` +
      `üí≥ Plan: ${planInfo.nombre}\n` +
      `üí∞ Precio: ${planInfo.precio}\n` +
      `üìã Incluye: ${planInfo.descripcion}\n\n` +
      `‚úÖ ¬øActivar acceso gratuito?`;
  } else {
    confirmMsg = `üí≥ ¬øConfirmas la contrataci√≥n?\n\n` +
      `üìö Test: ${testNombre}\n` +
      `üí≥ Plan: ${planInfo.nombre}\n` +
      `üí∞ Precio: ${planInfo.precio}\n` +
      `üìã Incluye: ${planInfo.descripcion}\n\n` +
      `üöÄ ¬øProceder al pago?`;
  }

  if (confirm(confirmMsg)) {
    planSeleccionado = planLower;
    if (planLower === 'gratuito') {
      activarPlanGratuito();
    } else {
      procesarPagoStripe();
    }
  } else {
    // cancelar selecci√≥n visual si el usuario no confirma
    if (planCard) {
      planCard.classList.remove('selected');
      planCard.style.transform = '';
      planCard.style.borderColor = '';
      planCard.style.boxShadow = '';
    }
    planSeleccionado = null;
  }
}

   // Activar plan gratuito (sin pago)
async function activarPlanGratuito() {
  try {
    const testNombre = document.getElementById('testSelect').options[document.getElementById('testSelect').selectedIndex].text;

    await db.collection('suscripciones').doc(usuarioActual.uid).set({
        email: usuarioActual.email, // ‚úÖ A√ëADIR ESTO
      [testSeleccionado]: {
        plan: 'gratuito',
        tandasUsadas: 0,
        fechaActivacion: Date.now(),
        nombre: testNombre
      }
    }, { merge: true });

    suscripcionesUsuario[testSeleccionado] = {
      plan: 'gratuito',
      tandasUsadas: 0,
      nombre: testNombre
    };

    alert(`‚úÖ ¬°Plan gratuito activado!\n\nTienes ${TANDAS_GRATUITAS} tandas de prueba para el test: ${testNombre}`);

    // ‚ùå NO LIMPIAR SELECCI√ìN INMEDIATAMENTE
    // document.getElementById('planesContainer').classList.remove('show');
    // document.getElementById('testSelect').value = '';
    // planSeleccionado = null;
    // testSeleccionado = null;

    // ‚úÖ MOSTRAR BOT√ìN INICIAR TEST
  //  mostrarBotonIniciarTest(testNombre);

    // Actualizar accesos r√°pidos
    mostrarTestsContratados();

  } catch (error) {
    console.error('‚ùå Error activando plan gratuito:', error);
    alert('‚ùå Error al activar el plan. Int√©ntalo de nuevo.');
  }
}

   async function procesarPagoStripe() {
     // ‚úÖ VERIFICAR QUE FUNCTIONS EST√â DISPONIBLE
  if (!functions) {
    alert('‚ùå Error: Sistema de pagos no disponible. Recarga la p√°gina e int√©ntalo de nuevo.');
    console.error('Functions no est√° inicializado');
    return;
  }
  if (!testSeleccionado || !planSeleccionado) {
    alert('Selecciona un test y un plan primero');
    return;
  }

  try {
    const testNombre = document.getElementById('testSelect').options[document.getElementById('testSelect').selectedIndex].text;
    const priceId = STRIPE_PRICES[planSeleccionado];
    
    if (!priceId) {
      throw new Error('Plan no configurado correctamente');
    }

    console.log('üöÄ Iniciando pago:', { testNombre, planSeleccionado, priceId });

    // ‚úÖ L√çNEA CORREGIDA - usar 'functions' en lugar de 'firebase.functions()'
    console.log('üîß Verificando functions:', typeof functions);
const crearSesionCheckout = functions.httpsCallable('crearCheckoutSession');   
    const result = await crearSesionCheckout({
      priceId: priceId,
      testId: testSeleccionado,
      testNombre: testNombre
    });

    console.log('‚úÖ Sesi√≥n creada:', result.data);

    // Redirigir a Stripe Checkout
    const checkoutResult = await stripe.redirectToCheckout({
      sessionId: result.data.sessionId
    });

    if (checkoutResult.error) {
      throw new Error(checkoutResult.error.message);
    }

  } catch (error) {
    console.error('‚ùå Error procesando pago:', error);
    alert('Error al procesar el pago: ' + error.message);
  }
}
    // Verificar si puede usar el test (l√≠mite de tandas)
    function verificarLimiteTandas() {
      if (!categoriaActual || !suscripcionesUsuario[categoriaActual]) {
        return true; // No hay restricci√≥n si no hay suscripci√≥n
      }

      const sub = suscripcionesUsuario[categoriaActual];

      if (sub.plan === 'gratuito') {
        if (sub.tandasUsadas >= TANDAS_GRATUITAS) {
          alert(`‚ö†Ô∏è Has alcanzado el l√≠mite de ${TANDAS_GRATUITAS} tandas gratuitas.\n\nActualiza tu plan para continuar.`);
          return false;
        }
      }

      return true;
    }

    // Incrementar contador de tandas usadas
    async function incrementarTandaUsada() {
      if (!categoriaActual || !suscripcionesUsuario[categoriaActual]) {
        return;
      }

      const sub = suscripcionesUsuario[categoriaActual];

      if (sub.plan === 'gratuito') {
        sub.tandasUsadas = (sub.tandasUsadas || 0) + 1;

        try {
          await db.collection('suscripciones').doc(usuarioActual.uid).set({
              email: usuarioActual.email, // ‚úÖ A√ëADIR ESTO
            [categoriaActual]: sub
          }, { merge: true });

          console.log(`üìä Tandas usadas: ${sub.tandasUsadas}/${TANDAS_GRATUITAS}`);

          if (sub.tandasUsadas >= TANDAS_GRATUITAS) {
            alert(`‚ö†Ô∏è Has completado tus ${TANDAS_GRATUITAS} tandas gratuitas.\n\nPara continuar, actualiza a un plan de pago con acceso ilimitado.`);
          }
        } catch (error) {
          console.error('Error actualizando tandas:', error);
        }
      }
    }

    // Modificar hideErrorMessage para soportar m√∫ltiples contenedores
    function hideErrorMessage(elementId = 'errorMessage') {
      const errorDiv = document.getElementById(elementId);
      if (errorDiv) {
        errorDiv.classList.remove('show');
      }
    }

    // Modificar showErrorMessage para soportar m√∫ltiples contenedores
    function showErrorMessage(message, elementId = 'errorMessage') {
      const errorDiv = document.getElementById(elementId);
      if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.classList.add('show');
        setTimeout(() => hideErrorMessage(elementId), 5000);
      }
    }
// Verificar si el usuario tiene acceso al test espec√≠fico
function verificarAccesoTest(testId) {
  if (!usuarioActual || !testId) {
    return { acceso: false, motivo: 'Usuario o test no v√°lido' };
  }

  // Verificar si tiene suscripci√≥n para este test espec√≠fico
  const suscripcion = suscripcionesUsuario[testId];
  
  if (!suscripcion || !suscripcion.plan || suscripcion.plan === 'none') {
    return { acceso: false, motivo: 'No tienes acceso a este test' };
  }

  // Verificar l√≠mites del plan gratuito
  if (suscripcion.plan === 'gratuito' && suscripcion.tandasUsadas >= TANDAS_GRATUITAS) {
    return { acceso: false, motivo: 'Has agotado tus tandas gratuitas para este test' };
  }

  return { acceso: true, motivo: 'Acceso v√°lido' };
}
    // ==================== NUEVO SISTEMA DE TANDAS SECUENCIALES ====================

    // Funci√≥n principal para iniciar el test con el nuevo sistema
    function iniciarTest() {
      console.log('üöÄ Iniciando test con nuevo sistema de tandas para categor√≠a:', categoriaActual);
  
  // ‚úÖ A√ëADIR VERIFICACI√ìN DE SEGURIDAD
  const verificacion = verificarAccesoTest(categoriaActual);
  if (!verificacion.acceso) {
    alert(`üö´ Acceso denegado: ${verificacion.motivo}`);
    volverCategorias();
    return;
  }
      mostrarPantalla('screenTest');

      // Ocultar panel de planes
      const planesContainer = document.getElementById('planesContainer');
      if (planesContainer) planesContainer.classList.remove('show');

      // Reiniciar variables del nuevo sistema
      masterPool = [];
      preguntasPendientes = [];
      preguntasCompletadas = [];
      preguntasFalladas = [];
      tandaActual = [];
      indicePreguntaActual = 0;
      respuestasUsuario = [];
      numeroTanda = 0;
      preguntasRealizadasGlobal = 0;
      aciertosGlobal = 0;
      esTandaRepeticion = false;
      inicioTestTimestamp = Date.now();

      // Verificar l√≠mite de tandas
      if (!verificarLimiteTandas()) {
        volverCategorias();
        return;
      }

      // Cargar preguntas desde Firebase
      cargarPreguntasDesdeFirebase();
    }

    // Cargar preguntas desde Firebase
    function cargarPreguntasDesdeFirebase() {
      db.collection('categorias').doc(categoriaActual).get()
        .then((doc) => {
          if (!doc.exists) {
            throw new Error('Categor√≠a no encontrada');
          }

          const categoriaData = doc.data();
          document.getElementById('testCategoriaNombre').textContent = categoriaData.nombre;
          preguntasPorTanda = categoriaData.preguntasPorTanda || 30;
          totalPreguntas = categoriaData.totalPreguntas || 0;

          return db.collection('preguntas')
            .where('categoria', '==', categoriaActual)
            .where('activa', '==', true)
            .get();
        })
        .then(async (querySnapshot) => {
          console.log('‚úÖ Preguntas recibidas:', querySnapshot.size);

          if(querySnapshot.empty) {
            alert('No se encontraron preguntas para esta categor√≠a');
            volverCategorias();
            return;
          }

          // Cargar todas las preguntas al masterPool
          masterPool = [];
          querySnapshot.forEach((doc, idx) => {
            const data = { id: doc.id, ...doc.data() };
            masterPool.push(data);
          });
          // üé≤ BARAJAR todas las preguntas al inicio del test
masterPool = mezclarArray(masterPool);

          // Inicializar preguntasPendientes con todas las preguntas del masterPool
          preguntasPendientes = [...masterPool];
          preguntasCompletadas = [];
          preguntasFalladas = [];

          console.log(`üìä Sistema inicializado: ${masterPool.length} preguntas en masterPool`);

          // Cargar progreso si existe
          const progreso = await cargarProgresoSiExiste();
          if (progreso) {
            const quiereContinuar = confirm('Se ha encontrado progreso guardado. ¬øDeseas continuar donde lo dejaste?');
            if (quiereContinuar) {
              aplicarProgresoCargado(progreso);
              // Si hay tanda actual, mostrar la pregunta actual
              if (tandaActual && tandaActual.length > 0) {
                mostrarPregunta();
                return;
              }
            } else {
              // Si no quiere continuar, eliminar progreso
              eliminarProgreso();
              // Restablecer preguntasPendientes
              preguntasPendientes = [...masterPool];
            }
          }

          // Iniciar primera tanda
          prepararNuevaTanda();
        })
        .catch((error) => {
          console.error('‚ùå Error cargando preguntas:', error);
          alert('Error al cargar preguntas: ' + error.message);
          volverCategorias();
        });
    }

    // Preparar una nueva tanda secuencial
    function prepararNuevaTanda() {
      console.log('üîÑ Preparando nueva tanda secuencial...');
      // ‚úÖ VERIFICAR L√çMITE DE TANDAS GRATUITAS ANTES DE CONTINUAR
  if (!verificarLimiteTandas()) {
    // Si no puede usar m√°s tandas, mostrar mensaje y salir
    alert(`üö´ Has alcanzado el l√≠mite de ${TANDAS_GRATUITAS} tandas gratuitas.\n\nActualiza tu plan para continuar.`);
    volverCategorias();
    return;
  }
      // Ocultar panel de opciones de tanda
      const panel = document.getElementById('tandaOptions');
      if (panel) panel.style.display = 'none';
      
      const feedback = document.getElementById('feedbackContainer');
      if (feedback) feedback.style.display = 'none';

      // Determinar si es tanda normal o de repetici√≥n
      if (preguntasFalladas.length > 0 && !esTandaRepeticion) {
        // Hay fallos pendientes -> preparar tanda de repetici√≥n
        prepararTandaRepeticion();
        return;
      }

      // Tanda normal: tomar preguntas NUEVAS del pool pendiente
      esTandaRepeticion = false;
      numeroTanda++;
      
      // Calcular rango de preguntas para esta tanda
      const inicio = (numeroTanda - 1) * preguntasPorTanda;
      const fin = Math.min(inicio + preguntasPorTanda, preguntasPendientes.length);
      
      if (inicio >= preguntasPendientes.length) {
        // No hay m√°s preguntas nuevas
        if (preguntasFalladas.length > 0) {
          // Pero hay fallos pendientes -> preparar tanda de repetici√≥n
          prepararTandaRepeticion();
          return;
        } else {
          // No hay m√°s preguntas ni fallos -> test completado
          finalizarTest();
          return;
        }
      }

      // Tomar el bloque de preguntas para esta tanda
      tandaActual = preguntasPendientes.slice(inicio, fin);
      
      // Inicializar respuestas
      respuestasUsuario = new Array(tandaActual.length).fill(null);
      indicePreguntaActual = 0;

      console.log(`üî¢ Tanda #${numeroTanda}: ${tandaActual.length} preguntas nuevas (${inicio}-${fin-1})`);
      
      // Incrementar contador de tandas para planes gratuitos
      incrementarTandaUsada();
      
      guardarProgreso();
      restoreStatsPreference();
      mostrarPregunta();
    }

    // Preparar tanda de repetici√≥n (solo fallos)
    function prepararTandaRepeticion() {
      console.log('üîÑ Preparando tanda de repetici√≥n de fallos...');
      
      esTandaRepeticion = true;
      
      // Tomar TODOS los fallos para la repetici√≥n
      tandaActual = preguntasFalladas.map(p => ({...p}));
      
      // Inicializar respuestas
      respuestasUsuario = new Array(tandaActual.length).fill(null);
      indicePreguntaActual = 0;

      console.log(`üîÅ Tanda de repetici√≥n: ${tandaActual.length} preguntas falladas`);
      
      guardarProgreso();
      mostrarPregunta();
    }

    // Funci√≥n para mostrar la pregunta actual
    function mostrarPregunta() {
      const pregunta = tandaActual[indicePreguntaActual];
      const total = tandaActual.length;

      if (!pregunta) {
        console.warn('No hay pregunta en el √≠ndice actual');
        return;
      }

      // Asegurar que tenemos el mapeo de opciones
      if (!pregunta._displayOptions || !pregunta._displayToOriginal) {
        generarOpcionesMostradas(pregunta);
      }

      // Actualizar UI
      const tipoTanda = esTandaRepeticion ? 'Repetici√≥n' : `Tanda ${numeroTanda}`;
      document.getElementById('preguntaNumero').textContent = 
        `Pregunta ${indicePreguntaActual + 1} de ${total} (${tipoTanda})`;

      const progreso = ((indicePreguntaActual + 1) / total) * 100;
      const progressBarContainer = document.querySelector('.progress-bar');
      if (CONFIG.mostrarProgresoTanda) {
        if (progressBarContainer) progressBarContainer.style.display = 'block';
        document.getElementById('progressBar').style.width = progreso + '%';
      } else {
        if (progressBarContainer) progressBarContainer.style.display = 'none';
      }

document.getElementById('preguntaTexto').textContent = `${pregunta.id}: ${pregunta.pregunta || ''}`;

      // Generar opciones
      const letras = ['A', 'B', 'C', 'D'];
      let opcionesHtml = '';

      const displayOptions = pregunta._displayOptions || {};
      const displayToOriginal = pregunta._displayToOriginal || {};

      const yaRespondida = respuestasUsuario[indicePreguntaActual] !== null;
      const respuestaConfirmadaOriginal = respuestasUsuario[indicePreguntaActual];

      letras.forEach((letra) => {
        const textoOpcion = displayOptions[letra];
        if (!textoOpcion) return;

        const originalKeyParaEstaOpcion = displayToOriginal[letra];
        let clases = '';

        if (yaRespondida) {
          // marcar correcta/incorrecta y selected seg√∫n respuesta confirmada
          if (originalKeyParaEstaOpcion === pregunta.respuestaCorrecta) clases += ' correcta';
          if (originalKeyParaEstaOpcion === respuestaConfirmadaOriginal) {
            clases += ' selected';
            if (originalKeyParaEstaOpcion !== pregunta.respuestaCorrecta) clases += ' incorrecta';
          }
          opcionesHtml += `
            <div class="opcion ${clases.trim()}" aria-disabled="true">
              <div class="opcion-letra">${letra}</div>
              <div class="opcion-texto">${textoOpcion}</div>
            </div>
          `;
        } else {
          // no respondida: permitir click
          opcionesHtml += `
            <div class="opcion ${clases.trim()}" onclick="seleccionarOpcion('${letra}')">
              <div class="opcion-letra">${letra}</div>
              <div class="opcion-texto">${textoOpcion}</div>
            </div>
          `;
        }
      });

      document.getElementById('opcionesContainer').innerHTML = opcionesHtml;

      // Ocultar feedback
      const fb = document.getElementById('feedbackContainer');
      if (fb) fb.style.display = 'none';

      // Control de botones de navegaci√≥n
      actualizarBotonesNavegacion();

      // Mostrar estad√≠sticas en tiempo real
      mostrarStatsEnTiempoReal();
    }

    // Actualizar estado de los botones de navegaci√≥n
    function actualizarBotonesNavegacion() {
    const btnAnterior = document.getElementById('btnAnterior');
    const btnSiguiente = document.getElementById('btnSiguiente');
    const btnFinalizar = document.getElementById('btnFinalizar');

    // Control del bot√≥n anterior
    if (indicePreguntaActual > 0) {
        btnAnterior.style.display = 'flex';
    } else {
        btnAnterior.style.display = 'none';
    }

    // Control de botones Siguiente/Finalizar
    const tieneRespuesta = respuestasUsuario[indicePreguntaActual] !== null;
    const esUltimaPregunta = indicePreguntaActual === tandaActual.length - 1;
    
    // SOLUCI√ìN: El bot√≥n "Finalizar" solo debe aparecer cuando realmente es el FINAL del test completo
    // No cuando es solo el final de una tanda
    const esFinalDelTestCompleto = esUltimaPregunta && 
        preguntasPendientes.length === 0 && 
        preguntasFalladas.length === 0;
    
    if (!esUltimaPregunta) {
        // No es la √∫ltima pregunta de la tanda
        btnSiguiente.style.display = 'flex';
        btnFinalizar.style.display = 'none';
        btnSiguiente.disabled = !tieneRespuesta;
    } else {
        // Es la √∫ltima pregunta de la tanda
        if (esFinalDelTestCompleto) {
            // Es realmente el FINAL del test completo
            btnSiguiente.style.display = 'none';
            btnFinalizar.style.display = 'flex';
            btnFinalizar.disabled = !tieneRespuesta;
        } else {
            // Es solo el final de una tanda, pero hay m√°s preguntas o fallos
            btnSiguiente.style.display = 'flex';
            btnFinalizar.style.display = 'none';
            btnSiguiente.disabled = !tieneRespuesta;
            // Cambiar el texto del bot√≥n para indicar "Terminar tanda"
            btnSiguiente.innerHTML = '‚Üí';
        }
    }
}

    // Funci√≥n para seleccionar una opci√≥n
        // Funci√≥n para seleccionar una opci√≥n
    let autoAdvanceTimeout = null;

    function seleccionarOpcion(displayLetter) {
      // Cancelar auto-advance si exist√≠a
      if (autoAdvanceTimeout) {
        clearTimeout(autoAdvanceTimeout);
        autoAdvanceTimeout = null;
      }

      const pregunta = tandaActual[indicePreguntaActual];
      if (!pregunta) return;

      // Asegurar mapping
      if (!pregunta._displayToOriginal) generarOpcionesMostradas(pregunta);
      const displayToOriginal = pregunta._displayToOriginal || {};
      const originalLetter = displayToOriginal[displayLetter];
      if (!originalLetter) {
        console.warn('Mapping de opci√≥n no encontrado para', displayLetter);
        return;
      }

      // Si ya hubo respuesta confirmada para esta pregunta, ignorar clicks
      if (respuestasUsuario[indicePreguntaActual] !== null) {
        return;
      }

           // Primer intento: guardar respuesta como letra ORIGINAL
      respuestasUsuario[indicePreguntaActual] = originalLetter;
      
      // SOLO CONTAR EN TANDAS NORMALES, NO EN REPETICI√ìN
      if (!esTandaRepeticion) {
        preguntasRealizadasGlobal++;
      }

      const correcto = pregunta.respuestaCorrecta;
      const ahoraEsCorrecta = originalLetter === correcto;

     // Actualizar estad√≠sticas
if (ahoraEsCorrecta) {
  // CONTAR ACIERTOS EN AMBOS CASOS (tandas normales Y de repetici√≥n)
  aciertosGlobal++;
  
  // En tandas de repetici√≥n: quitar de fallados si se corrige
  if (esTandaRepeticion) {
    const idxFallada = preguntasFalladas.findIndex(p => p.id === pregunta.id);
    if (idxFallada !== -1) {
      preguntasFalladas.splice(idxFallada, 1);
    }
  } else {
    // En tandas normales: mover a completadas
    if (!preguntasCompletadas.find(p => p.id === pregunta.id)) {
      preguntasCompletadas.push(pregunta);
    }
    // Quitar de fallados si estaba
    const idxFallada = preguntasFalladas.findIndex(p => p.id === pregunta.id);
    if (idxFallada !== -1) {
      preguntasFalladas.splice(idxFallada, 1);
    }
  }
} else {
  // Agregar a fallados si no estaba ya (SOLO EN TANDAS NORMALES)
  if (!esTandaRepeticion) {
    if (!preguntasFalladas.find(p => p.id === pregunta.id)) {
      preguntasFalladas.push(pregunta);
    }
  }
  // En tandas de repetici√≥n: la pregunta YA est√° en falladas, no hacer nada
}
      // Actualizar visual
      document.querySelectorAll('.opcion').forEach(el => el.classList.remove('selected', 'correcta', 'incorrecta'));
      const opcionesEls = Array.from(document.querySelectorAll('.opcion'));
      opcionesEls.forEach(el => {
        const letraOpcion = el.querySelector('.opcion-letra').textContent;
        const orig = pregunta._displayToOriginal ? pregunta._displayToOriginal[letraOpcion] : letraOpcion;
        if (orig === correcto) {
          el.classList.add('correcta');
        }
        if (orig === originalLetter) {
          el.classList.add('selected');
          if (!ahoraEsCorrecta) el.classList.add('incorrecta');
        }
        el.style.cursor = 'default';
      });

      // Habilitar botones de navegaci√≥n
      actualizarBotonesNavegacion();
      mostrarStatsEnTiempoReal();
      
      // Guardar progreso
      guardarProgreso();

      // Si fue correcta en primer intento -> esperar 1s y auto-avanzar
      if (ahoraEsCorrecta) {
        autoAdvanceTimeout = setTimeout(() => {
          autoAdvanceTimeout = null;
          siguientePregunta();
        }, 1000);
      }
    }
    // Funci√≥n para navegar a la siguiente pregunta
function siguientePregunta() {
    // Guardar progreso antes de avanzar
    guardarProgreso();
    
    // Cancelar timeout si existiera
    if (autoAdvanceTimeout) {
        clearTimeout(autoAdvanceTimeout);
        autoAdvanceTimeout = null;
    }

    // Si no hay respuesta confirmada en esta pregunta, no avanzar
    const tieneRespuesta = respuestasUsuario[indicePreguntaActual] !== null;
    if (!tieneRespuesta) {
        const fb = document.getElementById('feedbackContainer');
        if (fb) {
            fb.style.display = 'block';
            fb.innerHTML = `<div class="alert alert-info">Debes responder la pregunta antes de avanzar.</div>`;
            setTimeout(() => { if (fb) fb.style.display = 'none'; }, 1200);
        }
        return;
    }

    // Avanzar
    if (indicePreguntaActual < tandaActual.length - 1) {
        indicePreguntaActual++;
        mostrarPregunta();
    } else {
        // Si era la √∫ltima pregunta de la tanda
        finalizarTanda();
    }
}
    // Funci√≥n para navegar a la pregunta anterior
    function preguntaAnterior() {
      // Limpiar timeout si existe
      if (autoAdvanceTimeout) {
        clearTimeout(autoAdvanceTimeout);
        autoAdvanceTimeout = null;
      }

      if (indicePreguntaActual > 0) {
        indicePreguntaActual--;
        mostrarPregunta();
      }
    }

    // Finalizar la tanda actual
    function finalizarTanda() {
    console.log('üèÅ Finalizando tanda actual...');
    
    // Guardar progreso
    guardarProgreso();
    forceShowStats();

    let correctas = 0;
    let incorrectas = 0;

    // Contar respuestas correctas e incorrectas
    respuestasUsuario.forEach((respuesta, index) => {
        const pregunta = tandaActual[index];
        if (!pregunta) return;
        if (respuesta === pregunta.respuestaCorrecta) {
            correctas++;
        } else if (respuesta !== null) {
            incorrectas++;
        }
    });

    const feedback = document.getElementById('feedbackContainer');
    feedback.style.display = 'block';
    
    // VERIFICAR SI ES EL FINAL DEL TEST COMPLETO
    const esFinalDelTestCompleto = preguntasPendientes.length === 0 && preguntasFalladas.length === 0;
    
    if (esFinalDelTestCompleto) {
        // Realmente es el final del test completo
        feedback.innerHTML = `
            <div class="alert alert-success">
                <strong>¬°Test completado!</strong> Has terminado todas las preguntas y corregido todos los fallos.
            </div>
        `;
        
        setTimeout(() => {
            finalizarTest();
        }, 1500);
        return;
    }
    
    if (esTandaRepeticion) {
        // Tanda de repetici√≥n
        if (preguntasFalladas.length === 0) {
            // ¬°Todos los fallos corregidos!
            feedback.innerHTML = `
                <div class="alert alert-success">
                    <strong>¬°Excelente!</strong> Has corregido todos los fallos. 
                    ${preguntasPendientes.length > 0 ? 'Continuando con la siguiente tanda...' : 'Test completado.'}
                </div>
            `;
            
            setTimeout(() => {
                if (preguntasPendientes.length > 0) {
                    prepararNuevaTanda();
                } else {
                    finalizarTest();
                }
            }, 2000);
        } else {
            // A√∫n hay fallos pendientes
            feedback.innerHTML = `
                <div class="alert alert-info">
                    <strong>Tanda de repetici√≥n finalizada:</strong> ${correctas} correctas, ${incorrectas} incorrectas.
                    A√∫n tienes ${preguntasFalladas.length} fallos por corregir.
                </div>
            `;
            
            // Mostrar opciones para repetir o continuar
            const panel = document.getElementById('tandaOptions');
            if (panel) {
                panel.style.display = 'flex';
                document.getElementById('btnRepetirFallos').textContent = `üîÅ Repetir Fallos (${preguntasFalladas.length})`;
            }
        }
    } else {
        // Tanda normal
        feedback.innerHTML = `
            <div class="alert alert-info">
                <strong>Tanda ${numeroTanda} finalizada:</strong> ${correctas} correctas, ${incorrectas} incorrectas.
            </div>
        `;

        // Verificar si hay fallos para repetir
        if (preguntasFalladas.length > 0) {
            // Hay fallos -> mostrar opci√≥n para repetir
            const panel = document.getElementById('tandaOptions');
            if (panel) {
                panel.style.display = 'flex';
                document.getElementById('btnRepetirFallos').textContent = `üîÅ Repetir Fallos (${preguntasFalladas.length})`;
            }
        } else {
            // No hay fallos -> continuar autom√°ticamente
            setTimeout(() => {
                prepararNuevaTanda();
            }, 1500);
        }
    }
}
    // Repetir los fallos (llamado desde el bot√≥n)
    function repetirFallos() {
      if (preguntasFalladas.length === 0) return;
      
      const panel = document.getElementById('tandaOptions');
      if (panel) panel.style.display = 'none';
      
      const feedback = document.getElementById('feedbackContainer');
      if (feedback) feedback.style.display = 'none';

      // Preparar tanda de repetici√≥n
      prepararTandaRepeticion();
    }

    // Saltar tanda (continuar sin repetir fallos)
    function saltarTanda() {
      // ‚úÖ VERIFICAR L√çMITE ANTES DE SALTAR
  if (!verificarLimiteTandas()) {
    alert(`üö´ Has alcanzado el l√≠mite de ${TANDAS_GRATUITAS} tandas gratuitas.\n\nActualiza tu plan para continuar.`);
    volverCategorias();
    return;
  }
      const panel = document.getElementById('tandaOptions');
           if (panel) panel.style.display = 'none';
      
      const feedback = document.getElementById('feedbackContainer');
      if (feedback) feedback.style.display = 'none';

      // Continuar con siguiente tanda normal
      prepararNuevaTanda();
    }

    // Finalizar el test completo
    function finalizarTest() {
      console.log('üéâ Test completado!');
      
      const totalMaster = masterPool.length;
      const totalRealizadas = preguntasRealizadasGlobal;
      const correctas = aciertosGlobal;
      const incorrectas = Math.max(0, totalRealizadas - correctas);
      const fallosRestantes = preguntasFalladas.length;

      const duracionSegundos = inicioTestTimestamp ? Math.round((Date.now() - inicioTestTimestamp) / 1000) : null;
      const porcentaje = totalMaster > 0 ? Math.round((correctas / totalMaster) * 100) : 0;

      const resultado = {
        usuarioId: (usuarioActual && usuarioActual.uid) ? usuarioActual.uid : null,
        categoria: categoriaActual || null,
        fecha: Date.now(),
        totalPreguntas: totalMaster,
        realizadas: totalRealizadas,
        correctas,
        incorrectas,
        fallosRestantes,
        porcentajeAcierto: porcentaje,
        duracionSegundos,
        numeroTanda,
        sistema: 'tandas-secuenciales-v2'
      };

      guardarProgreso();
      guardarResultadoFinal(resultado);

      // Actualizar UI de resultados
      document.getElementById('resultadoPorcentaje').textContent = porcentaje + '%';
      document.getElementById('resultadoCorrectas').textContent = correctas;
      document.getElementById('resultadoIncorrectas').textContent = incorrectas;
      document.getElementById('resultadoTotal').textContent = totalMaster;

      // Cargar estad√≠sticas
      obtenerEstadisticasUsuario().then(stats => {
        mostrarEstadisticasDetalladas(stats, correctas, incorrectas, totalMaster, porcentaje || 0);
      });

      mostrarPantalla('screenResultado');

      console.log('‚úÖ Resultado final guardado:', resultado);
    }

    // ==================== FUNCIONES AUXILIARES ====================

    // Mezclar array
    function mezclarArray(array) {
      const newArray = [...array];
      for (let i = newArray.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
      }
      return newArray;
    }

    // Generar opciones mezcladas para mostrar
    function generarOpcionesMostradas(pregunta) {
      if (!pregunta || !pregunta.opciones) return;

      const entries = Object.entries(pregunta.opciones);
      if (entries.length <= 1) return;

      // Mezclar el array de pares [clave, texto]
      const arr = entries.map(([key, text]) => ({ originalKey: key, text }));
      const shuffled = mezclarArray(arr);

      const letras = ['A', 'B', 'C', 'D'];
      const displayOptions = {};
      const displayToOriginal = {};

      for (let i = 0; i < shuffled.length && i < letras.length; i++) {
        const letra = letras[i];
        displayOptions[letra] = shuffled[i].text;
        displayToOriginal[letra] = shuffled[i].originalKey;
      }

      // Guardar temporalmente en la pregunta
      pregunta._displayOptions = displayOptions;
      pregunta._displayToOriginal = displayToOriginal;
    }

    // Mostrar estad√≠sticas en tiempo real
    function mostrarStatsEnTiempoReal() {
      const respondidas = respuestasUsuario.filter(r => r !== null).length;
      const totalTanda = tandaActual.length || 1;
      const progreso = Math.round((respondidas / totalTanda) * 100);

      let correctasTemp = 0;
      let incorrectasTemp = 0;
      respuestasUsuario.forEach((resp, idx) => {
        if(resp !== null) {
          if(resp && tandaActual[idx] && resp === tandaActual[idx].respuestaCorrecta) {
            correctasTemp++;
          } else {
            incorrectasTemp++;
          }
        }
      });

      const preguntasRealizadasTotal = preguntasRealizadasGlobal || 0;
      const restantesGlobal = Math.max(0, masterPool.length - preguntasRealizadasTotal);

      let statsPanel = document.getElementById('statsRealTime');
      if(!statsPanel) {
        statsPanel = document.createElement('div');
        statsPanel.id = 'statsRealTime';
        document.querySelector('.pregunta-container').insertBefore(
          statsPanel, 
          document.querySelector('.pregunta-header')
        );
      }

      const bloques = [];

      // ACIERTOS (Verde)
      bloques.push(`
        <div style="text-align: center;">
          <div style="color: var(--muted); font-size: 12px;">Aciertos</div>
          <div style="color: var(--success); font-size: 20px; font-weight: 700;">${aciertosGlobal || 0}</div>
        </div>
      `);

      // FALLOS (Rojo)
      bloques.push(`
        <div style="text-align: center;">
          <div style="color: var(--muted); font-size: 12px;">Fallos</div>
          <div style="color: var(--danger); font-size: 20px; font-weight: 700;">${(preguntasRealizadasTotal - (aciertosGlobal || 0))}</div>
        </div>
      `);

      // RESTANTES (Azul/Accent)
      bloques.push(`
        <div style="text-align: center;">
          <div style="color: var(--muted); font-size: 12px;">Restantes</div>
          <div style="color: var(--accent); font-size: 20px; font-weight: 700;">${restantesGlobal}</div>
        </div>
      `);

      statsPanel.innerHTML = bloques.join('\n');

      const isVisible = document.getElementById('statsSwitch').classList.contains('active');
      if (!isVisible) {
        statsPanel.classList.add('hidden');
      } else {
        statsPanel.classList.remove('hidden');
      }
    }

    // ==================== GUARDADO Y CARGA DE PROGRESO ====================

    // Funci√≥n principal de guardado
    function guardarProgresoEnNube() {
      if (!usuarioActual || !categoriaActual) {
        console.log('‚ùå No hay usuario o categor√≠a para guardar progreso');
        return;
      }

      try {
        const estado = {
          // Nuevo sistema de tandas
          masterPoolIds: masterPool.map(p => p.id || null),
          preguntasPendientesIds: preguntasPendientes.map(p => p.id || null),
          preguntasCompletadasIds: preguntasCompletadas.map(p => p.id || null),
          preguntasFalladasIds: preguntasFalladas.map(p => p.id || null),
          tandaActualIds: tandaActual.map(p => p.id || null),
          respuestasUsuario: respuestasUsuario || [],
          indicePreguntaActual: indicePreguntaActual || 0,
          numeroTanda: numeroTanda || 0,
          esTandaRepeticion: esTandaRepeticion || false,
          
          // Estad√≠sticas
          preguntasPorTanda: preguntasPorTanda || 30,
          preguntasRealizadasGlobal: preguntasRealizadasGlobal || 0,
          aciertosGlobal: aciertosGlobal || 0,
          
          // Metadata
          timestamp: Date.now(),
          usuarioId: usuarioActual.uid,
          categoria: categoriaActual,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          sistema: 'tandas-secuenciales-v2'
        };

        const docId = `${usuarioActual.uid}_${categoriaActual}`;
        
        db.collection('progresos').doc(docId).set(estado, { merge: true })
        .then(() => {
          console.log('üíæ Progreso guardado en Firestore correctamente');
        })
        .catch(err => {
          console.error('‚ùå Error guardando progreso:', err);
        });
      } catch (e) {
        console.error('‚ùå Error en guardarProgresoEnNube:', e);
      }
    }

    // Funci√≥n principal de guardado
    function guardarProgreso() {
      console.log('üíæ Guardando progreso...');
      guardarProgresoEnNube();
    }

    // Cargar progreso desde Firestore
    async function cargarProgresoSiExiste() {
      if (!usuarioActual || !categoriaActual) return null;

      try {
        const docId = `${usuarioActual.uid}_${categoriaActual}`;
        const doc = await db.collection('progresos').doc(docId).get();

        if (doc.exists) {
          const estado = doc.data();
          console.log('üì• Progreso cargado desde Firestore:', estado);
          return estado;
        }
        
        console.log('üì≠ No hay progreso guardado');
        return null;
      } catch (e) {
        console.error('‚ùå Error leyendo progreso:', e);
        return null;
      }
    }

    // Aplicar progreso cargado
    function aplicarProgresoCargado(progreso) {
      if (!progreso) return;

      console.log('üîÅ Aplicando progreso cargado:', progreso);

      // Reconstruir arrays de preguntas desde IDs
      const idToQuestion = {};
      masterPool.forEach(p => idToQuestion[p.id] = p);

      if (progreso.preguntasPendientesIds) {
        preguntasPendientes = progreso.preguntasPendientesIds.map(id => idToQuestion[id]).filter(Boolean);
      }
      
      if (progreso.preguntasCompletadasIds) {
        preguntasCompletadas = progreso.preguntasCompletadasIds.map(id => idToQuestion[id]).filter(Boolean);
      }
      
      if (progreso.preguntasFalladasIds) {
        preguntasFalladas = progreso.preguntasFalladasIds.map(id => idToQuestion[id]).filter(Boolean);
      }
      
      if (progreso.tandaActualIds) {
        tandaActual = progreso.tandaActualIds.map(id => idToQuestion[id]).filter(Boolean);
      }

      // Restaurar estado
      respuestasUsuario = progreso.respuestasUsuario || [];
      indicePreguntaActual = progreso.indicePreguntaActual || 0;
      numeroTanda = progreso.numeroTanda || 0;
      esTandaRepeticion = progreso.esTandaRepeticion || false;
      
      preguntasRealizadasGlobal = progreso.preguntasRealizadasGlobal || 0;
      aciertosGlobal = progreso.aciertosGlobal || 0;

      console.log('‚úÖ Progreso aplicado:', { 
        indicePreguntaActual, 
        numeroTanda,
        esTandaRepeticion,
        tandaActual: tandaActual.length,
        preguntasPendientes: preguntasPendientes.length,
        preguntasFalladas: preguntasFalladas.length
      });
    }

    // Eliminar progreso
    function eliminarProgreso() {
      if (!usuarioActual || !categoriaActual) return;

      try {
        const docId = `${usuarioActual.uid}_${categoriaActual}`;
        db.collection('progresos').doc(docId).delete()
        .then(() => {
          console.log('üóëÔ∏è Progreso eliminado');
        }).catch(err => {
          console.error('‚ùå Error eliminando progreso:', err);
        });
      } catch (e) {
        console.error('‚ùå Error en eliminarProgreso:', e);
      }
    }

    // ==================== FUNCIONES EXISTENTES (MANTENIDAS) ====================

    function guardarResultadoFinal(resultado) {
      try {
        const key = `resultados_${resultado.usuarioId || 'anon'}_${resultado.categoria || 'general'}`;
        let lista = [];
        const raw = localStorage.getItem(key);
        if (raw) {
          lista = JSON.parse(raw);
          if (!Array.isArray(lista)) lista = [];
        }
        lista.push(resultado);
        localStorage.setItem(key, JSON.stringify(lista));
      } catch (e) {
        console.warn('No se pudo guardar resultado en localStorage:', e);
      }

      try {
        if (typeof db !== 'undefined' && db.collection) {
          db.collection('resultados').add({
            ...resultado,
            savedAt: firebase.firestore.FieldValue.serverTimestamp()
          }).then(() => {
            console.log('Resultado guardado en Firestore');
          }).catch(err => {
            console.warn('No se pudo guardar resultado en Firestore:', err);
          });
        }
      } catch (e) {
        console.warn('Error guardando resultado en Firestore:', e);
      }
    }

    function obtenerEstadisticasUsuario() {
      return db.collection('resultados')
        .where('usuarioId', '==', usuarioActual.uid)
        .where('categoria', '==', categoriaActual)
        .orderBy('fecha', 'desc')
        .limit(10)
        .get()
        .then((querySnapshot) => {
          const resultados = [];
          querySnapshot.forEach(doc => {
            resultados.push(doc.data());
          });

          if (resultados.length === 0) {
            return {
              success: false,
              message: 'No hay resultados previos'
            };
          }

          const porcentajes = resultados.map(r => r.porcentajeAcierto || r.porcentaje || 0);
          const promedio = Math.round(porcentajes.reduce((a, b) => a + b, 0) / porcentajes.length);
          const mejor = Math.max(...porcentajes);
          const peor = Math.min(...porcentajes);
          const ultimos5 = porcentajes.slice(0, 5);

          return {
            success: true,
            promedio: promedio,
            mejor: mejor,
            peor: peor,
            intentos: resultados.length,
            ultimos5: ultimos5,
            totalResultados: resultados.length
          };
        })
        .catch((error) => {
          console.error('Error obteniendo estad√≠sticas:', error);
          return {
            success: false,
            error: error.message
          };
        });
    }

    function mostrarEstadisticasDetalladas(stats, correctas, incorrectas, total, porcentaje) {
      if(!stats || !stats.success) {
        document.getElementById('statsBody').innerHTML = `
          <div class="alert alert-info">
            <span>‚ÑπÔ∏è</span>
            <span>No hay estad√≠sticas disponibles todav√≠a</span>
          </div>
        `;
        return;
      }

      let statsHtml = '';

      statsHtml += `
        <div class="stats-section">
          <div class="stats-section-title">
            <span>üìã</span>
            <span>Resumen del Test Actual</span>
          </div>
          <div class="stats-grid">
            <div class="stats-mini-card">
              <div class="mini-label">Aciertos</div>
              <div class="mini-value" style="color: var(--success);">${correctas}</div>
            </div>
            <div class="stats-mini-card">
              <div class="mini-label">Errores</div>
              <div class="mini-value" style="color: var(--danger);">${incorrectas}</div>
            </div>
            <div class="stats-mini-card">
              <div class="mini-label">Porcentaje</div>
              <div class="mini-value">${porcentaje}%</div>
            </div>
            <div class="stats-mini-card">
              <div class="mini-label">Total</div>
              <div class="mini-value">${total}</div>
            </div>
          </div>
        </div>
      `;

      statsHtml += `
        <div class="stats-section">
          <div class="stats-section-title">
            <span>üìà</span>
            <span>Estad√≠sticas Hist√≥ricas</span>
          </div>
          <div class="stats-row">
            <span class="stats-label">Promedio en esta categor√≠a</span>
            <span class="stats-value ${getColorClass(stats.promedio || 0)}">${stats.promedio || 0}%</span>
          </div>
          <div class="stats-row">
            <span class="stats-label">Mejor resultado obtenido</span>
            <span class="stats-value success">${stats.mejor || 0}%</span>
          </div>
          <div class="stats-row">
            <span class="stats-label">Peor resultado obtenido</span>
            <span class="stats-value danger">${stats.peor || 0}%</span>
          </div>
          <div class="stats-row">
            <span class="stats-label">Total de intentos realizados</span>
            <span class="stats-value">${stats.intentos || 1}</span>
          </div>
        </div>
      `;

      if(stats.ultimos5 && stats.ultimos5.length > 0) {
        const promedioReciente = Math.round(stats.ultimos5.reduce((a, b) => a + b, 0) / stats.ultimos5.length);
        const tendencia = calcularTendencia(stats.ultimos5);

        statsHtml += `
          <div class="stats-section">
            <div class="stats-section-title">
              <span>üìä</span>
              <span>Evoluci√≥n Reciente</span>
            </div>
            <div class="stats-row">
              <span class="stats-label">Promedio √∫ltimos ${stats.ultimos5.length} tests</span>
              <span class="stats-value">${promedioReciente}%</span>
            </div>
            <div class="stats-row">
              <span class="stats-label">Tendencia</span>
              <span class="stats-value">${tendencia.icono} ${tendencia.texto}</span>
            </div>
            <div class="stats-row">
              <span class="stats-label">√öltimos resultados</span>
              <span class="stats-value">${stats.ultimos5.join('%, ')}%</span>
            </div>
            <div class="progress-bar-mini">
              <div class="fill" style="width: ${promedioReciente}%"></div>
            </div>
          </div>
        `;
      }

      const tasaAcierto = Math.round((correctas / total) * 100);
      const rendimiento = getRendimiento(tasaAcierto);

      statsHtml += `
        <div class="stats-section">
          <div class="stats-section-title">
            <span>üéØ</span>
            <span>An√°lisis de Rendimiento</span>
          </div>
          <div class="stats-row">
            <span class="stats-label">Tasa de acierto</span>
            <span class="stats-value ${getColorClass(tasaAcierto)}">${tasaAcierto}%</span>
          </div>
          <div class="stats-row">
            <span class="stats-label">Evaluaci√≥n</span>
            <span class="stats-value">${rendimiento.icono} ${rendimiento.texto}</span>
          </div>
          <div class="stats-row">
            <span class="stats-label">Preguntas acertadas</span>
            <span class="stats-value success">${correctas} de ${total}</span>
          </div>
          <div class="stats-row">
            <span class="stats-label">Preguntas falladas</span>
            <span class="stats-value danger">${incorrectas} de ${total}</span>
          </div>
        </div>
      `;

      if(stats.promedio && stats.promedio > 0) {
        const diferencia = porcentaje - stats.promedio;
        const comparativa = diferencia >= 0 ? 
          { icono: 'üìà', texto: `+${diferencia.toFixed(1)}% sobre tu promedio`, color: 'success' } :
          { icono: 'üìâ', texto: `${diferencia.toFixed(1)}% bajo tu promedio`, color: 'danger' };

        statsHtml += `
          <div class="stats-section">
            <div class="stats-section-title">
              <span>‚öñÔ∏è</span>
              <span>Comparativa</span>
            </div>
            <div class="stats-row">
              <span class="stats-label">Respecto a tu promedio</span>
              <span class="stats-value ${comparativa.color}">${comparativa.icono} ${comparativa.texto}</span>
            </div>
            <div class="stats-row">
              <span class="stats-label">Respecto a tu mejor resultado</span>
              <span class="stats-value">${porcentaje >= stats.mejor ? 'üèÜ ¬°Nuevo r√©cord!' : `${stats.mejor - porcentaje}% por debajo`}</span>
            </div>
          </div>
        `;
      }

      document.getElementById('statsBody').innerHTML = statsHtml;
    }

    function getColorClass(porcentaje) {
      if(porcentaje >= 80) return 'success';
      if(porcentaje >= 60) return '';
      return 'danger';
    }

    function calcularTendencia(ultimos) {
      if(ultimos.length < 2) return { icono: '‚û°Ô∏è', texto: 'Sin datos suficientes' };

      const mitad = Math.floor(ultimos.length / 2);
      const primeraMedia = ultimos.slice(0, mitad).reduce((a, b) => a + b, 0) / mitad;
      const segundaMedia = ultimos.slice(mitad).reduce((a, b) => a + b, 0) / (ultimos.length - mitad);

      const diferencia = segundaMedia - primeraMedia;

      if(diferencia > 5) return { icono: 'üìà', texto: 'Mejorando' };
      if(diferencia < -5) return { icono: 'üìâ', texto: 'Descendiendo' };
      return { icono: '‚û°Ô∏è', texto: 'Estable' };
    }

    function getRendimiento(porcentaje) {
      if(porcentaje >= 90) return { icono: 'üèÜ', texto: 'Excelente' };
      if(porcentaje >= 80) return { icono: '‚≠ê', texto: 'Muy Bueno' };
      if(porcentaje >= 70) return { icono: 'üëç', texto: 'Bueno' };
      if(porcentaje >= 60) return { icono: 'üìö', texto: 'Aceptable' };
      return { icono: 'üìñ', texto: 'Necesita mejorar' };
    }

    function nuevoTest() {
      iniciarTest();
    }

    function consultarChatGPT() {
      const pregunta = encodeURIComponent('Tengo dudas sobre el test que acabo de realizar. ¬øPuedes ayudarme a entender mejor los conceptos?');
      window.open('https://chat.openai.com/?q=' + pregunta, '_blank');
    }

    function toggleStats() {
      const content = document.getElementById('statsContent');
      const icon = document.getElementById('statsIcon');

      if(content.classList.contains('open')) {
        content.classList.remove('open');
        icon.classList.remove('open');
      } else {
        content.classList.add('open');
        icon.classList.add('open');
      }
    }

    function volverCategorias() {
      try {
        // Guardar progreso antes de salir
        guardarProgreso();
        
        // Cancelar cualquier auto-advance en curso
        if (typeof autoAdvanceTimeout !== 'undefined' && autoAdvanceTimeout) {
          clearTimeout(autoAdvanceTimeout);
          autoAdvanceTimeout = null;
        }

        // Si hay una tanda en curso, confirmar salida
        if (tandaActual && tandaActual.length > 0) {
          const confirmado = confirm('¬øDeseas volver al men√∫ principal? Se guardar√° tu progreso y podr√°s continuar despu√©s.');
          if (!confirmado) return;
        }

        // Limpiar estado temporal del test
        tandaActual = [];
        indicePreguntaActual = 0;
        respuestasUsuario = [];
        numeroTanda = 0;

        // Mostrar pantalla de selecci√≥n
        mostrarPantalla('screenSeleccionTest');

        // Asegurarse de que el panel de planes no quede abierto
        const planesContainer = document.getElementById('planesContainer');
        if (planesContainer) planesContainer.classList.remove('show');

        // Forzar refresco de lista de tests contratados
        try {
          if (usuarioActual && document.getElementById('userEmailSeleccion')) {
            document.getElementById('userEmailSeleccion').textContent = usuarioActual.email || '';
          }
          mostrarTestsContratados();
        } catch(e) { /* no cr√≠tico */ }

        console.log('Navegando al men√∫ principal');
      } catch (err) {
        console.error('Error en volverCategorias():', err);
        try { mostrarPantalla('screenSeleccionTest'); } catch(e){/* ignore */ }
      }
    }

    function explicarPreguntaConChatGPT() {
  const pregunta = tandaActual[indicePreguntaActual];
  if (!pregunta) return;

  let texto = `Tengo la siguiente pregunta tipo test:\n\n"${pregunta.pregunta}"\n\n`;
  texto += "Opciones:\n";

  // ‚úÖ USAR LAS OPCIONES COMO SE MUESTRAN AL USUARIO
  if (pregunta._displayOptions) {
    // Usar las opciones mezcladas que ve el usuario
    Object.entries(pregunta._displayOptions).forEach(([letra, opcion]) => {
      texto += `- ${letra}: ${opcion}\n`;
    });
    
    // ‚úÖ ENCONTRAR LA LETRA CORRECTA COMO SE MUESTRA AL USUARIO
    const displayToOriginal = pregunta._displayToOriginal || {};
    let respuestaCorrectaMostrada = 'A'; // fallback
    
    for (const [displayLetter, originalLetter] of Object.entries(displayToOriginal)) {
      if (originalLetter === pregunta.respuestaCorrecta) {
        respuestaCorrectaMostrada = displayLetter;
        break;
      }
    }
    
    texto += `\nLa respuesta correcta es: ${respuestaCorrectaMostrada}\n\n`;
  } else {
    // Fallback: usar opciones originales si no hay mezcladas
    if (pregunta.opciones) {
      Object.entries(pregunta.opciones).forEach(([letra, opcion]) => {
        texto += `- ${letra}: ${opcion}\n`;
      });
    }
    texto += `\nLa respuesta correcta es: ${pregunta.respuestaCorrecta}\n\n`;
  }

  texto += "¬øMe puedes explicar por qu√© esa es la opci√≥n correcta?";

  const encoded = encodeURIComponent(texto);
  window.open(`https://chat.openai.com/?q=${encoded}`, '_blank');
}
    
    // ==================== NAVEGACI√ìN ENTRE PANTALLAS ====================
    function irALoginEmail() {
      mostrarPantalla('screenEmailLogin');
    }

    function volverLoginPrincipal() {
      mostrarPantalla('screenLogin');
    }

    // ==================== ON AUTH STATE ====================
    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        console.log('‚úÖ Usuario autenticado:', user.email);
        usuarioActual = {
          uid: user.uid,
          email: user.email,
          displayName: user.displayName || user.email
        };
        crearPerfilUsuario();
        cargarSuscripcionesUsuario();
      } else {
        console.log('Usuario no autenticado');
        suscripcionesUsuario = {};
        mostrarPantalla('screenLogin');
      }
    });

    window.onload = function() {
  console.log('üîÑ P√°gina cargada, inicializando...');
  loadSavedTheme();
  loadStatsPreference();

  // ========== VERIFICAR PAGO AL VOLVER DE STRIPE ==========
  const urlParams = new URLSearchParams(window.location.search);
  const paymentStatus = urlParams.get('payment');
  const sessionId = urlParams.get('session_id');
  
  if (paymentStatus === 'success' && sessionId) {
    verificarPagoStripe(sessionId);
  } else if (paymentStatus === 'cancelled') {
    alert('‚ùå Pago cancelado.');
    window.history.replaceState({}, document.title, window.location.pathname);
  }
  // ======================================================

  window.addEventListener('beforeunload', function() {
    guardarProgreso();
  });
};

// ========== FUNCI√ìN VERIFICAR PAGO ==========
async function verificarPagoStripe(sessionId) {
  try {
    const loadingDiv = document.createElement('div');
    loadingDiv.style.cssText = `
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8); z-index: 99999;
      display: flex; align-items: center; justify-content: center;
      flex-direction: column; gap: 20px;
    `;
    loadingDiv.innerHTML = `
      <div class="spinner" style="width: 50px; height: 50px;"></div>
      <p style="color: white; font-size: 18px;">Verificando tu pago...</p>
    `;
    document.body.appendChild(loadingDiv);
    
    const verificarPago = firebase.functions().httpsCallable('verificarPago');
    const resultado = await verificarPago({ sessionId: sessionId });
    
    document.body.removeChild(loadingDiv);
    
    if (resultado.data.success) {
      await cargarSuscripcionesUsuario();
      
      alert(`üéâ ¬°Pago exitoso!\n\n` +
            `Plan: ${resultado.data.plan}\n` +
            `Categor√≠a: ${resultado.data.categoria}\n\n` +
            `Ya puedes usar tus tests ilimitados.`);
      
      window.history.replaceState({}, document.title, window.location.pathname);
    }
    
  } catch (error) {
    console.error('Error verificando pago:', error);
    alert('‚ö†Ô∏è Hubo un problema verificando tu pago.\n\nContacta con soporte.');
    window.history.replaceState({}, document.title, window.location.pathname);
  }
}
  </script>
</body>
</html>
