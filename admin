<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Admin 0.11f - MultiTest</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #0f1113;
      color: #e9eef2;
      padding: 20px;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    h1 { color: #34c3ff; margin-bottom: 10px; font-size: 32px; }
    .subtitle { color: #aab3b8; margin-bottom: 30px; }
    .card {
      background: #1f2225;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .card h2 { color: #34c3ff; margin-bottom: 15px; font-size: 20px; }
    button {
      background: #34c3ff;
      color: #000;
      border: none;
      padding: 12px 24px;
      font-size: 15px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      margin: 5px;
      transition: all 0.3s ease;
    }
    button:hover { background: #2ab3e8; transform: translateY(-2px); }
    button:disabled { background: #555; cursor: not-allowed; transform: none; }
    button.danger { background: #b22222; color: white; }
    button.success { background: #2e8b57; color: white; }
    button.warning { background: #ffc107; color: #000; }
    button.premium { background: linear-gradient(135deg, #FFD700, #FFA500); color: #1f2937; }
    button.secondary { background: #555; color: white; }
    
    .log {
      background: #26292d;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }
    .log-item {
      padding: 8px;
      margin: 5px 0;
      border-radius: 4px;
      border-left: 3px solid #34c3ff;
    }
    .log-item.success {
      background: rgba(46, 139, 87, 0.1);
      border-left-color: #2e8b57;
      color: #5dff9a;
    }
    .log-item.error {
      background: rgba(178, 34, 34, 0.1);
      border-left-color: #b22222;
      color: #ff6b6b;
    }
    .log-item.warning {
      background: rgba(255, 193, 7, 0.1);
      border-left-color: #ffc107;
      color: #ffd54f;
    }
    .log-item.info {
      background: rgba(52, 195, 255, 0.1);
      border-left-color: #34c3ff;
      color: #34c3ff;
    }
    
    .user-info {
      background: rgba(52, 195, 255, 0.1);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid rgba(52, 195, 255, 0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .user-info .email { color: #34c3ff; font-weight: 600; }
    
    textarea {
      width: 100%;
      min-height: 300px;
      background: #26292d;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 15px;
      color: #e9eef2;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      resize: vertical;
      margin: 10px 0;
    }
    textarea:focus { outline: none; border-color: #34c3ff; }
    
    input[type="text"], input[type="number"], input[type="email"], select {
      width: 100%;
      padding: 12px;
      background: #26292d;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      color: #e9eef2;
      font-size: 15px;
      margin: 8px 0;
    }
    input:focus, select:focus { outline: none; border-color: #34c3ff; }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .stat-box {
      background: #26292d;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .stat-box .number {
      font-size: 36px;
      font-weight: 700;
      color: #34c3ff;
      margin-bottom: 5px;
    }
    .stat-box .label { color: #aab3b8; font-size: 14px; }
    .stat-box.premium .number { color: #FFD700; }
    .stat-box.mensual .number { color: #2e8b57; }
    .stat-box.trimestral .number { color: #ffc107; }
    .stat-box.anual .number { color: #FFD700; }
    
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid rgba(255,255,255,0.1);
    }
    .tab {
      padding: 12px 24px;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      color: #aab3b8;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
      margin: 0;
      border-radius: 0;
    }
    .tab:hover { color: #34c3ff; transform: none; }
    .tab.active { color: #34c3ff; border-bottom-color: #34c3ff; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      overflow-y: auto;
    }
    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-content {
      background: #1f2225;
      border-radius: 12px;
      padding: 30px;
      max-width: 700px;
      width: 100%;
      border: 1px solid rgba(255,255,255,0.1);
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .modal-header h3 { color: #34c3ff; font-size: 22px; }
    .modal-close {
      background: transparent;
      color: #aab3b8;
      font-size: 28px;
      padding: 0;
      margin: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border-radius: 4px;
    }
    .modal-close:hover { background: rgba(255,255,255,0.1); color: #fff; }
    
    .list-item {
      background: #26292d;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      border: 1px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .list-item:hover { border-color: #34c3ff; }
    .list-item.bloqueado {
      border-left: 4px solid #b22222;
      opacity: 0.7;
    }
    .list-item .info { flex: 1; }
    .list-item .nombre {
      color: #34c3ff;
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 5px;
    }
    .list-item .detalles { color: #aab3b8; font-size: 13px; }
    .list-item .acciones { display: flex; gap: 5px; flex-wrap: wrap; }
    .btn-small { padding: 6px 12px; font-size: 13px; }
    
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }
    .badge.gratuito { background: rgba(52, 195, 255, 0.2); color: #34c3ff; }
    .badge.mensual { background: rgba(46, 139, 87, 0.2); color: #2e8b57; }
    .badge.trimestral { background: rgba(255, 193, 7, 0.2); color: #ffc107; }
    .badge.anual { background: rgba(255, 215, 0, 0.2); color: #FFD700; }
    .badge.oculta { background: rgba(178, 34, 34, 0.2); color: #ff6b6b; }
    .badge.archivada { background: rgba(128, 128, 128, 0.2); color: #aaa; }
    .badge.activa { background: rgba(46, 139, 87, 0.2); color: #5dff9a; }
    .badge.bloqueado { background: rgba(178, 34, 34, 0.3); color: #ff6b6b; }
    
    .info-box {
      background: rgba(52, 195, 255, 0.1);
      border: 1px solid rgba(52, 195, 255, 0.3);
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      color: #34c3ff;
    }
    .form-group { margin-bottom: 15px; }
    .form-group label {
      display: block;
      color: #34c3ff;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .form-group small {
      display: block;
      color: #aab3b8;
      font-size: 13px;
      margin-top: 5px;
    }
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 15px 0;
    }
    .checkbox-group input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    .checkbox-group label {
      color: #e9eef2;
      cursor: pointer;
      margin: 0;
    }
    .list-item.dragging {
      opacity: 0.5;
      cursor: move;
    }
    .list-item[draggable="true"] {
      cursor: move;
    }
    .drag-handle {
      color: #aab3b8;
      font-size: 20px;
      margin-right: 10px;
      cursor: move;
    }
    .cat-stats-box {
      background: #26292d;
      border-radius: 8px;
      padding: 20px;
      margin: 15px 0;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .cat-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .cat-stat-item {
      text-align: center;
    }
    .cat-stat-item .label {
      color: #aab3b8;
      font-size: 13px;
      margin-bottom: 5px;
    }
    .cat-stat-item .value {
      color: #34c3ff;
      font-size: 24px;
      font-weight: 700;
    }
    .cat-stat-item.premium .value {
      color: #FFD700;
    }
    .file-upload-btn {
      display: inline-block;
      padding: 10px 20px;
      background: #2e8b57;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      margin-bottom: 15px;
    }
    .file-upload-btn:hover {
      background: #25724a;
    }
    .cache-indicator {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      background: rgba(46, 139, 87, 0.2);
      color: #5dff9a;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîß Panel Admin - MultiTest</h1>
    <p class="subtitle">Gesti√≥n completa del sistema (Optimizado)</p>
    <div id="userInfo" class="user-info" style="display:none;">
      <div>
        <div style="font-size: 14px; color: #aab3b8; margin-bottom: 5px;">Admin:</div>
        <div class="email" id="userEmail"></div>
      </div>
      <button onclick="cerrarSesion()">Cerrar sesi√≥n</button>
    </div>
    <div id="loginCard" class="card">
      <h2>üîê Iniciar Sesi√≥n</h2>
      <button onclick="iniciarSesion()">Entrar con Google</button>
    </div>
    <div id="adminPanel" style="display:none;">
      <div class="tabs">
        <button class="tab active" onclick="cambiarTab('categorias')">üìö Categor√≠as</button>
        <button class="tab" onclick="cambiarTab('preguntas')">‚ùì Preguntas</button>
        <button class="tab" onclick="cambiarTab('usuarios')">üë• Usuarios</button>
        <button class="tab" onclick="cambiarTab('stats')">üìä Stats</button>
      </div>
      <!-- TAB CATEGOR√çAS -->
      <div id="tabCategorias" class="tab-content active">
        <div class="card">
          <h2>üìö Gesti√≥n de Categor√≠as</h2>
          <div class="stats">
            <div class="stat-box">
              <div class="number" id="catCount">0</div>
              <div class="label">Total</div>
            </div>
            <div class="stat-box">
              <div class="number" id="catActivas">0</div>
              <div class="label">Activas</div>
            </div>
            <div class="stat-box">
              <div class="number" id="catOcultas">0</div>
              <div class="label">Ocultas</div>
            </div>
            <div class="stat-box">
              <div class="number" id="catArchivadas">0</div>
              <div class="label">Archivadas</div>
            </div>
          </div>
          <div style="margin-top: 15px;">
            <button onclick="verCategorias()">üëÅÔ∏è Ver Todas</button>
            <button onclick="nuevaCategoria()" class="success">‚ûï Nueva</button>
            <button onclick="reordenarCategorias()" class="warning">üîÑ Reordenar</button>
            <button onclick="sincronizarTodasLasCategorias()" class="premium">‚ö° Sincronizar Contadores</button>
          </div>
          <div id="logCat" class="log"></div>
        </div>
      </div>
      <!-- TAB PREGUNTAS -->
      <div id="tabPreguntas" class="tab-content">
        <div class="card">
          <h2>‚ùì Preguntas</h2>
          <label style="color: #34c3ff; font-weight: 600; display: block; margin-bottom: 10px;">
            Selecciona categor√≠a:
          </label>
          <select id="catSelect" onchange="catSeleccionada()">
            <option value="">-- Selecciona --</option>
          </select>
          <div id="catInfo" style="display:none; margin: 15px 0; color: #aab3b8;">
            <div id="catNombre" style="color: #34c3ff; font-weight: 600; margin-bottom: 5px;"></div>
            <div>Preguntas en BD: <strong id="catTotal">0</strong></div>
          </div>
          <div style="margin: 15px 0;">
            <input type="file" id="fileJSON" accept=".json" onchange="cargarJSON()" style="display:none;">
            <button onclick="document.getElementById('fileJSON').click()" class="success">üìÅ Cargar JSON</button>
            <button onclick="exportarPreguntas()" class="warning" id="btnExportar" disabled>üì• Exportar</button>
            <button onclick="cargarPreguntasConsola()" class="premium" id="btnCargarPreguntas" disabled>üìù Gestionar</button>
            <span id="fileName" style="margin-left: 15px; color: #aab3b8; font-size: 14px;"></span>
          </div>
          <textarea id="jsonText" placeholder='Pega aqu√≠ el JSON de preguntas...'></textarea>
          <div style="margin-top: 15px;">
            <button onclick="validarJSON()" class="warning">‚úì Validar</button>
            <button onclick="subirPreguntas()" class="success" id="btnSubir" disabled>üì§ Subir</button>
            <button onclick="limpiarJSON()">üóëÔ∏è Limpiar</button>
            <button onclick="borrarPreguntas()" class="danger" id="btnBorrar" disabled>üóëÔ∏è Borrar Todas</button>
          </div>
          <div id="logPreg" class="log"></div>
        </div>
      </div>
      <!-- TAB USUARIOS -->
      <div id="tabUsuarios" class="tab-content">
        <div class="card">
          <h2>üë• Usuarios y Suscripciones<span id="cacheIndicatorUsers"></span></h2>
          <div class="stats">
            <div class="stat-box">
              <div class="number" id="totalUsers">-</div>
              <div class="label">Usuarios</div>
            </div>
            <div class="stat-box premium">
              <div class="number" id="totalSubs">-</div>
              <div class="label">Suscripciones</div>
            </div>
            <div class="stat-box">
              <div class="number" id="totalgratuito">-</div>
              <div class="label">Gratuitas</div>
            </div>
            <div class="stat-box mensual">
              <div class="number" id="totalMensual">-</div>
              <div class="label">Mensuales</div>
            </div>
            <div class="stat-box trimestral">
              <div class="number" id="totalTrimestral">-</div>
              <div class="label">Trimestrales</div>
            </div>
            <div class="stat-box anual">
              <div class="number" id="totalAnual">-</div>
              <div class="label">Anuales</div>
            </div>
          </div>
          <div style="margin-top: 20px;">
            <button onclick="verUsuarios()">üë• Ver Usuarios</button>
            <button onclick="otorgarAcceso()" class="premium">üëë Otorgar Acceso</button>
            <button onclick="actualizarStatsUsers(true)">üîÑ Actualizar Stats</button>
            <button onclick="limpiarLogsUsuarios()" class="danger">üóëÔ∏è Limpiar Log</button>
          </div>
          <div id="logUsers" class="log"></div>
        </div>
      </div>
      <!-- TAB STATS -->
      <div id="tabStats" class="tab-content">
        <div class="card">
          <h2>üìä Estad√≠sticas Generales<span id="cacheIndicatorStats"></span></h2>
          <button onclick="actualizarStats(true)">üîÑ Actualizar</button>
          <button onclick="instruccionesBackupLocal()" class="success">üíæ Backup Completo Local</button>
          <button onclick="restaurarBackup()" class="warning">üì• Restaurar</button>
          <div class="stats">
            <div class="stat-box">
              <div class="number" id="sCat">-</div>
              <div class="label">Categor√≠as</div>
            </div>
            <div class="stat-box">
              <div class="number" id="sPreg">-</div>
              <div class="label">Preguntas</div>
            </div>
            <div class="stat-box">
              <div class="number" id="sRes">-</div>
              <div class="label">Resultados</div>
            </div>
            <div class="stat-box">
              <div class="number" id="sProg">-</div>
              <div class="label">Progresos</div>
            </div>
          </div>
          <div id="logStats" class="log"></div>
        </div>
      </div>
    </div>
  </div>
  <!-- MODALES -->
  <div id="modalCat" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalCatTitle">Nueva Categor√≠a</h3>
        <button class="modal-close" onclick="cerrarModalCat()">√ó</button>
      </div>
      <form id="formCat" onsubmit="guardarCat(event)">
        <input type="hidden" id="catIdOld">
        
        <div class="form-group">
          <label for="filePDFCat" class="file-upload-btn">üìÑ Cargar JSON de categor√≠a</label>
          <input type="file" id="filePDFCat" accept=".json" onchange="cargarJSONCat()" style="display:none;">
          <small id="pdfFileName" style="color: #5dff9a;"></small>
        </div>
        
        <div class="form-group">
          <label>ID:</label>
          <input type="text" id="catId" placeholder="matematicas" required>
          <small>Solo letras min√∫sculas, n√∫meros y guiones</small>
        </div>
        <div class="form-group">
          <label>Nombre:</label>
          <input type="text" id="catNom" placeholder="Matem√°ticas" required>
        </div>
        <div class="form-group">
          <label>Total preguntas:</label>
          <input type="number" id="catTot" value="0" min="0" required>
        </div>
        <div class="form-group">
          <label>Por tanda:</label>
          <input type="number" id="catPorT" value="30" min="1" required>
        </div>
        <div class="form-group">
          <label>Orden:</label>
          <input type="number" id="catOrden" value="0" min="0">
          <small>Menor n√∫mero = aparece primero</small>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="catActiva" checked>
          <label for="catActiva">‚úÖ Activa</label>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="catVisible" checked>
          <label for="catVisible">üëÅÔ∏è Visible</label>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="catArchivada">
          <label for="catArchivada">üì¶ Archivada</label>
        </div>
        <div style="margin-top: 20px; display: flex; gap: 10px;">
          <button type="submit" class="success" style="flex: 1;">üíæ Guardar</button>
          <button type="button" onclick="cerrarModalCat()" class="secondary" style="flex: 1;">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
  <div id="modalListCat" class="modal">
    <div class="modal-content" style="max-width: 900px;">
      <div class="modal-header">
        <h3>üìö Todas las Categor√≠as</h3>
        <button class="modal-close" onclick="cerrarModalListCat()">√ó</button>
      </div>
      <div id="listCat"></div>
    </div>
  </div>
  <div id="modalReordenar" class="modal">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h3>üîÑ Reordenar Categor√≠as</h3>
        <button class="modal-close" onclick="cerrarModalReordenar()">√ó</button>
      </div>
      <div class="info-box">
        üí° Arrastra para cambiar orden. Se guarda autom√°ticamente.
      </div>
      <div id="listReordenar"></div>
      <div style="margin-top: 20px;">
        <button onclick="cerrarModalReordenar()" class="success" style="width: 100%;">‚úì Listo</button>
      </div>
    </div>
  </div>
  <div id="modalEstatus" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h3 id="estatusTitulo">üìä Estatus</h3>
        <button class="modal-close" onclick="cerrarModalEstatus()">√ó</button>
      </div>
      <div id="estatusContenido"></div>
    </div>
  </div>
  <div id="modalUsers" class="modal">
    <div class="modal-content" style="max-width: 900px;">
      <div class="modal-header">
        <h3>üë• Usuarios</h3>
        <button class="modal-close" onclick="cerrarModalUsers()">√ó</button>
      </div>
      <div id="listUsers"></div>
    </div>
  </div>
  <div id="modalAcceso" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>üëë Otorgar Acceso</h3>
        <button class="modal-close" onclick="cerrarModalAcceso()">√ó</button>
      </div>
      <form id="formAcceso" onsubmit="procesarAcceso(event)">
        <div class="form-group">
          <label>Email:</label>
          <input type="email" id="emailAcceso" placeholder="usuario@email.com" required>
        </div>
        <div class="form-group">
          <label>Categor√≠a:</label>
          <select id="catAcceso" required>
            <option value="">-- Selecciona --</option>
          </select>
        </div>
        <div class="form-group">
          <label>Plan:</label>
          <select id="planAcceso" required>
            <option value="gratuito">üéÅ Gratuito</option>
            <option value="mensual">üìÖ Mensual</option>
            <option value="trimestral">üî• Trimestral</option>
            <option value="anual">üëë Anual</option>
          </select>
        </div>
        <div style="margin-top: 20px; display: flex; gap: 10px;">
          <button type="submit" class="premium" style="flex: 1;">üëë Otorgar</button>
          <button type="button" onclick="cerrarModalAcceso()" class="secondary" style="flex: 1;">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
  <!-- MODAL LISTA DE PREGUNTAS -->
  <div id="modalPreguntas" class="modal">
    <div class="modal-content" style="max-width: 1000px;">
      <div class="modal-header">
        <h3>üìù Gesti√≥n de Preguntas</h3>
        <button class="modal-close" onclick="cerrarModalPreguntas()">√ó</button>
      </div>
      <div style="margin-bottom: 20px;">
        <button onclick="nuevaPregunta()" class="success">‚ûï Nueva Pregunta</button>
        <button onclick="cargarPreguntasConsola()" class="warning">üîÑ Recargar</button>
        <button onclick="buscarDuplicadas()" class="danger">üîç Buscar Duplicadas</button>
        <button onclick="buscarPreguntasFaltantes()" class="warning">üî¢ Buscar Faltantes</button>
        <button onclick="cerrarModalPreguntas()" class="secondary">‚úì Cerrar</button>
      </div>
      <div id="preguntasContenido" style="max-height: 600px; overflow-y: auto;"></div>
    </div>
  </div>
  <!-- MODAL EDITAR PREGUNTA -->
  <div id="modalEditPregunta" class="modal">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h3 id="modalEditTitulo">‚úèÔ∏è Editar Pregunta</h3>
        <button class="modal-close" onclick="cerrarModalEditPregunta()">√ó</button>
      </div>
      <form id="formEditPregunta" onsubmit="guardarPreguntaForm(event)">
        <input type="hidden" id="editIndex">
        
        <div class="form-group">
          <label>ID:</label>
          <input type="text" id="editId" placeholder="1" required>
          <small>N√∫mero o identificador √∫nico</small>
        </div>
        
        <div class="form-group">
          <label>Pregunta:</label>
          <textarea id="editPregunta" placeholder="Escribe la pregunta aqu√≠..." required style="min-height: 100px;"></textarea>
        </div>
        
        <div class="form-group">
          <label>Opci√≥n A:</label>
          <input type="text" id="editOpcionA" placeholder="Primera opci√≥n" required>
        </div>
        
        <div class="form-group">
          <label>Opci√≥n B:</label>
          <input type="text" id="editOpcionB" placeholder="Segunda opci√≥n" required>
        </div>
        
        <div class="form-group">
          <label>Opci√≥n C:</label>
          <input type="text" id="editOpcionC" placeholder="Tercera opci√≥n" required>
        </div>
        
        <div class="form-group">
          <label>Opci√≥n D:</label>
          <input type="text" id="editOpcionD" placeholder="Cuarta opci√≥n" required>
        </div>
        
        <div class="form-group">
          <label>Respuesta Correcta:</label>
          <select id="editRespuesta" required>
            <option value="0">A</option>
            <option value="1">B</option>
            <option value="2">C</option>
            <option value="3">D</option>
          </select>
        </div>
        
        <div class="checkbox-group">
          <input type="checkbox" id="editActiva" checked>
          <label for="editActiva">‚úÖ Activa</label>
        </div>
        
        <div style="margin-top: 20px; display: flex; gap: 10px;">
          <button type="submit" class="success" style="flex: 1;">üíæ Guardar</button>
          <button type="button" onclick="cerrarModalEditPregunta()" class="secondary" style="flex: 1;">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
  <div id="modalDuplicados" class="modal">
    <div class="modal-content" style="max-width: 900px;">
      <div class="modal-header">
        <h3>üîç Preguntas Duplicadas</h3>
        <button class="modal-close" onclick="cerrarModalDuplicados()">√ó</button>
      </div>
      <div style="margin-bottom: 20px;">
        <button onclick="eliminarDuplicadas()" class="danger">üóëÔ∏è Eliminar <span id="totalDuplicadosEliminar">0</span> Duplicadas</button>
        <button onclick="cerrarModalDuplicados()" class="secondary">Cancelar</button>
      </div>
      <div id="duplicadosContenido" style="max-height: 600px; overflow-y: auto;"></div>
    </div>
  </div>
  <!-- MODAL FALTANTES -->
  <div id="modalFaltantes" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h3>üîç Preguntas Faltantes</h3>
        <button class="modal-close" onclick="cerrarModalFaltantes()">√ó</button>
      </div>
      <div id="faltantesContenido" style="max-height: 600px; overflow-y: auto;"></div>
      <div style="margin-top: 20px;">
        <button onclick="cerrarModalFaltantes()" class="secondary" style="width: 100%;">Cerrar</button>
      </div>
    </div>
  </div>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCQ5u2bs7kv7KNsS7HQ_T2HYNNnhI-KbG4",
      authDomain: "multitest-gobcan.firebaseapp.com",
      projectId: "multitest-gobcan",
      storageBucket: "multitest-gobcan.firebasestorage.app",
      messagingSenderId: "1039579449781",
      appId: "1:1039579449781:web:f0709e9515a19184a3f1fc",
      measurementId: "G-D3PN7H340S"
    };
    
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const ADMIN_EMAIL = 'carlos.itim@gmail.com';
    
    // ‚úÖ VARIABLES GLOBALES
    let catActual = null;
    let modoEdit = false;
    let preguntasCategoriaJSON = null;
    let preguntasCargadas = [];
    
    // ‚úÖ SISTEMA DE CACH√â OPTIMIZADO
    const cache = {
      usuarios: { data: null, timestamp: 0 },
      stats: { data: null, timestamp: 0 },
      categorias: { data: null, timestamp: 0 }
    };
    const CACHE_DURATION = 5 * 60 * 1000; // 5 minutos
    
    function esCacheValido(tipo) {
      const ahora = Date.now();
      return cache[tipo].data && (ahora - cache[tipo].timestamp) < CACHE_DURATION;
    }
    
    function guardarEnCache(tipo, data) {
      cache[tipo] = {
        data: data,
        timestamp: Date.now()
      };
    }
    
    function mostrarIndicadorCache(elemento, valido) {
      const indicator = document.getElementById(elemento);
      if (indicator) {
        if (valido) {
          indicator.innerHTML = '<span class="cache-indicator">üì¶ Cach√©</span>';
        } else {
          indicator.innerHTML = '';
        }
      }
    }
    
    // ‚úÖ FUNCIONES B√ÅSICAS
    function log(id, msg, type = 'info') {
      const el = document.getElementById(id);
      if (!el) return;
      
      const div = document.createElement('div');
      div.className = `log-item ${type}`;
      div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      el.appendChild(div);
      
      const items = el.querySelectorAll('.log-item');
      if (items.length > 200) {
        for (let i = 0; i < items.length - 200; i++) {
          items[i].remove();
        }
      }
      
      el.scrollTop = el.scrollHeight;
      
      if (id === 'logUsers') {
        guardarLogs();
      }
    }
    
    function clearLog(id) {
      const el = document.getElementById(id);
      if (el) el.innerHTML = '';
    }
    
    // ‚úÖ CAMBIO DE TAB SIN RECARGAS AUTOM√ÅTICAS
    function cambiarTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
      
      // ‚úÖ SOLO CARGA INICIAL DE SELECT, NO RECARGA STATS
      if (tab === 'preguntas') cargarCatSelect();
      
      // ‚úÖ MOSTRAR DATOS EN CACH√â SI EXISTEN
      if (tab === 'usuarios' && esCacheValido('usuarios')) {
        mostrarStatsDesdeCache('usuarios');
      }
      if (tab === 'stats' && esCacheValido('stats')) {
        mostrarStatsDesdeCache('stats');
      }
    }
    
    function mostrarStatsDesdeCache(tipo) {
      const data = cache[tipo].data;
      if (!data) return;
      
      if (tipo === 'usuarios') {
        document.getElementById('totalUsers').textContent = data.totalUsers;
        document.getElementById('totalSubs').textContent = data.totalSubs;
        document.getElementById('totalgratuito').textContent = data.totalgratuito;
        document.getElementById('totalMensual').textContent = data.totalMensual;
        document.getElementById('totalTrimestral').textContent = data.totalTrimestral;
        document.getElementById('totalAnual').textContent = data.totalAnual;
        mostrarIndicadorCache('cacheIndicatorUsers', true);
        log('logUsers', 'üì¶ Mostrando datos en cach√© (actualizados hace ' + Math.round((Date.now() - cache.usuarios.timestamp) / 1000) + 's)', 'info');
      } else if (tipo === 'stats') {
        document.getElementById('sCat').textContent = data.sCat;
        document.getElementById('sPreg').textContent = data.sPreg;
        document.getElementById('sRes').textContent = data.sRes;
        document.getElementById('sProg').textContent = data.sProg;
        mostrarIndicadorCache('cacheIndicatorStats', true);
      }
    }
    
    function iniciarSesion() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(e => alert('Error: ' + e.message));
    }
    
    function cerrarSesion() {
      auth.signOut().then(() => location.reload());
    }
    
    auth.onAuthStateChanged(user => {
      if (user) {
        if (user.email !== ADMIN_EMAIL) {
          alert('‚ùå Acceso denegado.\n\nSolo ' + ADMIN_EMAIL + ' puede acceder.');
          auth.signOut();
          return;
        }
        
        document.getElementById('loginCard').style.display = 'none';
        document.getElementById('userInfo').style.display = 'flex';
        document.getElementById('adminPanel').style.display = 'block';
        document.getElementById('userEmail').textContent = user.email;
        
        cargarLogsGuardados();
        cargarCatSelect();
        actualizarStatsCategorias();
        
        // ‚úÖ NO CARGA AUTOM√ÅTICA, SOLO CUANDO SE HAGA CLIC
      } else {
        document.getElementById('loginCard').style.display = 'block';
        document.getElementById('userInfo').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'none';
      }
    });
    
    function cargarLogsGuardados() {
      const logsGuardados = localStorage.getItem('adminLogs');
      if (logsGuardados) {
        try {
          const logs = JSON.parse(logsGuardados);
          if (logs.logUsers) {
            document.getElementById('logUsers').innerHTML = logs.logUsers;
          }
        } catch (e) {
          console.error('Error cargando logs:', e);
        }
      }
    }
    
    function guardarLogs() {
      try {
        const logs = {
          logUsers: document.getElementById('logUsers').innerHTML,
          timestamp: Date.now()
        };
        localStorage.setItem('adminLogs', JSON.stringify(logs));
      } catch (e) {
        console.error('Error guardando logs:', e);
      }
    }
    
    function limpiarLogsUsuarios() {
      if (!confirm('¬øLimpiar historial de logs?')) return;
      document.getElementById('logUsers').innerHTML = '';
      localStorage.removeItem('adminLogs');
      log('logUsers', 'Historial limpiado', 'info');
    }
    
    async function cargarCatSelect() {
      const s1 = document.getElementById('catSelect');
      const s2 = document.getElementById('catAcceso');
      if (!s1 || !s2) return;
      
      s1.innerHTML = '<option value="">-- Selecciona --</option>';
      s2.innerHTML = '<option value="">-- Selecciona --</option>';
      
      try {
        const snap = await db.collection('categorias').get();
        snap.forEach(doc => {
          const cat = doc.data();
          if (!cat.archivada) {
            s1.innerHTML += `<option value="${doc.id}">${cat.nombre}</option>`;
            s2.innerHTML += `<option value="${doc.id}">${cat.nombre}</option>`;
          }
        });
      } catch (e) {
        console.error('Error cargando categor√≠as:', e);
        alert('Error al cargar categor√≠as: ' + e.message);
      }
    }
    
    async function actualizarStatsCategorias() {
      try {
        const snap = await db.collection('categorias').get();
        let total = 0, activas = 0, ocultas = 0, archivadas = 0;
        
        snap.forEach(doc => {
          const d = doc.data();
          total++;
          if (d.archivada) archivadas++;
          else if (d.activa !== false) activas++;
          if (d.visible === false) ocultas++;
        });
        
        document.getElementById('catCount').textContent = total;
        document.getElementById('catActivas').textContent = activas;
        document.getElementById('catOcultas').textContent = ocultas;
        document.getElementById('catArchivadas').textContent = archivadas;
      } catch (e) {
        console.error('Error stats categor√≠as:', e);
      }
    }
    
    // ‚úÖ GESTI√ìN DE CATEGOR√çAS
    function cargarJSONCat() {
      const file = document.getElementById('filePDFCat').files[0];
      if (!file) return;
      
      document.getElementById('pdfFileName').textContent = `üìÑ ${file.name}`;
      
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const preguntas = JSON.parse(e.target.result);
          
          if (!Array.isArray(preguntas) || preguntas.length === 0) {
            alert('‚ùå El JSON debe contener un array de preguntas');
            preguntasCategoriaJSON = null;
            return;
          }
          
          preguntasCategoriaJSON = preguntas;
          
          const nombrePDF = file.name.replace('.json', '');
          
          const idCategoria = nombrePDF
            .toLowerCase()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-+|-+$/g, '');
          
          const numPreguntas = preguntas.length;
          
          document.getElementById('catId').value = idCategoria;
          document.getElementById('catNom').value = nombrePDF;
          document.getElementById('catTot').value = numPreguntas;
          
          alert(`‚úÖ JSON cargado exitosamente\n\nID: ${idCategoria}\nNombre: ${nombrePDF}\nPreguntas: ${numPreguntas}\n\n‚ú® Las preguntas se subir√°n autom√°ticamente al crear la categor√≠a.`);
          
        } catch (err) {
          alert('‚ùå Error al procesar el JSON: ' + err.message);
          preguntasCategoriaJSON = null;
        }
      };
      reader.readAsText(file);
    }
    
    function nuevaCategoria() {
      modoEdit = false;
      preguntasCategoriaJSON = null;
      document.getElementById('modalCatTitle').textContent = 'Nueva Categor√≠a';
      document.getElementById('catIdOld').value = '';
      document.getElementById('catId').value = '';
      document.getElementById('catId').disabled = false;
      document.getElementById('catNom').value = '';
      document.getElementById('catTot').value = '0';
      document.getElementById('catPorT').value = '30';
      document.getElementById('catOrden').value = '0';
      document.getElementById('catActiva').checked = true;
      document.getElementById('catVisible').checked = true;
      document.getElementById('catArchivada').checked = false;
      document.getElementById('filePDFCat').value = '';
      document.getElementById('pdfFileName').textContent = '';
      document.getElementById('modalCat').classList.add('show');
    }
    
    async function editarCat(id) {
      modoEdit = true;
      preguntasCategoriaJSON = null;
      try {
        const doc = await db.collection('categorias').doc(id).get();
        if (!doc.exists) return alert('No encontrada');
        
        const d = doc.data();
        document.getElementById('modalCatTitle').textContent = 'Editar Categor√≠a';
        document.getElementById('catIdOld').value = id;
        document.getElementById('catId').value = id;
        document.getElementById('catId').disabled = true;
        document.getElementById('catNom').value = d.nombre || '';
        document.getElementById('catTot').value = d.totalPreguntas || 0;
        document.getElementById('catPorT').value = d.preguntasPorTanda || 30;
        document.getElementById('catOrden').value = d.orden || 0;
        document.getElementById('catActiva').checked = d.activa !== false;
        document.getElementById('catVisible').checked = d.visible !== false;
        document.getElementById('catArchivada').checked = d.archivada === true;
        document.getElementById('filePDFCat').value = '';
        document.getElementById('pdfFileName').textContent = '';
        document.getElementById('modalCat').classList.add('show');
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }
    
    async function guardarCat(e) {
      e.preventDefault();
      const id = modoEdit ? document.getElementById('catIdOld').value : document.getElementById('catId').value;
      const nombre = document.getElementById('catNom').value;
      const totalPreguntas = parseInt(document.getElementById('catTot').value);
      const preguntasPorTanda = parseInt(document.getElementById('catPorT').value);
      const orden = parseInt(document.getElementById('catOrden').value);
      const activa = document.getElementById('catActiva').checked;
      const visible = document.getElementById('catVisible').checked;
      const archivada = document.getElementById('catArchivada').checked;
      
      if (!/^[a-z0-9\-]+$/.test(id)) return alert('ID inv√°lido');
      
      const datos = {
        nombre,
        totalPreguntas,
        preguntasPorTanda,
        orden,
        activa,
        visible,
        archivada,
        actualizadaEn: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      if (!modoEdit) datos.creadaEn = firebase.firestore.FieldValue.serverTimestamp();
      
      try {
        await db.collection('categorias').doc(id).set(datos, { merge: true });
        
        if (preguntasCategoriaJSON && preguntasCategoriaJSON.length > 0 && !modoEdit) {
          clearLog('logCat');
          log('logCat', 'üì§ Subiendo preguntas autom√°ticamente...', 'info');
          
          let ok = 0, err = 0;
          for (const p of preguntasCategoriaJSON) {
            try {
              await db.collection('preguntas').add({
                id: p.id,
                pregunta: p.pregunta,
                opciones: p.opciones,
                respuestaCorrecta: p.respuestaCorrecta,
                categoria: id,
                activa: p.activa !== false,
                creadaEn: firebase.firestore.FieldValue.serverTimestamp()
              });
              ok++;
              if (ok % 25 === 0) log('logCat', `${ok}/${preguntasCategoriaJSON.length} preguntas...`, 'info');
            } catch (e) {
              err++;
            }
          }
          
          log('logCat', `‚úÖ ${ok} preguntas subidas, ${err} errores`, ok > 0 ? 'success' : 'error');
          
          await sincronizarContadorCategoria(id);
          
          alert(`‚úÖ Categor√≠a creada y sincronizada\n\nüì§ ${ok} preguntas subidas\n${err > 0 ? `‚ö†Ô∏è ${err} errores` : ''}`);
          preguntasCategoriaJSON = null;
        } else {
          alert(`‚úÖ ${modoEdit ? 'Actualizada' : 'Creada'}`);
        }
        
        cerrarModalCat();
        await cargarCatSelect();
        await actualizarStats(true);
        await actualizarStatsCategorias();
        
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }
    
    async function verCategorias() {
      try {
        const snap = await db.collection('categorias').get();
        if (snap.empty) return alert('No hay categor√≠as');
        
        let html = `
          <div style="margin-bottom: 15px; padding: 12px; background: rgba(52, 195, 255, 0.1); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
            <div style="color: #34c3ff; font-size: 14px;">
              <strong>${snap.size}</strong> categor√≠as encontradas
            </div>
            <button onclick="sincronizarTodasLasCategorias()" class="btn-small warning">üîÑ Sincronizar Todas</button>
          </div>
        `;
        
        snap.forEach(doc => {
          const d = doc.data();
          const catId = doc.id;
          
          const preguntasReales = d.preguntasReales ?? d.totalPreguntas ?? 0;
          const preguntasEnCat = d.totalPreguntas || 0;
          const hayDiscrepancia = d.preguntasReales !== undefined && preguntasReales !== preguntasEnCat;
          
          const badges = [];
          
          if (d.archivada) badges.push('<span class="badge archivada">üì¶ Archivada</span>');
          else if (d.activa !== false) badges.push('<span class="badge activa">‚úÖ Activa</span>');
          else badges.push('<span class="badge oculta">‚ùå Inactiva</span>');
          
          if (d.visible === false) badges.push('<span class="badge oculta">üëÅÔ∏è Oculta</span>');
          
          if (hayDiscrepancia) {
            badges.push(`<span class="badge" style="background: rgba(255, 107, 107, 0.3); color: #ff6b6b;">‚ö†Ô∏è Desincronizada</span>`);
          }
          
          html += `
            <div class="list-item" style="${hayDiscrepancia ? 'border-left: 4px solid #ff6b6b;' : ''}">
              <div class="info">
                <div class="nombre">${d.nombre} ${badges.join(' ')}</div>
                <div class="detalles">
                  ID: ${catId} | Orden: ${d.orden || 0} | ${preguntasReales} preguntas
                  ${hayDiscrepancia ? 
                    `<span style="color: #ff6b6b; font-weight: 600;"> (Cat: ${preguntasEnCat})</span>` : 
                    ''
                  }
                </div>
              </div>
              <div class="acciones">
                <button onclick="verEstatus('${catId}')" class="btn-small premium">üìä</button>
                <button onclick="editarCat('${catId}')" class="btn-small warning">‚úèÔ∏è</button>
                ${hayDiscrepancia ? 
                  `<button onclick="sincronizarUnaSola('${catId}')" class="btn-small success" title="Sincronizar">üîÑ</button>` : 
                  ''
                }
                <button onclick="eliminarCat('${catId}', '${d.nombre}')" class="btn-small danger">üóëÔ∏è</button>
              </div>
            </div>
          `;
        });
        
        document.getElementById('listCat').innerHTML = html;
        document.getElementById('modalListCat').classList.add('show');
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }
    
    async function sincronizarUnaSola(catId) {
      try {
        const preguntasReales = await sincronizarContadorCategoria(catId);
        alert(`‚úÖ Sincronizada\n\n${preguntasReales} preguntas en BD`);
        await verCategorias();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }
    
    async function eliminarCat(id, nom) {
      if (!confirm(`¬øEliminar "${nom}"?`)) return;
      try {
        await db.collection('categorias').doc(id).delete();
        alert('Eliminada');
        await verCategorias();
        await cargarCatSelect();
        await actualizarStats(true);
        await actualizarStatsCategorias();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }
    
    async function reordenarCategorias() {
      try {
        const snap = await db.collection('categorias').get();
        if (snap.empty) return alert('No hay categor√≠as');
        
        let html = '';
        let index = 0;
        snap.forEach(doc => {
          const d = doc.data();
          html += `
            <div class="list-item" draggable="true" data-id="${doc.id}" data-index="${index}">
              <span class="drag-handle">‚ò∞</span>
              <div class="info">
                <div class="nombre">${d.nombre}</div>
                <div class="detalles">Orden: ${d.orden || 0}</div>
              </div>
            </div>
          `;
          index++;
        });
        
        document.getElementById('listReordenar').innerHTML = html;
        document.getElementById('modalReordenar').classList.add('show');
        
        const items = document.querySelectorAll('#listReordenar .list-item');
        items.forEach(item => {
          item.addEventListener('dragstart', handleDragStart);
          item.addEventListener('dragover', handleDragOver);
          item.addEventListener('drop', handleDrop);
          item.addEventListener('dragend', handleDragEnd);
        });
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }
    
    let draggedElement = null;
    function handleDragStart(e) {
      draggedElement = this;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }
    function handleDragOver(e) {
      if (e.preventDefault) e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      return false;
    }
    function handleDrop(e) {
      if (e.stopPropagation) e.stopPropagation();
      
      if (draggedElement !== this) {
        const allItems = Array.from(document.querySelectorAll('#listReordenar .list-item'));
        const draggedIndex = allItems.indexOf(draggedElement);
        const targetIndex = allItems.indexOf(this);
        
        if (draggedIndex < targetIndex) {
          this.parentNode.insertBefore(draggedElement, this.nextSibling);
        } else {
          this.parentNode.insertBefore(draggedElement, this);
        }
        
        guardarNuevoOrden();
      }
      
      return false;
    }
    function handleDragEnd(e) {
      this.classList.remove('dragging');
    }
    
    async function guardarNuevoOrden() {
      const items = document.querySelectorAll('#listReordenar .list-item');
      const batch = db.batch();
      
      items.forEach((item, index) => {
        const id = item.getAttribute('data-id');
        const ref = db.collection('categorias').doc(id);
        batch.update(ref, { orden: index });
      });
      
      await batch.commit();
    }
    
    async function verEstatus(catId) {
      try {
        const catDoc = await db.collection('categorias').doc(catId).get();
        if (!catDoc.exists) return alert('No encontrada');
        
        const cat = catDoc.data();
        document.getElementById('estatusTitulo').textContent = `üìä ${cat.nombre}`;
        
        const susSnap = await db.collection('suscripciones').get();
        
        let totalUsuarios = 0;
        let totalgratuito = 0, totalMensual = 0, totalTrimestral = 0, totalAnual = 0;
        let ultimaFecha = null;
        const usuariosDetalle = [];
        
        susSnap.forEach(doc => {
          const data = doc.data();
          const email = data.email || 'Sin email';
          
          if (data[catId]) {
            const sub = data[catId];
            totalUsuarios++;
            
            switch(sub.plan) {
              case 'gratuito': totalgratuito++; break;
              case 'mensual': totalMensual++; break;
              case 'trimestral': totalTrimestral++; break;
              case 'anual': totalAnual++; break;
            }
            
            let vencimiento = null;
            if (sub.plan !== 'gratuito' && sub.fechaActivacion) {
              const dias = sub.plan === 'mensual' ? 30 : sub.plan === 'trimestral' ? 90 : 365;
              vencimiento = new Date(sub.fechaActivacion + (dias * 24 * 60 * 60 * 1000));
              
              if (!ultimaFecha || vencimiento > ultimaFecha) {
                ultimaFecha = vencimiento;
              }
            }
            
            usuariosDetalle.push({
              email,
              plan: sub.plan,
              tandas: sub.tandasUsadas || 0,
              vencimiento
            });
          }
        });
        
        const pregSnap = await db.collection('preguntas').where('categoria', '==', catId).get();
        const preguntasReales = pregSnap.size;
        const preguntasEnCat = cat.totalPreguntas || 0;
        
        const resSnap = await db.collection('resultados').where('categoria', '==', catId).get();
        
        const hayDiscrepancia = preguntasReales !== preguntasEnCat;
        
        let html = `
          <div class="cat-stats-box">
            <h3 style="color: #34c3ff; margin-bottom: 15px;">üìä Resumen</h3>
            <div class="cat-stats-grid">
              <div class="cat-stat-item premium">
                <div class="label">Usuarios</div>
                <div class="value">${totalUsuarios}</div>
              </div>
              <div class="cat-stat-item ${hayDiscrepancia ? 'premium' : ''}">
                <div class="label">Preguntas en BD</div>
                <div class="value" style="${hayDiscrepancia ? 'color: #ff6b6b;' : ''}">${preguntasReales}</div>
              </div>
              <div class="cat-stat-item">
                <div class="label">En Categor√≠a</div>
                <div class="value">${preguntasEnCat}</div>
              </div>
              <div class="cat-stat-item">
                <div class="label">Tests Realizados</div>
                <div class="value">${resSnap.size}</div>
              </div>
              <div class="cat-stat-item">
                <div class="label">√öltima Renovaci√≥n</div>
                <div class="value" style="font-size: 16px;">${ultimaFecha ? ultimaFecha.toLocaleDateString('es-ES') : 'N/A'}</div>
              </div>
            </div>
            ${hayDiscrepancia ? `
              <div style="background: rgba(255, 107, 107, 0.1); border: 1px solid rgba(255, 107, 107, 0.3); padding: 15px; border-radius: 8px; margin-top: 15px;">
                <div style="color: #ff6b6b; font-weight: 600; margin-bottom: 5px;">‚ö†Ô∏è DISCREPANCIA DETECTADA</div>
                <div style="color: #aab3b8; font-size: 14px;">
                  La categor√≠a indica ${preguntasEnCat} preguntas, pero en la BD hay ${preguntasReales} preguntas.
                </div>
                <button onclick="sincronizarPreguntas('${catId}', ${preguntasReales})" class="warning" style="margin-top: 10px;">
                  üîÑ Sincronizar Categor√≠a
                </button>
              </div>
            ` : `
              <div style="background: rgba(46, 139, 87, 0.1); border: 1px solid rgba(46, 139, 87, 0.3); padding: 15px; border-radius: 8px; margin-top: 15px; color: #5dff9a;">
                ‚úÖ La categor√≠a est√° sincronizada correctamente
              </div>
            `}
          </div>
          
          <div class="cat-stats-box">
            <h3 style="color: #34c3ff; margin-bottom: 15px;">üë• Planes</h3>
            <div class="cat-stats-grid">
              <div class="cat-stat-item">
                <div class="label">üéÅ Gratis</div>
                <div class="value">${totalgratuito}</div>
              </div>
              <div class="cat-stat-item">
                <div class="label">üìÖ Mensual</div>
                <div class="value">${totalMensual}</div>
              </div>
              <div class="cat-stat-item">
                <div class="label">üî• Trimestral</div>
                <div class="value">${totalTrimestral}</div>
              </div>
              <div class="cat-stat-item premium">
                <div class="label">üëë Anual</div>
                <div class="value">${totalAnual}</div>
              </div>
            </div>
          </div>
        `;
        
        if (usuariosDetalle.length > 0) {
          html += `<div class="cat-stats-box"><h3 style="color: #34c3ff; margin-bottom: 15px;">üìã Usuarios</h3>`;
          usuariosDetalle.forEach(u => {
            const planBadge = `<span class="badge ${u.plan}">${u.plan}</span>`;
            const vencTxt = u.vencimiento ? `Vence: ${u.vencimiento.toLocaleDateString('es-ES')}` : 
                            u.plan === 'gratuito' ? `Tandas: ${u.tandas}/2` : 'Activo';
            
            html += `
              <div style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between;">
                <div>
                  <div style="color: #34c3ff; font-weight: 600;">${u.email}</div>
                  <div style="color: #aab3b8; font-size: 13px;">${vencTxt}</div>
                </div>
                ${planBadge}
              </div>
            `;
          });
          html += `</div>`;
        }
        
        document.getElementById('estatusContenido').innerHTML = html;
        document.getElementById('modalEstatus').classList.add('show');
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }
    
    async function sincronizarContadorCategoria(catId) {
      try {
        const pregSnap = await db.collection('preguntas').where('categoria', '==', catId).get();
        const preguntasReales = pregSnap.size;
        
        await db.collection('categorias').doc(catId).update({
          preguntasReales: preguntasReales,
          totalPreguntas: preguntasReales,
          ultimaSincronizacion: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        return preguntasReales;
      } catch (e) {
        console.error('Error sincronizando:', e);
        throw e;
      }
    }
    
    async function sincronizarTodasLasCategorias() {
      if (!confirm('¬øSincronizar contadores de TODAS las categor√≠as?\n\nEsto puede tardar unos segundos.')) return;
      
      clearLog('logCat');
      log('logCat', 'üîÑ Iniciando sincronizaci√≥n masiva...', 'info');
      
      try {
        const catSnap = await db.collection('categorias').get();
        let procesadas = 0, errores = 0;
        
        for (const catDoc of catSnap.docs) {
          const catId = catDoc.id;
          const catNombre = catDoc.data().nombre;
          
          try {
            const preguntasReales = await sincronizarContadorCategoria(catId);
            procesadas++;
            log('logCat', `‚úì ${catNombre}: ${preguntasReales} preguntas`, 'success');
          } catch (e) {
            errores++;
            log('logCat', `‚úó ${catNombre}: Error`, 'error');
          }
        }
        
        log('logCat', `‚úÖ Completado: ${procesadas} sincronizadas, ${errores} errores`, 'success');
        alert(`‚úÖ Sincronizaci√≥n completada\n\n${procesadas} categor√≠as actualizadas\n${errores} errores`);
        
        await verCategorias();
        await actualizarStatsCategorias();
        
      } catch (e) {
        log('logCat', `‚ùå Error: ${e.message}`, 'error');
        alert('Error: ' + e.message);
      }
    }
    
    async function sincronizarPreguntas(catId, preguntasReales) {
      if (!confirm(`¬øActualizar el contador de la categor√≠a a ${preguntasReales} preguntas?`)) return;
      
      try {
        await db.collection('categorias').doc(catId).update({
          totalPreguntas: preguntasReales,
          actualizadaEn: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert(`‚úÖ Categor√≠a sincronizada\n\nAhora muestra ${preguntasReales} preguntas correctamente.`);
        
        cerrarModalEstatus();
        await actualizarStatsCategorias();
        await actualizarStats(true);
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }
    
    // ‚úÖ GESTI√ìN DE PREGUNTAS
    async function catSeleccionada() {
      catActual = document.getElementById('catSelect').value;
      if (!catActual) {
        document.getElementById('catInfo').style.display = 'none';
        document.getElementById('btnSubir').disabled = true;
        document.getElementById('btnBorrar').disabled = true;
        document.getElementById('btnExportar').disabled = true;
        document.getElementById('btnCargarPreguntas').disabled = true;
        return;
      }
      try {
        const doc = await db.collection('categorias').doc(catActual).get();
        if (!doc.exists) return;
        
        const cat = doc.data();
        document.getElementById('catNombre').textContent = cat.nombre;
        
        const snap = await db.collection('preguntas').where('categoria', '==', catActual).get();
        const count = snap.size;
        
        document.getElementById('catTotal').textContent = count;
        document.getElementById('catInfo').style.display = 'block';
        document.getElementById('btnSubir').disabled = false;
        document.getElementById('btnBorrar').disabled = false;
        document.getElementById('btnExportar').disabled = count === 0;
        document.getElementById('btnCargarPreguntas').disabled = count === 0;
        
        clearLog('logPreg');
        log('logPreg', `${cat.nombre} (${count} preguntas)`, 'info');
      } catch (e) {
        console.error('Error:', e);
      }
    }
    
    async function cargarPreguntasConsola() {
      if (!catActual) return alert('Selecciona una categor√≠a');
      
      clearLog('logPreg');
      log('logPreg', 'Cargando preguntas...', 'info');
      
      try {
        const snap = await db.collection('preguntas').where('categoria', '==', catActual).get();
        
        if (snap.empty) {
          log('logPreg', '‚ö†Ô∏è No hay preguntas en esta categor√≠a', 'warning');
          return;
        }
        
        preguntasCargadas = [];
        snap.forEach(doc => {
          preguntasCargadas.push({
            docId: doc.id,
            ...doc.data()
          });
        });
        
        preguntasCargadas.sort((a, b) => {
          const idA = parseInt(a.id) || 0;
          const idB = parseInt(b.id) || 0;
          return idA - idB;
        });
        
        log('logPreg', `‚úÖ ${preguntasCargadas.length} preguntas cargadas`, 'success');
        
        mostrarModalPreguntas();
        
      } catch (e) {
        log('logPreg', `‚ùå ${e.message}`, 'error');
      }
    }
    
    function mostrarModalPreguntas() {
      const modal = document.getElementById('modalPreguntas');
      const contenido = document.getElementById('preguntasContenido');
      
      let html = '';
      
      preguntasCargadas.forEach((pregunta, index) => {
        const isActiva = pregunta.activa !== false;
        
        let opciones = [];
        if (Array.isArray(pregunta.opciones)) {
          opciones = pregunta.opciones;
        } else if (pregunta.opciones && typeof pregunta.opciones === 'object') {
          opciones = Object.values(pregunta.opciones);
        }
        
        html += `
          <div class="list-item" style="margin-bottom: 15px; ${!isActiva ? 'opacity: 0.6; border-left: 3px solid #ff6b6b;' : ''}">
            <div class="info" style="flex: 1; max-width: calc(100% - 150px);">
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                <div class="nombre" style="flex: 1;">#${pregunta.id || index + 1}</div>
                ${isActiva ? 
                  '<span class="badge activa">‚úÖ Activa</span>' : 
                  '<span class="badge oculta">‚ùå Inactiva</span>'
                }
              </div>
              <div style="color: #e9eef2; margin-bottom: 8px; font-size: 14px; line-height: 1.5;">
                ${pregunta.pregunta || 'Sin texto'}
              </div>
              <div style="color: #aab3b8; font-size: 13px;">
                ${opciones.length > 0 ? opciones.map((op, i) => 
                  `<div style="margin: 3px 0; ${i === pregunta.respuestaCorrecta ? 'color: #5dff9a; font-weight: 600;' : ''}">
                    ${String.fromCharCode(65 + i)}) ${op}
                  </div>`
                ).join('') : 'Sin opciones'}
              </div>
            </div>
            <div class="acciones" style="display: flex; flex-direction: column; gap: 5px;">
              <button onclick="editarPregunta(${index})" class="btn-small warning" style="width: 100%;">‚úèÔ∏è</button>
              <button onclick="toggleActivaPregunta(${index})" class="btn-small ${isActiva ? 'secondary' : 'success'}" style="width: 100%;">
                ${isActiva ? '‚ùå' : '‚úÖ'}
              </button>
              <button onclick="eliminarPregunta(${index})" class="btn-small danger" style="width: 100%;">üóëÔ∏è</button>
            </div>
          </div>
        `;
      });
      
      contenido.innerHTML = html;
      modal.classList.add('show');
    }
    
    function buscarDuplicadas() {
      if (preguntasCargadas.length === 0) {
        alert('No hay preguntas cargadas');
        return;
      }
      
      const duplicados = {};
      const duplicadosEncontrados = [];
      
      preguntasCargadas.forEach((pregunta, index) => {
        const id = pregunta.id;
        
        if (duplicados[id]) {
          duplicados[id].push(index);
        } else {
          duplicados[id] = [index];
        }
      });
      
      Object.entries(duplicados).forEach(([id, indices]) => {
        if (indices.length > 1) {
          duplicadosEncontrados.push({
            id: id,
            cantidad: indices.length,
            indices: indices
          });
        }
      });
      
      if (duplicadosEncontrados.length === 0) {
        alert('‚úÖ No se encontraron preguntas duplicadas');
        return;
      }
      
      mostrarModalDuplicados(duplicadosEncontrados);
    }
    
    function mostrarModalDuplicados(duplicados) {
      const modal = document.getElementById('modalDuplicados');
      const contenido = document.getElementById('duplicadosContenido');
      
      let totalDuplicados = 0;
      let html = '<div style="margin-bottom: 20px; padding: 15px; background: rgba(255, 107, 107, 0.1); border: 1px solid rgba(255, 107, 107, 0.3); border-radius: 8px;">';
      html += `<div style="color: #ff6b6b; font-weight: 600; font-size: 16px;">‚ö†Ô∏è Se encontraron ${duplicados.length} IDs duplicados</div>`;
      html += '</div>';
      
      duplicados.forEach(dup => {
        totalDuplicados += dup.cantidad - 1;
        
        html += `<div style="margin-bottom: 20px; padding: 15px; background: #26292d; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">`;
        html += `<div style="color: #34c3ff; font-weight: 600; margin-bottom: 10px;">ID #${dup.id} (${dup.cantidad} coincidencias)</div>`;
        
        dup.indices.forEach((index, i) => {
          const pregunta = preguntasCargadas[index];
          let opciones = [];
          if (Array.isArray(pregunta.opciones)) {
            opciones = pregunta.opciones;
          } else if (pregunta.opciones && typeof pregunta.opciones === 'object') {
            opciones = Object.values(pregunta.opciones);
          }
          
          html += `
            <div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 4px; ${i > 0 ? 'border-left: 3px solid #ff6b6b;' : 'border-left: 3px solid #5dff9a;'}">
              <div style="color: #aab3b8; font-size: 12px; margin-bottom: 5px;">${i === 0 ? '‚úÖ SE MANTIENE' : 'üóëÔ∏è SE ELIMINAR√Å'}</div>
              <div style="color: #e9eef2; font-size: 13px; margin-bottom: 5px;">${pregunta.pregunta?.substring(0, 150)}${pregunta.pregunta?.length > 150 ? '...' : ''}</div>
              <div style="color: #aab3b8; font-size: 12px;">DocID: ${pregunta.docId}</div>
            </div>
          `;
        });
        
        html += '</div>';
      });
      
      document.getElementById('totalDuplicadosEliminar').textContent = totalDuplicados;
      contenido.innerHTML = html;
      modal.classList.add('show');
    }
    
    async function eliminarDuplicadas() {
      if (!confirm(`¬øEliminar todas las preguntas duplicadas?\n\nSe eliminar√°n las coincidencias, manteniendo solo la primera de cada ID.\n\nEsta acci√≥n NO se puede deshacer.`)) {
        return;
      }
      
      clearLog('logPreg');
      log('logPreg', 'Eliminando duplicadas...', 'warning');
      
      const duplicados = {};
      
      preguntasCargadas.forEach((pregunta, index) => {
        const id = pregunta.id;
        
        if (duplicados[id]) {
          duplicados[id].push({index, docId: pregunta.docId});
        } else {
          duplicados[id] = [{index, docId: pregunta.docId}];
        }
      });
      
      let eliminadas = 0;
      let errores = 0;
      
      try {
        for (const [id, items] of Object.entries(duplicados)) {
          if (items.length > 1) {
            for (let i = 1; i < items.length; i++) {
              try {
                await db.collection('preguntas').doc(items[i].docId).delete();
                eliminadas++;
                log('logPreg', `‚úì Eliminado duplicado ID #${id} (${i}/${items.length - 1})`, 'info');
              } catch (e) {
                errores++;
                log('logPreg', `‚úó Error eliminando ID #${id}: ${e.message}`, 'error');
              }
            }
          }
        }
        
        log('logPreg', `‚úÖ Proceso completado: ${eliminadas} eliminadas, ${errores} errores`, 'success');
        alert(`‚úÖ Duplicados eliminados\n\n${eliminadas} preguntas duplicadas eliminadas\n${errores} errores`);
        
        cerrarModalDuplicados();
        await cargarPreguntasConsola();
        await catSeleccionada();
        
      } catch (e) {
        log('logPreg', `‚ùå Error: ${e.message}`, 'error');
        alert('Error: ' + e.message);
      }
    }
    
    function buscarPreguntasFaltantes() {
      if (preguntasCargadas.length === 0) {
        alert('No hay preguntas cargadas');
        return;
      }
      
      const idsExistentes = preguntasCargadas
        .map(p => parseInt(p.id))
        .filter(id => !isNaN(id))
        .sort((a, b) => a - b);
      
      if (idsExistentes.length === 0) {
        alert('No hay IDs num√©ricos en las preguntas');
        return;
      }
      
      const minId = idsExistentes[0];
      const maxId = idsExistentes[idsExistentes.length - 1];
      const faltantes = [];
      
      for (let i = minId; i <= maxId; i++) {
        if (!idsExistentes.includes(i)) {
          faltantes.push(i);
        }
      }
      
      if (faltantes.length === 0) {
        alert(`‚úÖ No hay preguntas faltantes\n\nRango: ${minId} - ${maxId}\nTotal: ${idsExistentes.length} preguntas`);
        return;
      }
      
      mostrarModalFaltantes(faltantes, minId, maxId, idsExistentes.length);
    }
    
    function mostrarModalFaltantes(faltantes, minId, maxId, total) {
      const modal = document.getElementById('modalFaltantes');
      const contenido = document.getElementById('faltantesContenido');
      
      let html = `
        <div style="margin-bottom: 20px; padding: 15px; background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 8px;">
          <div style="color: #ffc107; font-weight: 600; font-size: 16px;">‚ö†Ô∏è Se encontraron ${faltantes.length} preguntas faltantes</div>
          <div style="color: #aab3b8; font-size: 14px; margin-top: 5px;">Rango: ${minId} - ${maxId} | Total preguntas: ${total}</div>
        </div>
        
        <div style="background: #26292d; border-radius: 8px; padding: 20px; border: 1px solid rgba(255,255,255,0.1);">
          <div style="color: #34c3ff; font-weight: 600; margin-bottom: 15px;">IDs Faltantes:</div>
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px;">
      `;
      
      faltantes.forEach(id => {
        html += `
          <div style="background: rgba(255, 193, 7, 0.2); padding: 10px; border-radius: 4px; text-align: center; color: #ffc107; font-weight: 600;">
            #${id}
          </div>
        `;
      });
      
      html += `
          </div>
        </div>
      `;
      
      contenido.innerHTML = html;
      modal.classList.add('show');
    }
    
    function cerrarModalDuplicados() {
      document.getElementById('modalDuplicados').classList.remove('show');
    }
    
    function cerrarModalFaltantes() {
      document.getElementById('modalFaltantes').classList.remove('show');
    }
    
    async function toggleActivaPregunta(index) {
      const pregunta = preguntasCargadas[index];
      const nuevoEstado = pregunta.activa === false;
      
      try {
        await db.collection('preguntas').doc(pregunta.docId).update({
          activa: nuevoEstado,
          actualizadaEn: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        log('logPreg', `‚úÖ Pregunta #${pregunta.id} ${nuevoEstado ? 'activada' : 'desactivada'}`, 'success');
        
        await cargarPreguntasConsola();
        
      } catch (e) {
        log('logPreg', `‚ùå Error: ${e.message}`, 'error');
        alert('Error: ' + e.message);
      }
    }
    
    async function eliminarPregunta(index) {
      const pregunta = preguntasCargadas[index];
      
      if (!confirm(`¬øEliminar pregunta #${pregunta.id}?\n\n"${pregunta.pregunta?.substring(0, 100)}..."\n\nEsta acci√≥n no se puede deshacer.`)) return;
      
      try {
        await db.collection('preguntas').doc(pregunta.docId).delete();
        
        log('logPreg', `‚úÖ Pregunta #${pregunta.id} eliminada`, 'success');
        
        await cargarPreguntasConsola();
        await catSeleccionada();
        
      } catch (e) {
        log('logPreg', `‚ùå Error: ${e.message}`, 'error');
        alert('Error: ' + e.message);
      }
    }
    
    function nuevaPregunta() {
      if (!catActual) return alert('Selecciona una categor√≠a');
      
      document.getElementById('editIndex').value = '-1';
      document.getElementById('editId').value = '';
      document.getElementById('editPregunta').value = '';
      document.getElementById('editOpcionA').value = '';
      document.getElementById('editOpcionB').value = '';
      document.getElementById('editOpcionC').value = '';
      document.getElementById('editOpcionD').value = '';
      document.getElementById('editRespuesta').value = '0';
      document.getElementById('editActiva').checked = true;
      
      document.getElementById('modalEditPregunta').classList.add('show');
    }
    
    async function guardarNuevaPregunta() {
      const datos = {
        id: document.getElementById('editId').value,
        pregunta: document.getElementById('editPregunta').value,
        opciones: [
          document.getElementById('editOpcionA').value,
          document.getElementById('editOpcionB').value,
          document.getElementById('editOpcionC').value,
          document.getElementById('editOpcionD').value
        ],
        respuestaCorrecta: parseInt(document.getElementById('editRespuesta').value),
        activa: document.getElementById('editActiva').checked,
        categoria: catActual,
        creadaEn: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      try {
        await db.collection('preguntas').add(datos);
        
        log('logPreg', `‚úÖ Pregunta #${datos.id} creada`, 'success');
        alert('‚úÖ Pregunta creada exitosamente');
        
        cerrarModalEditPregunta();
        await cargarPreguntasConsola();
        await catSeleccionada();
        
      } catch (e) {
        log('logPreg', `‚ùå Error: ${e.message}`, 'error');
        alert('Error: ' + e.message);
      }
    }
    
    async function guardarPreguntaForm(e) {
      e.preventDefault();
      
      const index = parseInt(document.getElementById('editIndex').value);
      
      if (index === -1) {
        await guardarNuevaPregunta();
      } else {
        await guardarPreguntaEditada(e);
      }
    }
    
    function cerrarModalPreguntas() {
      document.getElementById('modalPreguntas').classList.remove('show');
    }
    
    function cerrarModalEditPregunta() {
      document.getElementById('modalEditPregunta').classList.remove('show');
    }
    
    function editarPregunta(index) {
      const pregunta = preguntasCargadas[index];
      
      let opciones = [];
      if (Array.isArray(pregunta.opciones)) {
        opciones = pregunta.opciones;
      } else if (pregunta.opciones && typeof pregunta.opciones === 'object') {
        opciones = Object.values(pregunta.opciones);
      }
      
      document.getElementById('editIndex').value = index;
      document.getElementById('editId').value = pregunta.id || '';
      document.getElementById('editPregunta').value = pregunta.pregunta || '';
      document.getElementById('editOpcionA').value = opciones[0] || '';
      document.getElementById('editOpcionB').value = opciones[1] || '';
      document.getElementById('editOpcionC').value = opciones[2] || '';
      document.getElementById('editOpcionD').value = opciones[3] || '';
      document.getElementById('editRespuesta').value = pregunta.respuestaCorrecta || 0;
      document.getElementById('editActiva').checked = pregunta.activa !== false;
      
      document.getElementById('modalEditPregunta').classList.add('show');
    }
    
    async function guardarPreguntaEditada(e) {
      e.preventDefault();
      
      const index = parseInt(document.getElementById('editIndex').value);
      const pregunta = preguntasCargadas[index];
      
      const datos = {
        id: document.getElementById('editId').value,
        pregunta: document.getElementById('editPregunta').value,
        opciones: [
          document.getElementById('editOpcionA').value,
          document.getElementById('editOpcionB').value,
          document.getElementById('editOpcionC').value,
          document.getElementById('editOpcionD').value
        ],
        respuestaCorrecta: parseInt(document.getElementById('editRespuesta').value),
        activa: document.getElementById('editActiva').checked,
        categoria: catActual,
        actualizadaEn: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      try {
        await db.collection('preguntas').doc(pregunta.docId).update(datos);
        
        log('logPreg', `‚úÖ Pregunta #${datos.id} actualizada`, 'success');
        alert('‚úÖ Pregunta actualizada exitosamente');
        
        cerrarModalEditPregunta();
        await cargarPreguntasConsola();
        
      } catch (e) {
        log('logPreg', `‚ùå Error: ${e.message}`, 'error');
        alert('Error: ' + e.message);
      }
    }
    
    function cargarJSON() {
      const file = document.getElementById('fileJSON').files[0];
      if (!file) return;
      
      document.getElementById('fileName').textContent = `üìÑ ${file.name}`;
      clearLog('logPreg');
      log('logPreg', `Cargando ${file.name}...`, 'info');
      
      const reader = new FileReader();
      reader.onload = e => {
        try {
          document.getElementById('jsonText').value = e.target.result;
          const pregs = JSON.parse(e.target.result);
          log('logPreg', `‚úÖ ${pregs.length} preguntas`, 'success');
        } catch (err) {
          log('logPreg', `‚ùå ${err.message}`, 'error');
        }
      };
      reader.readAsText(file);
    }
    
    function limpiarJSON() {
      document.getElementById('jsonText').value = '';
      document.getElementById('fileJSON').value = '';
      document.getElementById('fileName').textContent = '';
      clearLog('logPreg');
    }
    
    function validarJSON() {
      clearLog('logPreg');
      const texto = document.getElementById('jsonText').value.trim();
      if (!texto) return log('logPreg', '‚ö†Ô∏è Vac√≠o', 'warning');
      if (!catActual) return log('logPreg', '‚ö†Ô∏è Selecciona categor√≠a', 'warning');
      
      try {
        const pregs = JSON.parse(texto);
        if (!Array.isArray(pregs)) return log('logPreg', '‚ùå Debe ser array', 'error');
        log('logPreg', `‚úÖ ${pregs.length} preguntas`, 'success');
      } catch (e) {
        log('logPreg', `‚ùå ${e.message}`, 'error');
      }
    }
    
    async function subirPreguntas() {
      if (!catActual) return alert('Selecciona categor√≠a');
      
      clearLog('logPreg');
      const texto = document.getElementById('jsonText').value.trim();
      if (!texto) return log('logPreg', '‚ö†Ô∏è Vac√≠o', 'warning');
      
      try {
        const pregs = JSON.parse(texto);
        if (!Array.isArray(pregs)) return log('logPreg', '‚ùå Debe ser array', 'error');
        
        log('logPreg', `Procesando ${pregs.length}...`, 'info');
        
        let ok = 0, err = 0;
        for (const p of pregs) {
          try {
            await db.collection('preguntas').add({
              id: p.id,
              pregunta: p.pregunta,
              opciones: p.opciones,
              respuestaCorrecta: p.respuestaCorrecta,
              categoria: catActual,
              activa: p.activa !== false,
              creadaEn: firebase.firestore.FieldValue.serverTimestamp()
            });
            ok++;
            if (ok % 25 === 0) log('logPreg', `${ok}...`, 'info');
          } catch (e) {
            err++;
          }
        }
        
        log('logPreg', `‚úÖ ${ok} exitosas, ${err} errores`, 'success');
        
        await db.collection('categorias').doc(catActual).update({
          totalPreguntas: pregs.length,
          actualizadaEn: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        await catSeleccionada();
        await actualizarStats(true);
      } catch (e) {
        log('logPreg', `‚ùå ${e.message}`, 'error');
      }
    }
    
    async function exportarPreguntas() {
      if (!catActual) return;
      
      clearLog('logPreg');
      log('logPreg', 'Exportando...', 'info');
      
      try {
        const snap = await db.collection('preguntas').where('categoria', '==', catActual).get();
        const preguntas = [];
        
        snap.forEach(doc => {
          const d = doc.data();
          preguntas.push({
            id: d.id,
            pregunta: d.pregunta,
            opciones: d.opciones,
            respuestaCorrecta: d.respuestaCorrecta,
            activa: d.activa
          });
        });
        
        const json = JSON.stringify(preguntas, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${catActual}-preguntas.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        log('logPreg', `‚úÖ ${preguntas.length} exportadas`, 'success');
      } catch (e) {
        log('logPreg', `‚ùå ${e.message}`, 'error');
      }
    }
    
    async function borrarPreguntas() {
      if (!catActual) return;
      if (!confirm('¬øBorrar TODAS las preguntas?')) return;
      
      clearLog('logPreg');
      log('logPreg', 'Borrando...', 'warning');
      
      try {
        const snap = await db.collection('preguntas').where('categoria', '==', catActual).get();
        let borradas = 0;
        for (const doc of snap.docs) {
          await doc.ref.delete();
          borradas++;
        }
        
        log('logPreg', `‚úÖ ${borradas} borradas`, 'success');
        await catSeleccionada();
        await actualizarStats(true);
      } catch (e) {
        log('logPreg', `‚ùå ${e.message}`, 'error');
      }
    }
    
    // ‚úÖ GESTI√ìN DE USUARIOS OPTIMIZADA
    async function actualizarStatsUsers(forzar = false) {
      // Si hay cach√© v√°lido y no se fuerza, usar cach√©
      if (!forzar && esCacheValido('usuarios')) {
        mostrarStatsDesdeCache('usuarios');
        return;
      }
      
      log('logUsers', 'Actualizando estad√≠sticas...', 'info');
      
      try {
        // ‚úÖ SOLO CARGAR USUARIOS Y SUSCRIPCIONES
        const [uSnap, sSnap] = await Promise.all([
          db.collection('usuarios').get(),
          db.collection('suscripciones').get()
        ]);
        
        let totalSubs = 0, totalgratuito = 0, totalMensual = 0, totalTrimestral = 0, totalAnual = 0;
        
        sSnap.forEach(doc => {
          const d = doc.data();
          
          Object.entries(d).forEach(([k, v]) => {
            if (k !== 'email' && v && typeof v === 'object' && v.plan) {
              totalSubs++;
              
              switch(v.plan) {
                case 'gratuito': totalgratuito++; break;
                case 'mensual': totalMensual++; break;
                case 'trimestral': totalTrimestral++; break;
                case 'anual': totalAnual++; break;
              }
            }
          });
        });
        
        // Guardar en cach√©
        const data = {
          totalUsers: uSnap.size,
          totalSubs,
          totalgratuito,
          totalMensual,
          totalTrimestral,
          totalAnual
        };
        guardarEnCache('usuarios', data);
        
        // Mostrar
        document.getElementById('totalUsers').textContent = uSnap.size;
        document.getElementById('totalSubs').textContent = totalSubs;
        document.getElementById('totalgratuito').textContent = totalgratuito;
        document.getElementById('totalMensual').textContent = totalMensual;
        document.getElementById('totalTrimestral').textContent = totalTrimestral;
        document.getElementById('totalAnual').textContent = totalAnual;
        
        mostrarIndicadorCache('cacheIndicatorUsers', false);
        log('logUsers', `‚úÖ ${uSnap.size} usuarios | ${totalSubs} suscripciones`, 'success');
        
      } catch (e) {
        console.error('Error:', e);
        log('logUsers', `‚ùå ${e.message}`, 'error');
      }
    }
    
    async function verUsuarios() {
      console.log('üîç Iniciando verUsuarios');
      try {
        const [usersSnap, subsSnap] = await Promise.all([
          db.collection('usuarios').get(),
          db.collection('suscripciones').get()
        ]);
        
        if (usersSnap.empty) {
          alert('No hay usuarios registrados');
          return;
        }
        
        const suscripciones = {};
        subsSnap.forEach(doc => {
          suscripciones[doc.id] = doc.data();
        });
        
        let html = '';
        
        usersSnap.forEach(doc => {
          const user = doc.data();
          const userId = doc.id;
          const email = user.email || 'Sin email';
          const displayName = user.displayName || 'Sin nombre';
          const bloqueado = user.bloqueado === true;
          const fechaRegistro = user.fechaRegistro ? 
            new Date(user.fechaRegistro.toDate()).toLocaleDateString('es-ES') : 
            'Desconocida';
          
          let subs = '';
          const userSubs = suscripciones[userId];
          
          if (userSubs) {
  Object.entries(userSubs).forEach(([k, v]) => {
    if (k !== 'email' && v && v.plan) {
      const planIcon = v.plan === 'gratuito' ? 'üéÅ' : 
                     v.plan === 'mensual' ? 'üìÖ' : 
                     v.plan === 'trimestral' ? 'üî•' : 'üëë';
      const desuscrito = v.desuscrito === true ? '<span class="badge oculta">üö´ Desuscrito</span>' : '';
      const btnDesuscribir = v.desuscrito !== true ? 
        `<button onclick="desuscribirCategoria('${userId}', '${email}', '${k}', '${(v.nombre || k).replace(/'/g, "\\'")}', event)" class="btn-small danger" style="margin-left: 8px;" title="Desuscribir de esta categor√≠a">‚ùå</button>` : 
        `<button onclick="resuscribirCategoria('${userId}', '${email}', '${k}', '${(v.nombre || k).replace(/'/g, "\\'")}', event)" class="btn-small success" style="margin-left: 8px;" title="Reactivar suscripci√≥n">‚úÖ</button>`;
      subs += `<div style="margin-top:8px; display: flex; align-items: center; justify-content: space-between; padding: 5px; background: rgba(255,255,255,0.05); border-radius: 4px;">
        <div>${v.nombre || k} <span class="badge ${v.plan}">${planIcon} ${v.plan}</span> ${desuscrito}</div>
        ${btnDesuscribir}
      </div>`;
    }
  });
}
          
          if (!subs) {
            subs = '<div style="margin-top:5px; color: #aab3b8; font-size: 12px;">Sin suscripciones</div>';
          }
          
          const bloqueadoBadge = bloqueado ? '<span class="badge bloqueado">üö´ Bloqueado</span>' : '';
          
          html += `
            <div class="list-item ${bloqueado ? 'bloqueado' : ''}">
              <div class="info">
                <div class="nombre">${email} ${bloqueadoBadge}</div>
                <div class="detalles" style="font-size: 13px; color: #aab3b8;">
                  <div>üë§ ${displayName}</div>
                  <div>üÜî ${userId}</div>
                  <div>üìÖ Registro: ${fechaRegistro}</div>
                  ${subs}
                </div>
              </div>
              <div class="acciones">
                <button onclick="otorgarAccesoDirecto('${userId}', '${email}')" class="btn-small premium" title="Otorgar acceso">
                  üëë
                </button>
                ${!bloqueado ? `
                  <button onclick="bloquearUsuario('${userId}', '${email}')" class="btn-small danger" title="Bloquear">
                    üö´
                  </button>
                ` : `
                  <button onclick="desbloquearUsuario('${userId}', '${email}')" class="btn-small success" title="Desbloquear">
                    ‚úÖ
                  </button>
                `}
                <button onclick="desuscribirTodasCategorias('${userId}', '${email}')" class="btn-small warning" title="Desuscribir de TODAS las categor√≠as">
  ‚ö†Ô∏è TODAS
</button>
                <button onclick="eliminarUsuario('${userId}', '${email}')" class="btn-small danger" title="Eliminar">
                  üóëÔ∏è
                </button>
              </div>
            </div>
          `;
        });
        
        document.getElementById('listUsers').innerHTML = html;
        document.getElementById('modalUsers').classList.add('show');
        
      } catch (e) {
        console.error('Error:', e);
        alert('Error: ' + e.message);
      }
    }
    
    async function bloquearUsuario(userId, email) {
      if (!confirm(`¬øBloquear a ${email}?\n\nEl usuario no podr√° acceder al sistema hasta que lo desbloquees.`)) return;
      
      try {
        await db.collection('usuarios').doc(userId).update({
          bloqueado: true,
          fechaBloqueo: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        log('logUsers', `‚úÖ Usuario ${email} bloqueado`, 'success');
        alert(`‚úÖ Usuario ${email} bloqueado exitosamente`);
        verUsuarios();
      } catch (e) {
        log('logUsers', `‚ùå Error: ${e.message}`, 'error');
        alert('Error: ' + e.message);
      }
    }
    
    async function desbloquearUsuario(userId, email) {
      if (!confirm(`¬øDesbloquear a ${email}?`)) return;
      
      try {
        await db.collection('usuarios').doc(userId).update({
          bloqueado: false,
          fechaDesbloqueo: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        log('logUsers', `‚úÖ Usuario ${email} desbloqueado`, 'success');
        alert(`‚úÖ Usuario ${email} desbloqueado exitosamente`);
        verUsuarios();
      } catch (e) {
        log('logUsers', `‚ùå Error: ${e.message}`, 'error');
        alert('Error: ' + e.message);
      }
    }
    
    async function desuscribirTodasCategorias(userId, email) {
      if (!confirm(`¬øDesuscribir a ${email}?\n\nSus planes seguir√°n activos hasta que venzan, pero no podr√° renovarlos.`)) return;
      
      try {
        const subsDoc = await db.collection('suscripciones').doc(userId).get();
        if (!subsDoc.exists) return alert('No tiene suscripciones');
        
        const data = subsDoc.data();
        const updates = {};
        
        Object.entries(data).forEach(([k, v]) => {
          if (k !== 'email' && v && v.plan) {
            updates[`${k}.desuscrito`] = true;
            updates[`${k}.fechaDesuscripcion`] = Date.now();
          }
        });
        
        await db.collection('suscripciones').doc(userId).update(updates);
        
        log('logUsers', `‚úÖ Usuario ${email} desuscrito`, 'success');
        alert(`‚úÖ ${email} desuscrito exitosamente\n\nSus planes seguir√°n activos hasta que venzan.`);
        verUsuarios();
      } catch (e) {
        log('logUsers', `‚ùå Error: ${e.message}`, 'error');
        alert('Error: ' + e.message);
      }
    }
    // ‚úÖ DESUSCRIBIR CATEGOR√çA INDIVIDUAL
async function desuscribirCategoria(userId, email, categoriaId, categoriaNombre, event) {
  event.stopPropagation(); // Evitar que se cierre el modal
  
  if (!confirm(`¬øDesuscribir a ${email} de "${categoriaNombre}"?\n\nEl plan seguir√° activo hasta que venza, pero no podr√° renovarlo.`)) return;
  
  try {
    await db.collection('suscripciones').doc(userId).update({
      [`${categoriaId}.desuscrito`]: true,
      [`${categoriaId}.fechaDesuscripcion`]: Date.now()
    });
    
    log('logUsers', `‚úÖ ${email} desuscrito de ${categoriaNombre}`, 'success');
    alert(`‚úÖ ${email} desuscrito de "${categoriaNombre}"\n\nEl plan seguir√° activo hasta que venza.`);
    verUsuarios();
  } catch (e) {
    log('logUsers', `‚ùå Error: ${e.message}`, 'error');
    alert('Error: ' + e.message);
  }
}

// ‚úÖ REACTIVAR SUSCRIPCI√ìN DE CATEGOR√çA
async function resuscribirCategoria(userId, email, categoriaId, categoriaNombre, event) {
  event.stopPropagation(); // Evitar que se cierre el modal
  
  if (!confirm(`¬øReactivar suscripci√≥n de ${email} a "${categoriaNombre}"?\n\nPodr√° volver a renovar cuando su plan venza.`)) return;
  
  try {
    await db.collection('suscripciones').doc(userId).update({
      [`${categoriaId}.desuscrito`]: false,
      [`${categoriaId}.fechaReactivacion`]: Date.now()
    });
    
    log('logUsers', `‚úÖ Suscripci√≥n de ${email} a ${categoriaNombre} reactivada`, 'success');
    alert(`‚úÖ Suscripci√≥n de ${email} a "${categoriaNombre}" reactivada`);
    verUsuarios();
  } catch (e) {
    log('logUsers', `‚ùå Error: ${e.message}`, 'error');
    alert('Error: ' + e.message);
  }
}
    async function eliminarUsuario(userId, email) {
      const confirmText = `‚ö†Ô∏è ELIMINAR USUARIO
      
Usuario: ${email}

Esto eliminar√°:
‚úó Datos del usuario
‚úó Todas sus suscripciones
‚úó Todos sus resultados
‚úó Todo su progreso

Esta acci√≥n NO se puede deshacer.

¬øEst√°s SEGURO?`;
      
      if (!confirm(confirmText)) return;
      
      if (!confirm(`√öLTIMA CONFIRMACI√ìN\n\n¬øEliminar definitivamente a ${email}?`)) return;
      
      try {
        log('logUsers', `Eliminando usuario ${email}...`, 'warning');
        
        await db.collection('usuarios').doc(userId).delete();
        log('logUsers', '‚úì Datos de usuario eliminados', 'info');
        
        await db.collection('suscripciones').doc(userId).delete();
        log('logUsers', '‚úì Suscripciones eliminadas', 'info');
        
        const resSnap = await db.collection('resultados').where('userId', '==', userId).get();
        for (const doc of resSnap.docs) {
          await doc.ref.delete();
        }
        log('logUsers', `‚úì ${resSnap.size} resultados eliminados`, 'info');
        
        const progSnap = await db.collection('progresos').where('userId', '==', userId).get();
        for (const doc of progSnap.docs) {
          await doc.ref.delete();
        }
        log('logUsers', `‚úì ${progSnap.size} progresos eliminados`, 'info');
        
        await db.collection('aciertosglobales').doc(userId).delete();
        log('logUsers', '‚úì Aciertos globales eliminados', 'info');
        
        log('logUsers', `‚úÖ Usuario ${email} eliminado completamente`, 'success');
        alert(`‚úÖ Usuario ${email} eliminado exitosamente`);
        
        cerrarModalUsers();
        await actualizarStatsUsers(true);
      } catch (e) {
        log('logUsers', `‚ùå Error: ${e.message}`, 'error');
        alert('Error: ' + e.message);
      }
    }
    
    function otorgarAccesoDirecto(userId, email) {
      cerrarModalUsers();
      document.getElementById('emailAcceso').value = email;
      document.getElementById('emailAcceso').disabled = true;
      document.getElementById('catAcceso').value = '';
      document.getElementById('planAcceso').value = 'gratuito';
      document.getElementById('modalAcceso').classList.add('show');
      
      window._tempUserId = userId;
    }
    
    function otorgarAcceso() {
      document.getElementById('emailAcceso').value = '';
      document.getElementById('emailAcceso').disabled = false;
      document.getElementById('catAcceso').value = '';
      document.getElementById('planAcceso').value = 'gratuito';
      document.getElementById('modalAcceso').classList.add('show');
      window._tempUserId = null;
    }
    
    async function procesarAcceso(e) {
      e.preventDefault();
      
      const email = document.getElementById('emailAcceso').value.trim();
      const cat = document.getElementById('catAcceso').value;
      const plan = document.getElementById('planAcceso').value;
      
      log('logUsers', `Procesando acceso para ${email}...`, 'info');
      
      try {
        const uSnap = await db.collection('usuarios').where('email', '==', email).limit(1).get();
        
        let userId;
        if (window._tempUserId) {
          userId = window._tempUserId;
          window._tempUserId = null;
          log('logUsers', `Usando usuario existente: ${userId}`, 'info');
        } else if (uSnap.empty) {
          log('logUsers', `Usuario no encontrado. Creando nuevo usuario...`, 'warning');
          
          userId = email.replace(/[^a-zA-Z0-9]/g, '_') + '_' + Date.now();
          
          await db.collection('usuarios').doc(userId).set({
            email: email,
            displayName: email.split('@')[0],
            fechaRegistro: firebase.firestore.FieldValue.serverTimestamp(),
            ultimoAcceso: firebase.firestore.FieldValue.serverTimestamp(),
            creadoPorAdmin: true
          });
          
          log('logUsers', `‚úÖ Usuario creado con ID: ${userId}`, 'success');
        } else {
          userId = uSnap.docs[0].id;
          log('logUsers', `Usuario encontrado: ${userId}`, 'info');
        }
        
        const catDoc = await db.collection('categorias').doc(cat).get();
        const catNom = catDoc.exists ? catDoc.data().nombre : cat;
        
        await db.collection('suscripciones').doc(userId).set({
          email: email,
          [cat]: {
            plan: plan,
            tandasUsadas: 0,
            fechaActivacion: Date.now(),
            nombre: catNom
          }
        }, { merge: true });
        
        log('logUsers', `‚úÖ Acceso otorgado: ${plan} para ${catNom}`, 'success');
        
        alert(`‚úÖ Acceso otorgado exitosamente\n\nEmail: ${email}\nTest: ${catNom}\nPlan: ${plan}\n${uSnap.empty ? '\n‚ö†Ô∏è Usuario creado autom√°ticamente' : ''}`);
        
        cerrarModalAcceso();
        await actualizarStatsUsers(true);
        
      } catch (e) {
        log('logUsers', `‚ùå ${e.message}`, 'error');
        alert('Error: ' + e.message);
      }
    }
    
    // ‚úÖ STATS OPTIMIZADAS
    async function actualizarStats(forzar = false) {
      // Si hay cach√© v√°lido y no se fuerza, usar cach√©
      if (!forzar && esCacheValido('stats')) {
        mostrarStatsDesdeCache('stats');
        return;
      }
      
      try {
        const [cSnap, pSnap, rSnap, proSnap] = await Promise.all([
          db.collection('categorias').get(),
          db.collection('preguntas').get(),
          db.collection('resultados').get(),
          db.collection('progresos').get()
        ]);
        
        // Guardar en cach√©
        const data = {
          sCat: cSnap.size,
          sPreg: pSnap.size,
          sRes: rSnap.size,
          sProg: proSnap.size
        };
        guardarEnCache('stats', data);
        
        document.getElementById('catCount').textContent = cSnap.size;
        document.getElementById('sCat').textContent = cSnap.size;
        document.getElementById('sPreg').textContent = pSnap.size;
        document.getElementById('sRes').textContent = rSnap.size;
        document.getElementById('sProg').textContent = proSnap.size;
        
        mostrarIndicadorCache('cacheIndicatorStats', false);
        
        clearLog('logStats');
        log('logStats', `üìö ${cSnap.size} categor√≠as`, 'info');
        log('logStats', `‚ùì ${pSnap.size} preguntas`, 'info');
        log('logStats', `üìä ${rSnap.size} resultados`, 'info');
        log('logStats', `üíæ ${proSnap.size} progresos`, 'info');
      } catch (e) {
        console.error('Error:', e);
      }
    }
    
    async function hacerBackupCompleto() {
      clearLog('logStats');
      log('logStats', 'üíæ Iniciando backup completo...', 'info');
      
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
      const backup = {
        fecha: new Date().toISOString(),
        version: '1.0',
        datos: {}
      };
      
      try {
        log('logStats', 'üìö Exportando categor√≠as...', 'info');
        const catSnap = await db.collection('categorias').get();
        backup.datos.categorias = {};
        catSnap.forEach(doc => {
          backup.datos.categorias[doc.id] = doc.data();
        });
        log('logStats', `‚úì ${Object.keys(backup.datos.categorias).length} categor√≠as`, 'success');
        
        log('logStats', '‚ùì Exportando preguntas...', 'info');
        const pregSnap = await db.collection('preguntas').get();
        backup.datos.preguntas = [];
        pregSnap.forEach(doc => {
          backup.datos.preguntas.push({id: doc.id, ...doc.data()});
        });
        log('logStats', `‚úì ${backup.datos.preguntas.length} preguntas`, 'success');
        
        log('logStats', 'üë• Exportando usuarios...', 'info');
        const userSnap = await db.collection('usuarios').get();
        backup.datos.usuarios = {};
        userSnap.forEach(doc => {
          backup.datos.usuarios[doc.id] = doc.data();
        });
        log('logStats', `‚úì ${Object.keys(backup.datos.usuarios).length} usuarios`, 'success');
        
        log('logStats', 'üëë Exportando suscripciones...', 'info');
        const susSnap = await db.collection('suscripciones').get();
        backup.datos.suscripciones = {};
        susSnap.forEach(doc => {
          backup.datos.suscripciones[doc.id] = doc.data();
        });
        log('logStats', `‚úì ${Object.keys(backup.datos.suscripciones).length} suscripciones`, 'success');
        
        log('logStats', 'üìä Exportando resultados...', 'info');
        const resSnap = await db.collection('resultados').get();
        backup.datos.resultados = [];
        resSnap.forEach(doc => {
          backup.datos.resultados.push({id: doc.id, ...doc.data()});
        });
        log('logStats', `‚úì ${backup.datos.resultados.length} resultados`, 'success');
        
        log('logStats', 'üíæ Exportando progresos...', 'info');
        const progSnap = await db.collection('progresos').get();
        backup.datos.progresos = [];
        progSnap.forEach(doc => {
          backup.datos.progresos.push({id: doc.id, ...doc.data()});
        });
        log('logStats', `‚úì ${backup.datos.progresos.length} progresos`, 'success');
        
        log('logStats', 'üéØ Exportando aciertos globales...', 'info');
        const aciertosSnap = await db.collection('aciertosglobales').get();
        backup.datos.aciertosglobales = {};
        aciertosSnap.forEach(doc => {
          backup.datos.aciertosglobales[doc.id] = doc.data();
        });
        log('logStats', `‚úì ${Object.keys(backup.datos.aciertosglobales).length} registros`, 'success');
        
        const json = JSON.stringify(backup, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `multitest-backup-${timestamp}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        log('logStats', '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'info');
        log('logStats', '‚úÖ BACKUP COMPLETADO', 'success');
        log('logStats', `üì¶ Archivo: multitest-backup-${timestamp}.json`, 'info');
        log('logStats', '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'info');
        
        alert(`‚úÖ Backup completado exitosamente\n\nüì¶ Archivo descargado:\nmultitest-backup-${timestamp}.json\n\nGu√°rdalo en un lugar seguro.`);
        
      } catch (e) {
        log('logStats', `‚ùå Error: ${e.message}`, 'error');
        alert('‚ùå Error al crear backup: ' + e.message);
      }
    }
    
    async function restaurarBackup() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        if (!confirm('‚ö†Ô∏è ¬øRESTAURAR? Puede sobrescribir datos.')) return;
        
        clearLog('logStats');
        log('logStats', 'üì• Restaurando...', 'info');
        
        const reader = new FileReader();
        reader.onload = async (event) => {
          try {
            const backup = JSON.parse(event.target.result);
            
            if (!backup.datos) throw new Error('Formato inv√°lido');
            
            if (backup.datos.categorias) {
              log('logStats', 'Restaurando categor√≠as...', 'info');
              for (const [id, data] of Object.entries(backup.datos.categorias)) {
                await db.collection('categorias').doc(id).set(data, { merge: true });
              }
            }
            
            if (backup.datos.suscripciones) {
              log('logStats', 'Restaurando suscripciones...', 'info');
              for (const [id, data] of Object.entries(backup.datos.suscripciones)) {
                await db.collection('suscripciones').doc(id).set(data, { merge: true });
              }
            }
            
            log('logStats', '‚úÖ Restaurado', 'success');
            await actualizarStats(true);
            
          } catch (e) {
            log('logStats', `‚ùå ${e.message}`, 'error');
          }
        };
        reader.readAsText(file);
      };
      
      input.click();
    }
    
    function cerrarModalCat() { document.getElementById('modalCat').classList.remove('show'); }
    function cerrarModalListCat() { document.getElementById('modalListCat').classList.remove('show'); }
    function cerrarModalReordenar() { 
      document.getElementById('modalReordenar').classList.remove('show'); 
      cargarCatSelect();
      actualizarStatsCategorias();
    }
    function cerrarModalEstatus() { document.getElementById('modalEstatus').classList.remove('show'); }
    function cerrarModalUsers() { document.getElementById('modalUsers').classList.remove('show'); }
    function cerrarModalAcceso() { 
      document.getElementById('modalAcceso').classList.remove('show'); 
      document.getElementById('emailAcceso').disabled = false;
      window._tempUserId = null;
    }
    
    function instruccionesBackupLocal() {
      const instrucciones = `
üöÄ BACKUP COMPLETO DEL SISTEMA
Para hacer un backup completo (Firestore + c√≥digo):
1Ô∏è‚É£ Abre tu terminal/CMD en la carpeta del proyecto
2Ô∏è‚É£ Ejecuta:
   npm run backup
3Ô∏è‚É£ El backup se guardar√° en:
   C:/Backup-Multitest/backup-YYYY-MM-DD-TIMESTAMP/
üì¶ Incluye:
   ‚úÖ Todas las colecciones de Firestore
   ‚úÖ index.html y admin.html
   ‚úÖ Reglas de seguridad
   ‚úÖ Configuraci√≥n del proyecto
   ‚úÖ Functions (si existen)
‚ö†Ô∏è  Necesitas tener instalado:
   ‚Ä¢ Node.js
   ‚Ä¢ firebase-admin (npm install)
   ‚Ä¢ serviceAccountKey.json
¬øQuieres hacer un backup solo de Firestore desde aqu√≠?
`;
      if (confirm(instrucciones)) {
        hacerBackupCompleto();
      }
    }
    
    window.onclick = e => {
      if (e.target.classList.contains('modal')) {
        e.target.classList.remove('show');
      }
    };
  </script>
</body>
</html>
